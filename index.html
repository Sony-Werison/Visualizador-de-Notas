<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif; --font-serif: 'Lora', serif; --font-mono: 'Roboto Mono', monospace;
        }
        body { font-family: var(--font-sans); touch-action: pan-y; background-color: #111827; }
        .font-sans { font-family: var(--font-sans); }
        .font-serif { font-family: var(--font-serif); }
        .font-mono { font-family: var(--font-mono); }
        .slide-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .settings-panel { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        .settings-panel.open { transform: translateX(0); }
        #slides-container::-webkit-scrollbar { width: 8px; }
        #slides-container::-webkit-scrollbar-track { background: transparent; }
        #slides-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        .control-btn-group button.active { background-color: #3b82f6; color: white; }
        .fade-out { animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
        .notion-quote { border-left: 3px solid #34d399; padding-left: 1.5rem; }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center min-h-screen">

    <div id="app" class="w-full h-screen flex flex-col">
        <!-- Tela de Configuração Inicial -->
        <div id="setup-view" class="w-full max-w-xl mx-auto my-auto bg-gray-800 p-8 rounded-xl shadow-lg space-y-6">
            <h1 class="text-3xl font-bold text-white text-center">Visualizador de Notas do Notion</h1>
            <input type="text" id="pageId" placeholder="Cole a URL da sua página aqui" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition text-white">
            <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Visualizar</button>
            <div id="error-message" class="text-red-500 text-center font-medium hidden"></div>
        </div>

        <!-- Tela de Apresentação -->
        <div id="presentation-view" class="hidden w-full h-full flex flex-col relative overflow-hidden">
            <header class="w-full p-4 flex justify-between items-center absolute top-0 left-0 z-20 bg-gradient-to-b from-black/60 to-transparent">
                <h1 id="page-title" class="text-sm font-semibold text-white truncate max-w-xs md:max-w-md"></h1>
                <div class="flex items-center gap-4">
                    <div id="main-timer-controls" class="flex items-center gap-2 p-1 bg-gray-900/50 rounded-lg">
                        <button id="timer-play-pause-btn" title="Iniciar/Pausar Tempo" class="p-1.5"></button>
                        <span id="overall-timer" class="text-lg font-mono text-white" title="Tempo total da sessão">0:00</span>
                    </div>
                    <button id="settings-toggle-btn" title="Ajustes" class="p-2 rounded-lg hover:bg-gray-700/50 transition"></button>
                </div>
            </header>

            <main id="slides-container" class="w-full h-full flex-1 flex flex-col items-center justify-center overflow-y-auto px-8 py-24 transition-all duration-300"></main>
            
            <div id="floating-play-btn-container" class="absolute inset-0 flex items-center justify-center z-10 hidden">
                <button id="floating-play-btn" class="p-4 bg-gray-900/50 rounded-full text-white"></button>
            </div>

            <footer id="footer-bar" class="w-full p-4 flex justify-between items-center absolute bottom-0 left-0 z-20 bg-gradient-to-t from-black/60 to-transparent">
                 <button id="prev-btn" title="Anterior" class="p-3 rounded-full hover:bg-gray-700/50 disabled:opacity-20 transition"></button>
                 <div id="footer-info" class="text-sm font-mono text-center"></div>
                 <button id="next-btn" title="Próximo" class="p-3 rounded-full hover:bg-gray-700/50 disabled:opacity-20 transition"></button>
            </footer>

            <aside id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-80 bg-gray-800/95 backdrop-blur-sm shadow-2xl z-30 flex flex-col">
                <div class="p-4 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-lg">Ajustes</h3>
                    <button id="close-settings-btn" title="Fechar" class="p-2"></button>
                </div>
                <div class="flex-1 p-6 space-y-6 overflow-y-auto">
                    <!-- Controles de Ajustes -->
                    <div>
                        <h4 class="font-semibold mb-2">Modo de Exibição</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="displayMode" data-value="slides" class="flex-1 px-2 py-1 rounded">Páginas</button>
                            <button data-setting="displayMode" data-value="scroll" class="flex-1 px-2 py-1 rounded">Rolagem</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Fonte</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="fontFamily" data-value="font-sans" class="flex-1 px-2 py-1 rounded">Sans</button>
                            <button data-setting="fontFamily" data-value="font-serif" class="flex-1 px-2 py-1 rounded">Serif</button>
                            <button data-setting="fontFamily" data-value="font-mono" class="flex-1 px-2 py-1 rounded">Mono</button>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Tamanho da Fonte</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                             <button data-setting="fontSize" data-value="-2" class="flex-1 rounded">P</button>
                             <button data-setting="fontSize" data-value="-1" class="flex-1 rounded">M</button>
                             <button data-setting="fontSize" data-value="0" class="flex-1 rounded">G</button>
                             <button data-setting="fontSize" data-value="1" class="flex-1 rounded">XG</button>
                             <button data-setting="fontSize" data-value="2" class="flex-1 rounded">2XG</button>
                        </div>
                    </div>
                    <div id="teleprompter-controls" class="pt-4 border-t border-gray-700">
                        <h4 class="font-semibold mb-2">Teleprompter</h4>
                        <div class="flex items-center justify-between">
                             <button id="wpm-decrease" class="px-3 py-1 bg-gray-700 rounded transition">-</button>
                             <span id="wpm-display" class="font-mono text-center">180 PPM</span>
                             <button id="wpm-increase" class="px-3 py-1 bg-gray-700 rounded transition">+</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <div id="loading-view" class="hidden my-auto"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mx-auto"></div></div>
    </div>

    <script id="main-script">
        // --- Ícones SVG ---
        const ICONS = {
            play: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`,
            pause: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`,
            settings: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            close: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            arrowLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>`,
            arrowRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>`,
        };

        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- Seletores de Elementos ---
        const setupView = $('#setup-view'), presentationView = $('#presentation-view'), loadingView = $('#loading-view');
        const pageIdInput = $('#pageId'), generateBtn = $('#generate-btn'), errorMessage = $('#error-message');
        const slidesContainer = $('#slides-container'), pageTitle = $('#page-title');
        const timerPlayPauseBtn = $('#timer-play-pause-btn'), overallTimerEl = $('#overall-timer');
        const footerBar = $('#footer-bar'), prevBtn = $('#prev-btn'), nextBtn = $('#next-btn'), footerInfo = $('#footer-info');
        const settingsPanel = $('#settings-panel'), settingsToggleBtn = $('#settings-toggle-btn'), closeSettingsBtn = $('#close-settings-btn');
        const teleprompterControls = $('#teleprompter-controls'), wpmDecreaseBtn = $('#wpm-decrease'), wpmIncreaseBtn = $('#wpm-increase'), wpmDisplay = $('#wpm-display');
        const floatingPlayBtnContainer = $('#floating-play-btn-container'), floatingPlayBtn = $('#floating-play-btn');

        // --- Estado da Aplicação ---
        let state = {
            slides: [], rawBlocks: [], pageTitle: '', currentSlide: 0,
            overallTimerInterval: null, overallSeconds: 0, isTimerPlaying: false,
            slideTimerInterval: null, slideSeconds: 0,
            isSettingsOpen: false,
            isTeleprompterPlaying: false, animationFrameId: null,
            totalWords: 0, totalReadingMinutes: 0,
            settings: { displayMode: 'scroll', fontFamily: 'font-sans', fontSize: 0, wpm: 180 }
        };

        // --- LÓGICA DE CONFIGURAÇÕES (SETTINGS) ---
        function loadSettings() {
            const saved = localStorage.getItem('notionViewerSettings');
            if (saved) state.settings = { ...state.settings, ...JSON.parse(saved) };
        }
        function saveSettings() { localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings)); }
        function applySettings() {
            const contentWrapper = $('.slide-content');
            if (!contentWrapper) return;
            contentWrapper.className = `slide-content w-full h-full space-y-4 text-left ${state.settings.fontFamily}`;
            const baseSize = 1.125, scale = 0.125; // rem
            contentWrapper.style.fontSize = `${baseSize + (state.settings.fontSize * scale)}rem`;
            updateSettingsUI();
        }
        function updateSettingsUI() {
            for (const key in state.settings) {
                $$(`button[data-setting="${key}"]`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value == state.settings[key]);
                });
            }
            wpmDisplay.textContent = `${state.settings.wpm} PPM`;
        }
        function handleSettingChange(e) {
            const btn = e.target.closest('button[data-setting]');
            if (!btn) return;
            const { setting, value } = btn.dataset;
            state.settings[setting] = isNaN(value) ? value : parseInt(value);
            if (setting === 'displayMode') rebuildSlidesAndRender();
            else applySettings();
            saveSettings();
        }

        // --- LÓGICA PRINCIPAL (API, RENDERIZAÇÃO) ---
        function extractPageId(input) {
            try {
                if (input.startsWith('http')) {
                    const idFromEnd = new URL(input).pathname.split('-').pop();
                    if (idFromEnd && idFromEnd.length === 32) return idFromEnd;
                }
                return input.match(/[a-f0-9]{32}/)?.[0] || '';
            } catch { return ''; }
        }
        async function fetchNotionContent() {
            const pageId = extractPageId(pageIdInput.value.trim());
            if (!pageId) return showError("URL ou ID da Página inválido.");
            showView('loading');
            try {
                const res = await fetch(`/.netlify/functions/notion-proxy?pageId=${pageId}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `Erro ${res.status}`);
                const titleProp = data.page.properties.title || data.page.properties.Title;
                state.pageTitle = titleProp.title[0]?.plain_text || 'Sem Título';
                state.rawBlocks = data.blocks.results;
                rebuildSlidesAndRender();
                showView('presentation');
                resetAndPauseTimers();
            } catch (err) {
                showError(`Erro: ${err.message}. Verifique o ID e as permissões.`);
                showView('setup');
            }
        }
        function parseBlocksIntoSlides(blocks) {
            if (state.settings.displayMode === 'scroll') return [blocks];
            const slides = []; let currentSlide = [];
            blocks.forEach(block => {
                const isHeading = block.type === 'heading_1' || block.type === 'heading_2';
                if (isHeading && currentSlide.length > 0) {
                    slides.push(currentSlide);
                    currentSlide = [];
                }
                currentSlide.push(block);
            });
            if (currentSlide.length > 0) slides.push(currentSlide);
            return slides.length > 0 ? slides : [blocks]; // Garante que sempre haja pelo menos um slide
        }
        function rebuildSlidesAndRender() {
            state.slides = parseBlocksIntoSlides(state.rawBlocks);
            state.totalWords = state.rawBlocks.reduce((acc, block) => acc + countWordsInBlock(block), 0);
            state.totalReadingMinutes = Math.ceil(state.totalWords / state.settings.wpm);
            state.currentSlide = 0;
            renderCurrentSlide();
        }
        function renderCurrentSlide() {
            const slideData = state.slides[state.currentSlide];
            const slideWrapper = document.createElement('div');
            slideWrapper.className = 'slide-content w-full h-full space-y-4 text-left';
            slideData.forEach(block => {
                const el = createHtmlFromBlock(block);
                if (el) slideWrapper.appendChild(el);
            });
            slidesContainer.innerHTML = '';
            slidesContainer.appendChild(slideWrapper);
            pageTitle.textContent = state.pageTitle;
            applySettings();
            updateControlsAndFooter();
            resetSlideTimer();
        }
        function createHtmlFromBlock(block) {
            const type = block.type, content = block[type];
            if (!content) return null;
            const richText = content.rich_text?.map(t => t.plain_text).join('') || '';
            let el;
            switch(type) {
                case 'heading_1': el = document.createElement('h1'); el.className = 'text-4xl font-bold text-white'; el.textContent = richText; break;
                case 'heading_2': el = document.createElement('h2'); el.className = 'text-3xl font-semibold mt-8'; el.textContent = richText; break;
                case 'heading_3': el = document.createElement('h3'); el.className = 'text-2xl font-medium mt-6'; el.textContent = richText; break;
                case 'paragraph': el = document.createElement('p'); el.innerHTML = richText || '&nbsp;'; break;
                case 'quote': el = document.createElement('blockquote'); el.className = 'notion-quote italic text-gray-400'; el.textContent = richText; break;
                case 'image': el = document.createElement('img'); el.src = content.type === 'external' ? content.external.url : content.file.url; el.className = 'max-w-full h-auto rounded-lg my-6'; break;
                case 'divider': el = document.createElement('hr'); el.className = 'my-8 border-gray-700'; break;
                default: return null;
            }
            return el;
        }
        
        // --- CONTROLES E UI ---
        function updateControlsAndFooter() {
            const isScroll = state.settings.displayMode === 'scroll';
            footerBar.style.display = 'flex';
            prevBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            nextBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            teleprompterControls.style.display = isScroll ? 'block' : 'none';

            if (isScroll) {
                footerInfo.textContent = `Leitura total: ~${state.totalReadingMinutes} min`;
                floatingPlayBtnContainer.classList.remove('hidden');
            } else {
                footerInfo.innerHTML = `<span>Página ${state.currentSlide + 1}/${state.slides.length}</span> <span class="mx-2">|</span> <span id="slide-timer">0:00</span> <span class="mx-2">|</span> <span>Total: ~${state.totalReadingMinutes} min</span>`;
                prevBtn.disabled = state.currentSlide === 0;
                nextBtn.disabled = state.currentSlide >= state.slides.length - 1;
                floatingPlayBtnContainer.classList.add('hidden');
            }
        }
        function showView(view) {
            [setupView, presentationView, loadingView].forEach(v => v.classList.add('hidden'));
            if (view === 'setup') { setupView.classList.remove('hidden'); stopTimers(); }
            else if (view === 'presentation') presentationView.classList.remove('hidden');
            else if (view === 'loading') loadingView.classList.remove('hidden');
        }
        function showError(msg) { errorMessage.textContent = msg; errorMessage.classList.remove('hidden'); }
        function goToNextSlide() { if (state.currentSlide < state.slides.length - 1) { state.currentSlide++; renderCurrentSlide(); } }
        function goToPrevSlide() { if (state.currentSlide > 0) { state.currentSlide--; renderCurrentSlide(); } }

        // --- TIMERS E TELEPROMPTER ---
        function formatTime(s) { return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }
        function countWordsInBlock(b) { return b[b.type]?.rich_text?.map(t => t.plain_text).join('').trim().split(/\s+/).filter(Boolean).length || 0; }
        
        function toggleMasterTimer() {
            state.isTimerPlaying = !state.isTimerPlaying;
            timerPlayPauseBtn.innerHTML = state.isTimerPlaying ? ICONS.pause : ICONS.play;
            if (state.isTimerPlaying) {
                state.overallTimerInterval = setInterval(() => { state.overallSeconds++; overallTimerEl.textContent = formatTime(state.overallSeconds); }, 1000);
                if (state.settings.displayMode !== 'scroll') startSlideTimer();
            } else {
                clearInterval(state.overallTimerInterval);
                clearInterval(state.slideTimerInterval);
            }
        }

        function resetAndPauseTimers() {
            stopTimers();
            state.overallSeconds = 0; state.slideSeconds = 0;
            overallTimerEl.textContent = '0:00';
            timerPlayPauseBtn.innerHTML = ICONS.play;
        }

        function stopTimers() {
            clearInterval(state.overallTimerInterval);
            clearInterval(state.slideTimerInterval);
            state.isTimerPlaying = false;
            stopTeleprompter();
        }

        function resetSlideTimer() {
            clearInterval(state.slideTimerInterval);
            state.slideSeconds = 0;
            if(state.settings.displayMode !== 'scroll' && state.isTimerPlaying) startSlideTimer();
        }

        function startSlideTimer() {
             const slideTimerEl = $('#slide-timer');
             if (slideTimerEl) {
                 slideTimerEl.textContent = '0:00';
                 state.slideTimerInterval = setInterval(() => {
                     state.slideSeconds++;
                     slideTimerEl.textContent = formatTime(state.slideSeconds);
                 }, 1000);
             }
        }

        function startTeleprompter() {
            if (state.isTeleprompterPlaying) return;
            state.isTeleprompterPlaying = true;
            floatingPlayBtnContainer.classList.add('fade-out');
            if(!state.isTimerPlaying) toggleMasterTimer();
            state.animationFrameId = requestAnimationFrame(teleprompterLoop);
        }

        function stopTeleprompter() {
            if (!state.isTeleprompterPlaying) return;
            state.isTeleprompterPlaying = false;
            floatingPlayBtnContainer.classList.remove('hidden', 'fade-out');
            if(state.isTimerPlaying) toggleMasterTimer();
            cancelAnimationFrame(state.animationFrameId);
        }

        function teleprompterLoop() {
            if (!state.isTeleprompterPlaying) return;
            const scrollableHeight = slidesContainer.scrollHeight - slidesContainer.clientHeight;
            if (scrollableHeight <= 0) return stopTeleprompter();
            const scrollPerSecond = scrollableHeight / (state.totalReadingMinutes * 60 / (state.settings.wpm / 180)); // Ajuste de velocidade
            slidesContainer.scrollTop += scrollPerSecond / 60; // Scroll por frame
            if (slidesContainer.scrollTop >= scrollableHeight) stopTeleprompter();
            else state.animationFrameId = requestAnimationFrame(teleprompterLoop);
        }

        // --- INICIALIZAÇÃO E EVENT LISTENERS ---
        function init() {
            loadSettings();
            updateSettingsUI();
            // Atribuição de ícones
            settingsToggleBtn.innerHTML = ICONS.settings; closeSettingsBtn.innerHTML = ICONS.close;
            prevBtn.innerHTML = ICONS.arrowLeft; nextBtn.innerHTML = ICONS.arrowRight;
            timerPlayPauseBtn.innerHTML = ICONS.play; floatingPlayBtn.innerHTML = ICONS.play;
            
            // Listeners
            generateBtn.addEventListener('click', fetchNotionContent);
            timerPlayPauseBtn.addEventListener('click', toggleMasterTimer);
            nextBtn.addEventListener('click', goToNextSlide);
            prevBtn.addEventListener('click', goToPrevSlide);
            settingsToggleBtn.addEventListener('click', () => settingsPanel.classList.add('open'));
            closeSettingsBtn.addEventListener('click', () => settingsPanel.classList.remove('open'));
            settingsPanel.addEventListener('click', handleSettingChange);
            floatingPlayBtn.addEventListener('click', startTeleprompter);
            wpmIncreaseBtn.addEventListener('click', () => { state.settings.wpm += 10; saveSettings(); updateSettingsUI(); });
            wpmDecreaseBtn.addEventListener('click', () => { if(state.settings.wpm > 20) { state.settings.wpm -= 10; saveSettings(); updateSettingsUI(); }});
            
            document.addEventListener('keydown', e => {
                if (presentationView.classList.contains('hidden')) return;
                if (e.key === 'ArrowRight') goToNextSlide();
                if (e.key === 'ArrowLeft') goToPrevSlide();
                if (e.key === 'Escape') settingsPanel.classList.remove('open');
                if (e.key === ' ' && state.settings.displayMode === 'scroll') {
                    e.preventDefault();
                    state.isTeleprompterPlaying ? stopTeleprompter() : startTeleprompter();
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('pageId')) {
                pageIdInput.value = urlParams.get('pageId');
                generateBtn.click();
            }
        }
        init();
    </script>
</body>
</html>

