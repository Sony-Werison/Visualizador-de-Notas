<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    <!-- Substitua pelo link direto para a sua imagem no GitHub -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/43f95e781ca48c4db484989786df9b1683e6c64f/favicon.png" onerror="this.style.display='none'">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-serif: 'Lora', serif;
            --font-mono: 'Roboto Mono', monospace;
        }
        body { font-family: var(--font-sans); touch-action: pan-y; overflow: hidden; }
        .font-sans { font-family: var(--font-sans); }
        .font-serif { font-family: var(--font-serif); }
        .font-mono { font-family: var(--font-mono); }
        .slide-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .settings-panel, .history-sidebar, .callouts-sidebar { transition: transform 0.3s ease-in-out; }
        .settings-panel { transform: translateX(100%); }
        .settings-panel.open { transform: translateX(0); }
        .history-sidebar, .callouts-sidebar { transform: translateX(-100%); }
        .history-sidebar.open, .callouts-sidebar.open { transform: translateX(0); }
        #slides-container::-webkit-scrollbar, #history-list::-webkit-scrollbar, .settings-panel-content::-webkit-scrollbar, #callouts-list::-webkit-scrollbar { width: 8px; }
        #slides-container::-webkit-scrollbar-track, #history-list::-webkit-scrollbar-track, .settings-panel-content::-webkit-scrollbar-track, #callouts-list::-webkit-scrollbar-track { background: transparent; }
        #slides-container::-webkit-scrollbar-thumb, #history-list::-webkit-scrollbar-thumb, .settings-panel-content::-webkit-scrollbar-thumb, #callouts-list::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        #doc-progress-bar, #page-progress-bar { transition: width 0.3s ease-out; }
        #overlay { transition: opacity 0.3s ease-in-out; }
        
        /* Dark Theme (Default) */
        .dark body { background-color: #191919; color: #d1d5db; }
        .dark #setup-view { background-color: #1f2937; }
        .dark .control-btn-group { background-color: #374151; }
        .dark .control-btn-group button.active { background-color: #4b5563; color: white; }
        .dark .history-item.active, .dark .callout-item.active { background-color: #475569 !important; color: white !important; }
        .dark .subtext-dark { color: #9ca3af; }
        .dark header, .dark footer { background-color: rgba(25, 25, 25, 0.85); backdrop-filter: blur(4px); }
        .dark .settings-panel, .dark .history-sidebar, .dark .callouts-sidebar { background-color: rgba(31, 41, 55, 0.95); backdrop-filter: blur(4px); }
        .dark #wpm-decrease, .dark #wpm-increase { background-color: #374151 }
        .dark blockquote { border-color: #4b5563; color: #9ca3af; }
        .dark hr { border-color: #374151; }
        .dark .progress-bar-bg { background-color: #374151; }

        /* Light Theme Styles */
        html.light body { background-color: #f9fafb; color: #111827; }
        html.light #setup-view { background-color: #ffffff; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        html.light h1, html.light h2, html.light h3, html.light h4, html.light #page-title { color: #111827; }
        html.light input#pageId { background-color: #f3f4f6; color: #111827; border-color: #d1d5db; }
        html.light header, html.light footer { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(4px); }
        html.light #clock, html.light #overall-timer, html.light #footer-info { color: #1f2937; }
        html.light .header-btn, html.light .footer-btn { background-color: #e5e7eb; color: #1f2937;}
        html.light .settings-panel, html.light .history-sidebar, html.light .callouts-sidebar { background-color: rgba(249, 250, 251, 0.95); backdrop-filter: blur(4px); }
        html.light .control-btn-group { background-color: #e5e7eb; }
        html.light .control-btn-group button.active { background-color: #ffffff; color: #111827; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        html.light .history-item.active, html.light .callout-item.active { background-color: #dbeafe !important; color: #1e40af !important; }
        html.light .history-item.active .text-gray-400, html.light .history-item.active .subtext-light, html.light .callout-item.active .text-gray-400 { color: #1e3a8a !important; }
        html.light .history-item .text-gray-400, html.light .callout-item .text-gray-400 { color: #6b7280; }
        html.light .history-item .font-semibold, html.light .callout-item .font-semibold {color: #111827;}
        html.light blockquote { color: #6b7280; border-color: #d1d5db; }
        html.light hr { border-color: #e5e7eb; }
        html.light .callout { background-color: #f3f4f6; }
        html.light .border-b { border-color: #e5e7eb; }
        html.light #slides-container::-webkit-scrollbar-thumb, html.light #history-list::-webkit-scrollbar-thumb, html.light .settings-panel-content::-webkit-scrollbar-thumb, html.light #callouts-list::-webkit-scrollbar-thumb { background-color: #9ca3af; }
        html.light #wpm-decrease, html.light #wpm-increase { background-color: #e5e7eb }
        html.light .progress-bar-bg { background-color: #e5e7eb; }

        /* Sidebar Push Effect */
        header, #footer-bar, #main-content-wrapper {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        .left-sidebar-open header,
        .left-sidebar-open #footer-bar,
        .left-sidebar-open #main-content-wrapper {
            transform: translateX(20rem);
            width: calc(100% - 20rem);
        }
        #main-content-wrapper {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
<div id="app" class="w-full h-screen flex flex-col">
    <!-- Tela de Configura√ß√£o Inicial -->
    <div id="setup-view" class="w-full max-w-xl mx-auto my-auto p-8 rounded-xl shadow-lg space-y-6">
        <h1 class="text-3xl font-bold text-center">Visualizador de Notas do Notion</h1>
        <p class="text-center text-gray-400">Cole a URL de uma p√°gina p√∫blica do Notion para come√ßar.</p>
        <input type="text" id="pageId" placeholder="Cole a URL ou ID da sua p√°gina aqui" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 transition">
        <div class="flex gap-4">
            <button id="generate-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Visualizar</button>
            <button id="preview-btn" class="flex-1 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition">Ver Pr√©via</button>
        </div>
        <div id="error-message" class="text-red-500 text-center font-medium hidden"></div>
    </div>

    <!-- Tela de Apresenta√ß√£o -->
    <div id="presentation-view" class="hidden w-full h-full flex flex-col relative overflow-hidden">
        <div id="overlay" class="fixed inset-0 bg-black/50 z-30 hidden"></div>
        <header class="w-full p-4 flex justify-between items-center absolute top-0 left-0 z-20">
            <div class="w-1/3 flex items-center gap-2">
                 <button id="home-btn" title="Voltar ao In√≠cio" class="header-btn p-2.5 rounded-lg transition"></button>
                <span id="clock" class="text-lg font-mono"></span>
            </div>
            <div class="w-1/3 text-center">
                <h1 id="page-title" class="text-sm font-semibold truncate"></h1>
            </div>
            <div class="w-1/3 flex justify-end items-center gap-2">
                 <button id="auto-scroll-toggle-btn" title="Rolagem Autom√°tica" class="header-btn p-2.5 rounded-lg transition"></button>
                <div id="main-timer-controls" class="header-btn flex items-center gap-2 p-2 rounded-lg">
                    <button id="timer-play-pause-btn" title="Iniciar/Pausar Tempo" class="p-0.5"></button>
                    <span id="overall-timer" class="text-lg font-mono" title="Tempo total da sess√£o">0:00</span>
                </div>
                <button id="theme-toggle-btn" title="Alternar Tema" class="header-btn p-2.5 rounded-lg transition"></button>
                <button id="settings-toggle-btn" title="Ajustes" class="header-btn p-2.5 rounded-lg transition"></button>
            </div>
        </header>
        
        <div id="main-content-wrapper" class="w-full h-full flex flex-row">
            <main id="slides-container" class="w-full h-full flex-1 flex flex-col items-center overflow-y-auto px-12 pt-24 pb-24 transition-all duration-300"></main>
        </div>
        
        <footer id="footer-bar" class="w-full p-4 flex justify-between items-center absolute bottom-0 left-0 z-20">
            <div class="w-1/4 flex items-center gap-2">
                <button id="history-toggle-btn" title="Navega√ß√£o / Hist√≥rico" class="footer-btn hidden p-3 rounded-full transition"></button>
                <button id="callouts-toggle-btn-footer" title="Destaques" class="footer-btn hidden p-3 rounded-full transition"></button>
            </div>
            <div id="footer-center" class="w-1/2 px-4">
                <!-- Conte√∫do do rodap√© injetado via JS -->
            </div>
            <div class="w-1/4 flex justify-end items-center gap-2">
                <button id="prev-btn" title="Anterior" class="footer-btn p-3 rounded-full disabled:opacity-20 transition"></button>
                <button id="next-btn" title="Pr√≥ximo" class="footer-btn p-3 rounded-full disabled:opacity-20 transition"></button>
            </div>
        </footer>
        
        <aside id="history-sidebar" class="history-sidebar fixed top-0 left-0 h-full w-80 shadow-2xl z-40 flex flex-col">
             <div class="p-4 flex justify-between items-center border-b">
                <h3 class="font-bold text-lg">Navega√ß√£o</h3>
                <button id="close-history-btn" title="Fechar" class="p-2"></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto"></div>
        </aside>

        <!-- FIX: Moved callouts sidebar here and styled it like the other fixed sidebars -->
        <aside id="callouts-sidebar" class="callouts-sidebar fixed top-0 left-0 h-full w-80 shadow-2xl z-40 flex flex-col">
             <div class="p-4 flex justify-between items-center border-b">
                <h3 class="font-bold text-lg">Destaques</h3>
                <button id="close-callouts-btn" title="Fechar" class="p-2"></button>
            </div>
            <div id="callouts-list" class="flex-1 overflow-y-auto"></div>
        </aside>

        <aside id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-80 shadow-2xl z-40 flex flex-col">
            <div class="p-4 flex justify-between items-center border-b">
                <h3 class="font-bold text-lg">Ajustes</h3>
                <button id="close-settings-btn" title="Fechar" class="p-2"></button>
            </div>
            <div class="settings-panel-content flex-1 p-6 space-y-8 overflow-y-auto">
                <div>
                    <h4 class="font-semibold mb-3">Modo de Exibi√ß√£o</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="displayMode" data-value="slides" class="flex-1 px-2 py-1 rounded">P√°ginas</button>
                        <button data-setting="displayMode" data-value="scroll" class="flex-1 px-2 py-1 rounded">Rolagem</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Quebras de P√°gina</h4>
                     <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="pageBreakHeadings" data-value="heading_1" class="flex-1 px-2 py-1 rounded">H1</button>
                        <button data-setting="pageBreakHeadings" data-value="heading_2" class="flex-1 px-2 py-1 rounded">H2</button>
                        <button data-setting="pageBreakHeadings" data-value="heading_3" class="flex-1 px-2 py-1 rounded">H3</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Alinhamento do Texto</h4>
                     <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="textAlign" data-value="text-left" class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                        <button data-setting="textAlign" data-value="text-center" class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                        <button data-setting="textAlign" data-value="text-right" class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                        <button data-setting="textAlign" data-value="text-justify" class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Fonte</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="fontFamily" data-value="font-sans" class="flex-1 px-2 py-1 rounded">Sans</button>
                        <button data-setting="fontFamily" data-value="font-serif" class="flex-1 px-2 py-1 rounded">Serif</button>
                        <button data-setting="fontFamily" data-value="font-mono" class="flex-1 px-2 py-1 rounded">Mono</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Tamanho da Fonte (Texto)</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                         <button data-setting="fontSize" data-value="-2" class="flex-1 px-2 py-1 rounded">P</button>
                         <button data-setting="fontSize" data-value="-1" class="flex-1 px-2 py-1 rounded">M</button>
                         <button data-setting="fontSize" data-value="0" class="flex-1 px-2 py-1 rounded">G</button>
                         <button data-setting="fontSize" data-value="1" class="flex-1 px-2 py-1 rounded">XG</button>
                         <button data-setting="fontSize" data-value="2" class="flex-1 px-2 py-1 rounded">2XG</button>
                    </div>
                </div>
                 <div>
                    <h4 class="font-semibold mb-3">Tamanho da Fonte (Destaques)</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                         <button data-setting="calloutFontSize" data-value="-2" class="flex-1 px-2 py-1 rounded">P</button>
                         <button data-setting="calloutFontSize" data-value="-1" class="flex-1 px-2 py-1 rounded">M</button>
                         <button data-setting="calloutFontSize" data-value="0" class="flex-1 px-2 py-1 rounded">G</button>
                         <button data-setting="calloutFontSize" data-value="1" class="flex-1 px-2 py-1 rounded">XG</button>
                         <button data-setting="calloutFontSize" data-value="2" class="flex-1 px-2 py-1 rounded">2XG</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Espa√ßamento entre Linhas</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="lineHeight" data-value="leading-normal" class="flex-1 px-2 py-1 rounded">Simples</button>
                        <button data-setting="lineHeight" data-value="leading-relaxed" class="flex-1 px-2 py-1 rounded">1.5</button>
                        <button data-setting="lineHeight" data-value="leading-loose" class="flex-1 px-2 py-1 rounded">Duplo</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Margens</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="textWidth" data-value="max-w-xl" class="flex-1 px-2 py-1 rounded">Estreito</button>
                        <button data-setting="textWidth" data-value="max-w-3xl" class="flex-1 px-2 py-1 rounded">Normal</button>
                        <button data-setting="textWidth" data-value="max-w-5xl" class="flex-1 px-2 py-1 rounded">Largo</button>
                    </div>
                </div>
                 <div>
                    <h4 class="font-semibold mb-3">Andamento no Rodap√©</h4>
                    <div class="control-btn-group flex rounded-md p-1">
                        <button data-setting="progressDisplay" data-value="time" class="flex-1 px-2 py-1 rounded">Tempo</button>
                        <button data-setting="progressDisplay" data-value="percent" class="flex-1 px-2 py-1 rounded">%</button>
                    </div>
                </div>
                <div id="wpm-controls" class="pt-4 border-t">
                    <h4 class="font-semibold mb-2">Velocidade de Leitura (PPM)</h4>
                     <p class="text-xs text-gray-400 mb-2">Isso tamb√©m ajusta a velocidade da Rolagem Autom√°tica.</p>
                    <div class="flex items-center justify-between">
                         <button id="wpm-decrease" class="px-3 py-1 rounded transition">-</button>
                         <span id="wpm-display" class="font-mono text-center text-lg">180</span>
                         <button id="wpm-increase" class="px-3 py-1 rounded transition">+</button>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    
    <div id="loading-view" class="hidden my-auto">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mx-auto"></div>
    </div>
</div>

<script>
    const ICONS = {
        play: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`,
        pause: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`,
        settings: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
        close: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
        arrowLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
        arrowRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
        menu: `<svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`,
        sun: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        moon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        home: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
        scrollPlay: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 13l-5 5-5-5M17 6l-5 5-5-5"/></svg>`,
        scrollPause: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
        book: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
        alignLeft: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>`,
        alignCenter: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg>`,
        alignRight: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></svg>`,
        alignJustify: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg>`
    };
    
    const $ = (selector) => document.querySelector(selector);
    
    const setupView = $('#setup-view'), presentationView = $('#presentation-view'), loadingView = $('#loading-view');
    const pageIdInput = $('#pageId'), generateBtn = $('#generate-btn'), previewBtn = $('#preview-btn'), errorMessage = $('#error-message');
    const clockEl = $('#clock'), pageTitle = $('#page-title'), slidesContainer = $('#slides-container');
    const prevBtn = $('#prev-btn'), nextBtn = $('#next-btn'), footerCenter = $('#footer-center');
    const timerPlayPauseBtn = $('#timer-play-pause-btn'), overallTimerEl = $('#overall-timer');
    const settingsPanel = $('#settings-panel'), settingsToggleBtn = $('#settings-toggle-btn'), closeSettingsBtn = $('#close-settings-btn');
    const themeToggleBtn = $('#theme-toggle-btn');
    const homeBtn = $('#home-btn');
    const wpmDecreaseBtn = $('#wpm-decrease'), wpmIncreaseBtn = $('#wpm-increase'), wpmDisplay = $('#wpm-display');
    const historySidebar = $('#history-sidebar'), historyToggleBtn = $('#history-toggle-btn'), closeHistoryBtn = $('#close-history-btn'), historyList = $('#history-list');
    const calloutsSidebar = $('#callouts-sidebar'), calloutsToggleBtn = $('#callouts-toggle-btn-footer'), closeCalloutsBtn = $('#close-callouts-btn'), calloutsList = $('#callouts-list');
    const autoScrollToggleBtn = $('#auto-scroll-toggle-btn');
    const overlay = $('#overlay');

    let state = {
        rawBlocks: [], slides: [], currentSlide: 0, pageTitle: '',
        isTimerRunning: false, overallTimerInterval: null, overallSeconds: 0, pageSeconds: 0, 
        pageTimeHistory: {}, clockInterval: null,
        isAutoScrolling: false, autoScrollInterval: null,
        settings: {
            theme: 'dark', displayMode: 'slides', fontFamily: 'font-sans', fontSize: 0,
            lineHeight: 'leading-relaxed', textWidth: 'max-w-3xl', wpm: 180, progressDisplay: 'time',
            pageBreakHeadings: ['heading_1', 'heading_2'],
            textAlign: 'text-left',
            calloutFontSize: 0,
        }
    };

    const MOCK_DATA = {
        pageTitle: "Tutorial Interativo",
        blocks: [
            { id: 'mock-1', type: 'heading_1', heading_1: { rich_text: [{ plain_text: 'Bem-vindo ao Tutorial Interativo!' }] } },
            { id: 'mock-2', type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Esta √© uma p√°gina de exemplo para voc√™ testar todas as funcionalidades da ferramenta. Use os bot√µes e menus para ver tudo em a√ß√£o.' }] } },
            { id: 'mock-3', type: 'callout', callout: { icon: { emoji: 'üí°' }, rich_text: [{ plain_text: 'Dica: Use as setas do teclado ou deslize o dedo na tela para navegar entre as p√°ginas!' }], color: 'gray_background' } },
            { id: 'mock-4', type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'No rodap√©, voc√™ pode ver seu progresso de duas formas: por tempo estimado de leitura ou por porcentagem. Alterne entre elas nos Ajustes (‚öôÔ∏è).' }] } },
            { id: 'mock-8', type: 'heading_2', heading_2: { rich_text: [{ plain_text: 'Modos de Visualiza√ß√£o e Layout' }] } },
            { id: 'mock-9', type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Atualmente, voc√™ est√° no modo "P√°ginas". Note como este t√≠tulo (H2) iniciou uma nova p√°gina. Voc√™ pode customizar quais t√≠tulos (H1, H2, H3) causam essa quebra na se√ß√£o "Quebras de P√°gina" dos Ajustes.' }] } },
            { id: 'mock-10', type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Experimente tamb√©m o modo "Rolagem". Nele, todo o conte√∫do se torna uma √∫nica p√°gina cont√≠nua. Nesse modo, um bot√£o de rolagem autom√°tica (üîΩ) aparecer√° no topo. A velocidade √© sincronizada com seu PPM (Palavras por Minuto).' }] } },
            { id: 'mock-11', type: 'callout', callout: { icon: { emoji: 'üé®' }, rich_text: [{ plain_text: 'Ainda nos Ajustes, voc√™ pode mudar a fonte, o tamanho do texto (principal e dos destaques), o espa√ßamento entre linhas, as margens e o alinhamento do texto.' }], color: 'blue_background' } },
             { id: 'mock-12', type: 'heading_2', heading_2: { rich_text: [{ plain_text: 'Destaques e Navega√ß√£o' }] } },
            { id: 'mock-13', type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Para encontrar informa√ß√µes importantes rapidamente, use o painel de "Destaques". Clique no √≠cone de livro (üìñ) no canto inferior esquerdo para abrir uma lista com todos os destaques (callouts) do documento.' }] } },
            { id: 'mock-14', type: 'callout', callout: { icon: { emoji: 'üéØ' }, rich_text: [{ plain_text: 'Este √© um exemplo de um callout com um texto um pouco mais longo para que voc√™ possa testar a barra de rolagem dentro do painel de Destaques. Clicar nos itens desta barra lateral n√£o te levar√° a lugar nenhum, ela serve como um sum√°rio dos pontos-chave do seu texto para consulta r√°pida.' }], color: 'green_background' } },
             { id: 'mock-15', type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'As barras laterais de Navega√ß√£o e Destaques agora s√£o independentes e sobrep√µem o conte√∫do principal. Voc√™ pode fech√°-las clicando no "X" ou na √°rea escurecida fora delas.' }] } }
        ]
    };

    const extractPageId = (input) => {
        if (!input) return ''; try { if (input.startsWith('http')) { const url = new URL(input); const pathParts = url.pathname.split('/'); const lastPart = pathParts[pathParts.length - 1]; const idFromEnd = lastPart.split('-').pop(); if (idFromEnd && /^[0-9a-f]{32}$/.test(idFromEnd)) return idFromEnd; } const cleanId = input.split('-').pop().replace(/[^0-9a-fA-F]/g, ''); if (/^[0-9a-f]{32}$/.test(cleanId)) return cleanId; } catch (e) {} return '';
    };

    async function fetchNotionContent(isPreview = false) {
        if (isPreview) {
            state.pageTitle = MOCK_DATA.pageTitle; state.rawBlocks = MOCK_DATA.blocks;
            rebuildSlidesAndRender(); showView('presentation'); return;
        }
        const pageId = extractPageId(pageIdInput.value.trim());
        if (!pageId) { showError("URL ou ID da P√°gina inv√°lido."); return; }
        showView('loading');
        try {
            const response = await fetch(`https://notion-api-worker-sonny.glitch.me/v1/page/${pageId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status}` }));
                throw new Error(errorData.message || 'Falha ao buscar a p√°gina.');
            }
            const data = await response.json();
            const titleProperty = Object.values(data.page.properties).find(p => p.type === 'title');
            state.pageTitle = titleProperty ? titleProperty.title[0].plain_text : 'Sem T√≠tulo';
            state.rawBlocks = data.blocks;
            rebuildSlidesAndRender(); showView('presentation');
        } catch (error) { showError(`Falha ao buscar conte√∫do: ${error.message}. Verifique a URL e se a p√°gina √© p√∫blica.`); showView('setup'); }
    }

    const parseBlocksIntoSlides = (blocks) => {
        if (!blocks || blocks.length === 0) return [[]];
        if (state.settings.displayMode === 'scroll') {
            calloutsToggleBtn.classList.remove('hidden');
            return [blocks];
        };
        const slides = []; let currentSlideContent = [];
        blocks.forEach(block => {
            const isHeading = state.settings.pageBreakHeadings.includes(block.type);
            if (isHeading && currentSlideContent.length > 0) { slides.push(currentSlideContent); currentSlideContent = []; }
            currentSlideContent.push(block);
        });
        if (currentSlideContent.length > 0) slides.push(currentSlideContent);
        return slides.length > 0 ? slides : [[]];
    };

    const processRichText = (richTextArray) => {
        if (!richTextArray) return '';
        const colorMap = {
            "gray": "text-gray-400", "brown": "text-yellow-600", "orange": "text-orange-500", "yellow": "text-yellow-400", "green": "text-green-500", "blue": "text-blue-500", "purple": "text-purple-500", "pink": "text-pink-500", "red": "text-red-500",
            "gray_background": "bg-gray-700/50 px-1 rounded", "brown_background": "bg-yellow-800/50 px-1 rounded", "orange_background": "bg-orange-800/50 px-1 rounded", "yellow_background": "bg-yellow-800/50 px-1 rounded", "green_background": "bg-green-800/50 px-1 rounded", "blue_background": "bg-blue-800/50 px-1 rounded", "purple_background": "bg-purple-800/50 px-1 rounded", "pink_background": "bg-pink-800/50 px-1 rounded", "red_background": "bg-red-800/50 px-1 rounded"
        };
        return richTextArray.map(text => {
            const annotations = text.annotations || {};
            const classList = [];
            if (annotations.bold) classList.push('font-bold');
            if (annotations.italic) classList.push('italic');
            if (annotations.strikethrough) classList.push('line-through');
            if (annotations.underline) classList.push('underline');
            if (annotations.code) classList.push('font-mono bg-gray-700/50 px-1 py-0.5 rounded text-sm');
            if (annotations.color !== 'default') classList.push(colorMap[annotations.color]);
            let content = text.plain_text.replace(/\n/g, '<br>');
            if (text.href) {
                return `<a href="${text.href}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline ${classList.join(' ')}">${content}</a>`;
            }
            return `<span class="${classList.join(' ')}">${content}</span>`;
        }).join('');
    };

    const createHtmlFromBlock = (block) => {
        const type = block.type; const content = block[type]; if (!content) return null;
        let el;
        switch(type) {
            case 'heading_1': el = document.createElement('h1'); el.className = 'font-bold leading-tight'; el.innerHTML = processRichText(content.rich_text); break;
            case 'heading_2': el = document.createElement('h2'); el.className = 'font-semibold mt-10 leading-snug'; el.innerHTML = processRichText(content.rich_text); break;
            case 'heading_3': el = document.createElement('h3'); el.className = 'font-medium mt-8'; el.innerHTML = processRichText(content.rich_text); break;
            case 'paragraph': el = document.createElement('p'); el.innerHTML = processRichText(content.rich_text) || '&nbsp;'; break;
            case 'bulleted_list_item': case 'numbered_list_item': el = document.createElement('li'); el.className = 'ml-6 list-disc'; el.innerHTML = processRichText(content.rich_text); break;
            case 'image': el = document.createElement('img'); el.src = content.type === 'external' ? content.external.url : content.file.url; el.className = 'max-w-full h-auto rounded-lg shadow-lg my-6 mx-auto block'; break;
            case 'divider': el = document.createElement('hr'); el.className = 'my-8'; break;
            case 'quote': el = document.createElement('blockquote'); el.className = 'pl-4 border-l-4 italic'; el.innerHTML = processRichText(content.rich_text); break;
            case 'callout':
                const icon = (content.icon && content.icon.emoji) ? content.icon.emoji : '‚ÑπÔ∏è';
                el = document.createElement('div'); el.className = `p-4 rounded-lg flex items-start gap-4 my-4 callout`;
                el.innerHTML = `<span>${icon}</span><div class="flex-1">${processRichText(content.rich_text)}</div>`;
                break;
            default: return null;
        }
        if (el && block.id) {
            el.id = `block-${block.id}`;
        }
        return el;
    };

    const renderCurrentSlide = () => {
        const slideData = state.slides[state.currentSlide];
        const wrapper = document.createElement('div'); wrapper.className = 'slide-content w-full h-full space-y-5';
        if (!slideData || slideData.length === 0) { wrapper.innerHTML = `<p class="text-center text-gray-400">Nenhum conte√∫do.</p>`;
        } else { slideData.forEach(block => { const el = createHtmlFromBlock(block); if (el) wrapper.appendChild(el); }); }
        const spacer = document.createElement('div');
        spacer.style.height = '50vh';
        wrapper.appendChild(spacer);
        slidesContainer.innerHTML = ''; slidesContainer.appendChild(wrapper); pageTitle.textContent = state.pageTitle; applySettings(); updateControls(); renderHistorySidebar(); renderCalloutsSidebar();
        requestAnimationFrame(() => requestAnimationFrame(updateFooterInfo));
    };

    const rebuildSlidesAndRender = () => { stopAutoScroll(); state.slides = parseBlocksIntoSlides(state.rawBlocks); state.currentSlide = 0; state.pageSeconds = 0; state.pageTimeHistory = {}; renderCurrentSlide(); slidesContainer.scrollTop = 0; };
    
    const showView = (view) => {
        [setupView, presentationView, loadingView].forEach(v => v.classList.add('hidden'));
        clearInterval(state.clockInterval);
        if (view === 'setup') {
            setupView.classList.remove('hidden'); stopTimer(); stopAutoScroll(); closeAllSidebars();
        } else if (view === 'presentation') {
            presentationView.classList.remove('hidden'); updateClock(); state.clockInterval = setInterval(updateClock, 1000);
        } else if (view === 'loading') {
            loadingView.classList.remove('hidden');
        }
    };
    
    const showError = (msg) => { errorMessage.textContent = msg; errorMessage.classList.remove('hidden'); };
    
    const recordPageTime = () => {
        if (state.isTimerRunning || state.overallSeconds > 0) {
            const currentPage = state.currentSlide;
            state.pageTimeHistory[currentPage] = (state.pageTimeHistory[currentPage] || 0) + state.pageSeconds;
        }
    };
    const goToSlide = (index) => {
        if(index >= 0 && index < state.slides.length) {
            recordPageTime();
            stopAutoScroll();
            state.currentSlide = index;
            state.pageSeconds = 0;
            slidesContainer.scrollTop = 0; 
            renderCurrentSlide();
            toggleHistorySidebar(false);
        }
    };
    const goToNextSlide = () => { if (state.currentSlide < state.slides.length - 1) { goToSlide(state.currentSlide + 1); } };
    const goToPrevSlide = () => { if (state.currentSlide > 0) { goToSlide(state.currentSlide - 1); } };
    
    const updateControls = () => {
        const isScroll = state.settings.displayMode === 'scroll';
        prevBtn.style.visibility = isScroll ? 'hidden' : 'visible'; 
        nextBtn.style.visibility = isScroll ? 'hidden' : 'visible';
        
        if (!isScroll) { 
            prevBtn.disabled = state.currentSlide === 0; 
            nextBtn.disabled = state.currentSlide >= state.slides.length - 1; 
        }
        stopAutoScroll();
        updateFooterInfo();
    };
    
    const countWordsInBlock = (block) => (block[block.type]?.rich_text || []).map(t => t.plain_text).join(' ').trim().split(/\s+/).filter(Boolean).length;
    const formatTime = (s) => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
    
    const updateFooterInfo = () => {
        const wpm = state.settings.wpm;
        const totalWordsAll = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
        
        if (totalWordsAll === 0) {
            footerCenter.innerHTML = '';
            return;
        }
        
        const { scrollTop, scrollHeight, clientHeight } = slidesContainer;
        
        const pageBarHTML = `<div class="w-full rounded-full h-2 progress-bar-bg"><div id="page-progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%;"></div></div>`;
        const docBarHTML = `<div class="w-full rounded-full h-2 progress-bar-bg"><div id="doc-progress-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%;"></div></div>`;

        if (state.settings.displayMode === 'scroll') {
            const scrollPercent = scrollHeight > clientHeight ? (scrollTop / (scrollHeight - clientHeight)) : 1;
            const wordsRead = totalWordsAll * scrollPercent;
            const wordsRemaining = totalWordsAll - wordsRead;
            
            const totalTimeInSeconds = (totalWordsAll / wpm) * 60;
            const remainingTimeInSeconds = (wordsRemaining / wpm) * 60;
            
            const infoHTML = `<div class="text-center text-sm font-mono mb-2">Total: ${formatTime(totalTimeInSeconds)} | Restante: ${formatTime(remainingTimeInSeconds)}</div>`;
            const barHTML = `<div class="w-full">${docBarHTML}</div>`;
            
            footerCenter.innerHTML = infoHTML + barHTML;
            $('#doc-progress-bar').style.width = `${scrollPercent * 100}%`;

        } else { // SLIDES MODE
            const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const pageTimeSeconds = (wordsOnPage / wpm) * 60;
            const pageScrollPercent = scrollHeight > clientHeight ? (scrollTop / (scrollHeight - clientHeight)) : (wordsOnPage > 0 ? 1 : 0);
            const pageWordsRead = wordsOnPage * pageScrollPercent;
            const pageWordsRemaining = wordsOnPage - pageWordsRead;
            const pageTimeRemainingSeconds = (pageWordsRemaining / wpm) * 60;

            const wordsBeforeCurrentPage = state.slides.slice(0, state.currentSlide).flat().reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const totalWordsRead = wordsBeforeCurrentPage + pageWordsRead;
            const docTimeSeconds = (totalWordsAll / wpm) * 60;
            const docTimeRemainingSeconds = (docTimeSeconds) - ((totalWordsRead / wpm) * 60);
            const docPercent = totalWordsAll > 0 ? (totalWordsRead / totalWordsAll) * 100 : 0;

            let infoHTML = '', barsHTML = '';

            if (state.settings.progressDisplay === 'percent') {
                 infoHTML = `<div class="flex justify-around items-center text-xs w-full mb-2">
                     <div class="w-1/2 text-center"><span>P√°g: ${state.currentSlide + 1}/${state.slides.length} | ${Math.round(pageScrollPercent * 100)}%</span></div>
                     <div class="w-1/2 text-center"><span>Documento: ${Math.round(docPercent)}%</span></div>
                </div>`;
            } else { // 'time' display
                 infoHTML = `<div class="flex justify-around text-xs w-full mb-2">
                     <div class="w-1/2 text-center">
                         <div class="font-bold">P√°g (${state.currentSlide + 1}/${state.slides.length})</div>
                         <div>Total: ${formatTime(pageTimeSeconds)} | Restante: ${formatTime(pageTimeRemainingSeconds)}</div>
                    </div>
                     <div class="w-1/2 text-center">
                         <div class="font-bold">Documento</div>
                         <div>Total: ${formatTime(docTimeSeconds)} | Restante: ${formatTime(docTimeRemainingSeconds)}</div>
                    </div>
                </div>`;
            }
            
            barsHTML = `<div class="w-full flex items-center justify-center gap-4">
                             <div class="flex-1">${pageBarHTML}</div>
                             <div class="flex-1">${docBarHTML}</div>
                        </div>`;
            
            footerCenter.innerHTML = infoHTML + barsHTML;
            $('#page-progress-bar').style.width = `${pageScrollPercent * 100}%`;
            $('#doc-progress-bar').style.width = `${docPercent}%`;
        }
    };

    const renderHistorySidebar = () => {
        const shouldShow = state.settings.displayMode === 'slides' && state.slides.length > 1;
        historyToggleBtn.classList.toggle('hidden', !shouldShow);
        if (!shouldShow) { toggleHistorySidebar(false); return; }
        historyList.innerHTML = '';
        state.slides.forEach((slide, index) => {
            const firstBlock = slide[0];
            let pageTitleText = `P√°gina ${index + 1}`;
            const headingType = ['heading_1', 'heading_2', 'heading_3'].find(h => firstBlock && firstBlock.type === h);
            if(headingType) {
                const richText = firstBlock[headingType].rich_text;
                if (richText && richText.length > 0) pageTitleText = richText.map(t => t.plain_text).join('');
            }
            const wordsOnPage = slide.reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const estimatedTime = formatTime((wordsOnPage / state.settings.wpm) * 60);
            const spentTimeRaw = state.pageTimeHistory[index] || 0;
            const currentSpentTime = (state.isTimerRunning && index === state.currentSlide) ? spentTimeRaw + state.pageSeconds : spentTimeRaw;
            const spentTime = (state.isTimerRunning || spentTimeRaw > 0) ? formatTime(currentSpentTime) : '...';
            const item = document.createElement('button');
            item.className = `history-item w-full text-left p-4 hover:bg-opacity-50 transition-colors border-b ${index === state.currentSlide ? 'active' : ''}`;
            item.dataset.index = index;
            item.innerHTML = `<div class="font-semibold truncate" title="${pageTitleText}">${pageTitleText}</div>
                                  <div class="text-sm font-mono mt-1 ${document.documentElement.classList.contains('light') ? 'subtext-light' : 'text-gray-400'}">Gasto: ${spentTime} / Previsto: ${estimatedTime}</div>`;
            historyList.appendChild(item);
        });
    };

    const renderCalloutsSidebar = () => {
        const calloutBlocks = state.rawBlocks.filter(b => b.type === 'callout');
        calloutsToggleBtn.classList.toggle('hidden', calloutBlocks.length === 0);
        if (calloutBlocks.length === 0) {
            toggleCalloutsSidebar(false);
            return;
        }

        calloutsList.innerHTML = '';
        calloutBlocks.forEach(block => {
            const content = block.callout;
            const text = (content.rich_text || []).map(t => t.plain_text).join('');
            const icon = content.icon?.emoji || '‚ÑπÔ∏è';

            const item = document.createElement('div');
            item.className = 'callout-item w-full text-left p-4 border-b';
            item.innerHTML = `<div class="flex items-start gap-3">
                                  <span class="text-xl">${icon}</span>
                                  <span class="flex-1">${text}</span>
                                </div>`;
            calloutsList.appendChild(item);
        });
        applySettings(); // Re-apply font size for callouts
    };
    
    const updateOverlay = () => {
        if (historySidebar.classList.contains('open') || settingsPanel.classList.contains('open') || calloutsSidebar.classList.contains('open')) {
            overlay.classList.remove('hidden');
            overlay.style.opacity = '1';
        } else {
            overlay.style.opacity = '0';
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
    };
    
    const closeAllSidebars = () => {
        historySidebar.classList.remove('open');
        settingsPanel.classList.remove('open');
        calloutsSidebar.classList.remove('open');
        presentationView.classList.remove('left-sidebar-open');
        updateOverlay();
    };

    const toggleHistorySidebar = (open) => { 
        if (open) { 
            closeAllSidebars(); 
            historySidebar.classList.add('open'); 
            presentationView.classList.add('left-sidebar-open');
        } else { 
            historySidebar.classList.remove('open'); 
            presentationView.classList.remove('left-sidebar-open');
        } 
        updateOverlay(); 
    };
    const toggleSettingsPanel = (open) => { if (open) { closeAllSidebars(); settingsPanel.classList.add('open'); } else { settingsPanel.classList.remove('open'); } updateOverlay(); };
    const toggleCalloutsSidebar = (open) => { 
        if (open) { 
            closeAllSidebars(); 
            calloutsSidebar.classList.add('open');
            presentationView.classList.add('left-sidebar-open');
        } else { 
            calloutsSidebar.classList.remove('open');
            presentationView.classList.remove('left-sidebar-open');
        } 
        updateOverlay(); 
    };

    const applyTheme = (isToggle = false) => {
        if (isToggle) {
            state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
        }
        document.documentElement.classList.remove('light', 'dark');
        document.documentElement.classList.add(state.settings.theme);
        themeToggleBtn.innerHTML = state.settings.theme === 'dark' ? ICONS.sun : ICONS.moon;
        localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings));
        updateSettingsUI();
        renderHistorySidebar(); 
    };
    const applySettings = () => {
        const contentWrapper = slidesContainer;
        if (!contentWrapper) return;
        
        const alignClasses = ['text-left', 'text-center', 'text-right', 'text-justify'];
        contentWrapper.classList.remove(...alignClasses);
        contentWrapper.classList.add(state.settings.textAlign);
        
        const content = contentWrapper.querySelector('.slide-content');
        if (!content) return;

        const fontClasses = ['font-sans','font-serif','font-mono','leading-normal','leading-relaxed','leading-loose','max-w-xl','max-w-3xl','max-w-5xl'];
        content.classList.remove(...fontClasses); 
        content.classList.add(state.settings.fontFamily, state.settings.lineHeight, state.settings.textWidth);
        
        const baseSizeRem = 1.125 + (state.settings.fontSize * 0.125);
        content.style.fontSize = `${baseSizeRem}rem`;

        content.querySelectorAll('h1').forEach(h => h.style.fontSize = `${baseSizeRem * 1.8}rem`);
        content.querySelectorAll('h2').forEach(h => h.style.fontSize = `${baseSizeRem * 1.5}rem`);
        content.querySelectorAll('h3').forEach(h => h.style.fontSize = `${baseSizeRem * 1.25}rem`);

        const calloutBaseSizeRem = 0.875 + (state.settings.calloutFontSize * 0.0625);
        document.querySelectorAll('.callout-item .flex-1').forEach(el => el.style.fontSize = `${calloutBaseSizeRem}rem`);

        wpmDisplay.textContent = state.settings.wpm; 
        updateFooterInfo(); 
        updateSettingsUI(); 
        renderHistorySidebar();
    };
    const updateSettingsUI = () => {
        for (const key in state.settings) {
            if (key === 'wpm') continue;
            
            if (key === 'pageBreakHeadings') {
                document.querySelectorAll(`[data-setting="pageBreakHeadings"]`).forEach(btn => {
                    btn.classList.toggle('active', state.settings.pageBreakHeadings.includes(btn.dataset.value));
                });
            } else {
                document.querySelectorAll(`[data-setting="${key}"]`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value == state.settings[key]);
                });
            }
        }
    };
    
    const handleSettingChange = (e) => {
        const btn = e.target.closest('button[data-setting]');
        if (!btn) return;
        const { setting, value } = btn.dataset;
        let settingChanged = false;

        if (setting === 'pageBreakHeadings') {
            const currentBreaks = state.settings.pageBreakHeadings;
            const isCurrentlySet = currentBreaks.includes(value);
            if (isCurrentlySet) {
                if (currentBreaks.length > 1) {
                    state.settings.pageBreakHeadings = currentBreaks.filter(h => h !== value);
                    settingChanged = true;
                }
            } else {
                state.settings.pageBreakHeadings.push(value);
                settingChanged = true;
            }
            if (settingChanged) {
                 rebuildSlidesAndRender();
            }
        } else {
            const newValue = isNaN(value) ? value : parseInt(value);
            if (state.settings[setting] !== newValue) {
                state.settings[setting] = newValue;
                settingChanged = true;
                if (setting === 'displayMode') {
                    rebuildSlidesAndRender();
                } else {
                    applySettings();
                }
            }
        }
        if(settingChanged) {
            localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings));
            updateSettingsUI();
        }
    };

    const updateClock = () => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        clockEl.textContent = `${hours}:${minutes}`;
    };

    const startTimer = () => {
        if (state.isTimerRunning) return;
        state.isTimerRunning = true;
        timerPlayPauseBtn.innerHTML = ICONS.pause;
        state.pageSeconds = 0;
        state.overallTimerInterval = setInterval(() => {
            state.overallSeconds++; state.pageSeconds++;
            overallTimerEl.textContent = formatTime(state.overallSeconds);
            renderHistorySidebar();
        }, 1000);
        renderHistorySidebar();
    };
    
    const stopTimer = () => {
        if (!state.isTimerRunning) return;
        recordPageTime();
        state.isTimerRunning = false;
        timerPlayPauseBtn.innerHTML = ICONS.play;
        clearInterval(state.overallTimerInterval);
        renderHistorySidebar();
    };
    const toggleTimer = () => state.isTimerRunning ? stopTimer() : startTimer();
    
    const startAutoScroll = () => {
        if (state.isAutoScrolling) return;

        const { scrollTop, scrollHeight, clientHeight } = slidesContainer;
        const scrollableHeight = scrollHeight - clientHeight;
        const wpm = state.settings.wpm;

        // Case 1: Page is NOT scrollable. We just wait and then advance.
        if (scrollableHeight < 1 && state.settings.displayMode === 'slides') {
            const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const duration = ((wordsOnPage / wpm) * 60 * 1000);

            if (duration < 100) return;

            state.isAutoScrolling = true;
            autoScrollToggleBtn.innerHTML = ICONS.scrollPause;
            state.autoScrollInterval = setTimeout(() => {
                if (state.isAutoScrolling) {
                    stopAutoScroll();
                    if (state.currentSlide < state.slides.length - 1) {
                        goToNextSlide();
                    }
                }
            }, duration);
            return;
        }
        
        // Case 2: Page IS scrollable.
        const remainingScroll = scrollableHeight - scrollTop;
        if (remainingScroll <= 1) return;
        
        let wordsRemaining = 0;

        if (state.settings.displayMode === 'scroll') {
            const totalWordsAll = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const scrollPercent = (scrollTop / scrollableHeight);
            const wordsRead = totalWordsAll * scrollPercent;
            wordsRemaining = totalWordsAll - wordsRead;
        } else { // slides mode
            const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const pageScrollPercent = (scrollTop / scrollableHeight);
            const pageWordsRead = wordsOnPage * pageScrollPercent;
            wordsRemaining = wordsOnPage - pageWordsRead;
        }

        const totalDuration = ((wordsRemaining / wpm) * 60 * 1000);
        
        if (totalDuration <= 100) {
            stopAutoScroll();
            return;
        }
        
        state.isAutoScrolling = true;
        autoScrollToggleBtn.innerHTML = ICONS.scrollPause;
        
        let startTime = null;
        const startScrollTop = scrollTop;

        const scrollStep = (timestamp) => {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / totalDuration, 1);
            
            slidesContainer.scrollTop = startScrollTop + remainingScroll * progress;

            if (progress < 1) {
                state.autoScrollInterval = requestAnimationFrame(scrollStep);
            } else {
                stopAutoScroll();
                if (state.settings.displayMode === 'slides' && state.currentSlide < state.slides.length - 1) {
                    setTimeout(goToNextSlide, 1000);
                }
            }
        };

        state.autoScrollInterval = requestAnimationFrame(scrollStep);
    };

    const stopAutoScroll = () => {
        if (!state.isAutoScrolling) return;
        state.isAutoScrolling = false;
        autoScrollToggleBtn.innerHTML = ICONS.scrollPlay;
        if (state.autoScrollInterval) {
            cancelAnimationFrame(state.autoScrollInterval);
            clearTimeout(state.autoScrollInterval); // Handles both setTimeout and rAF
        }
        state.autoScrollInterval = null;
    };
    const toggleAutoScroll = () => state.isAutoScrolling ? stopAutoScroll() : startAutoScroll();
    
    // Swipe Gesture Handling
    let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
    function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }
    function handleTouchMove(e) { touchEndX = e.changedTouches[0].screenX; touchEndY = e.changedTouches[0].screenY; }
    function handleTouchEnd() {
        if (state.settings.displayMode !== 'slides') return;
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) { // Horizontal swipe
            if (deltaX < 0) { goToNextSlide(); } else { goToPrevSlide(); }
        }
    }
    
    const init = () => {
        if (timerPlayPauseBtn) timerPlayPauseBtn.innerHTML = ICONS.play;
        if (settingsToggleBtn) settingsToggleBtn.innerHTML = ICONS.settings;
        if (closeSettingsBtn) closeSettingsBtn.innerHTML = ICONS.close;
        if (prevBtn) prevBtn.innerHTML = ICONS.arrowLeft;
        if (nextBtn) nextBtn.innerHTML = ICONS.arrowRight;
        if (historyToggleBtn) historyToggleBtn.innerHTML = ICONS.menu;
        if (closeHistoryBtn) closeHistoryBtn.innerHTML = ICONS.close;
        if (homeBtn) homeBtn.innerHTML = ICONS.home;
        if (autoScrollToggleBtn) autoScrollToggleBtn.innerHTML = ICONS.scrollPlay;
        if (calloutsToggleBtn) calloutsToggleBtn.innerHTML = ICONS.book;
        if (closeCalloutsBtn) closeCalloutsBtn.innerHTML = ICONS.close;

        document.querySelector('[data-setting="textAlign"][data-value="text-left"]').innerHTML = ICONS.alignLeft;
        document.querySelector('[data-setting="textAlign"][data-value="text-center"]').innerHTML = ICONS.alignCenter;
        document.querySelector('[data-setting="textAlign"][data-value="text-right"]').innerHTML = ICONS.alignRight;
        document.querySelector('[data-setting="textAlign"][data-value="text-justify"]').innerHTML = ICONS.alignJustify;

        const savedSettings = JSON.parse(localStorage.getItem('notionViewerSettings'));
        if (savedSettings) state.settings = { ...state.settings, ...savedSettings };
        
        applyTheme();
        
        generateBtn.addEventListener('click', () => fetchNotionContent(false));
        previewBtn.addEventListener('click', () => fetchNotionContent(true));
        themeToggleBtn.addEventListener('click', () => applyTheme(true));
        settingsToggleBtn.addEventListener('click', () => toggleSettingsPanel(!settingsPanel.classList.contains('open')));
        closeSettingsBtn.addEventListener('click', () => toggleSettingsPanel(false));
        historyToggleBtn.addEventListener('click', () => toggleHistorySidebar(!historySidebar.classList.contains('open')));
        closeHistoryBtn.addEventListener('click', () => toggleHistorySidebar(false));
        calloutsToggleBtn.addEventListener('click', () => toggleCalloutsSidebar(!calloutsSidebar.classList.contains('open')));
        closeCalloutsBtn.addEventListener('click', () => toggleCalloutsSidebar(false));
        homeBtn.addEventListener('click', () => showView('setup'));
        autoScrollToggleBtn.addEventListener('click', toggleAutoScroll);
        overlay.addEventListener('click', closeAllSidebars);
        
        slidesContainer.addEventListener('scroll', updateFooterInfo);
        slidesContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
        slidesContainer.addEventListener('touchmove', handleTouchMove, { passive: true });
        slidesContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
        
        document.querySelector('.settings-panel-content').addEventListener('click', handleSettingChange);
        timerPlayPauseBtn.addEventListener('click', toggleTimer);
        nextBtn.addEventListener('click', goToNextSlide);
        prevBtn.addEventListener('click', goToPrevSlide);
        
        // FIX: Added event listener for history/navigation clicks
        historyList.addEventListener('click', e => {
            const button = e.target.closest('.history-item');
            if (button && button.dataset.index) {
                goToSlide(parseInt(button.dataset.index));
            }
        });

        wpmIncreaseBtn.addEventListener('click', () => { state.settings.wpm = Math.min(state.settings.wpm + 10, 500); applySettings(); });
        wpmDecreaseBtn.addEventListener('click', () => { state.settings.wpm = Math.max(state.settings.wpm - 10, 20); applySettings(); });
        
        document.addEventListener('keydown', e => {
            if (presentationView.classList.contains('hidden')) return;
            if (e.key === 'Escape') { closeAllSidebars(); }
            if (settingsPanel.classList.contains('open') || historySidebar.classList.contains('open') || calloutsSidebar.classList.contains('open')) return;
            if (state.settings.displayMode === 'slides') {
                if (e.key === 'ArrowRight' || e.key === ' ') goToNextSlide();
                if (e.key === 'ArrowLeft') goToPrevSlide();
            }
        });

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('pageId')) { pageIdInput.value = urlParams.get('pageId'); generateBtn.click(); }
        
        applySettings();
    };
    
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

