<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    
    <!-- Meta tags para "Adicionar à Tela Inicial" (PWA) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Notion Viewer">
    <meta name="apple-mobile-web-app-title" content="Notion Viewer">
    <meta name="theme-color" content="#191919">
    <meta name="msapplication-navbutton-color" content="#191919">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-starturl" content="/">

    <!-- Manifesto do Web App e Favicons -->
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="favicon.png">
    <link rel="shortcut icon" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dark {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --header-bg: rgba(25, 25, 25, 0.8);
            --card-bg: #1e1e1e;
            --border-color: #333;
            --input-bg: #2a2a2a;
            --button-bg: #333;
            --button-hover: #444;
            --link-color: #60a5fa;
        }
        html.dark {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .header-btn:hover { background-color: var(--button-hover); }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.open { transform: translateX(0%); }
        .slide {
             display: flex;
             flex-direction: column;
             justify-content: center;
             align-items: center;
             padding: 2rem;
             text-align: center;
             height: 100%;
             width: 100%;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Estilo para versículos bíblicos destacados */
        .highlighted-verse {
            background-color: rgba(253, 224, 71, 0.7); /* Amarelo com transparência */
            color: #1f2937; /* Texto escuro para contraste */
            border-radius: 4px;
            padding: 0 4px;
            transition: background-color 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased">

    <!-- Tela Inicial -->
    <div id="home-view" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md text-center">
            <h1 class="text-4xl font-bold mb-2">Visualizador de Notas</h1>
            <p class="text-gray-600 dark:text-gray-400 mb-8">Transforme suas páginas do Notion em apresentações ou cartões de estudo.</p>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <div class="mb-4">
                    <label for="page-id-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">ID da Página do Notion</label>
                    <input type="text" id="page-id-input" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cole o ID da página aqui...">
                </div>
                <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Gerar Visualização
                </button>
                <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
        </div>
        <div id="recent-history" class="w-full max-w-md mt-8">
            <h2 class="text-xl font-semibold mb-4 text-center">Histórico Recente</h2>
            <div id="history-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- Tela de Apresentação -->
    <div id="presentation-view" class="hidden fixed inset-0 bg-gray-100 dark:bg-black">
        <!-- Header -->
        <header id="presentation-header" class="fixed top-0 left-0 right-0 z-40 flex justify-between items-center p-2 bg-gray-100/80 dark:bg-black/80 backdrop-blur-sm">
            <button id="back-to-home" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div id="page-title" class="font-semibold text-lg truncate"></div>
            <div class="flex items-center space-x-2">
                <button id="bible-sidebar-btn" class="header-btn p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.25278C12 6.25278 6.75 3 4.5 3C2.25 3 1.5 4.5 1.5 6.75C1.5 9 1.5 15.75 1.5 15.75C1.5 18 2.25 19.5 4.5 19.5C6.75 19.5 12 21.7528 12 21.7528V6.25278Z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.25278C12 6.25278 17.25 3 19.5 3C21.75 3 22.5 4.5 22.5 6.75C22.5 9 22.5 15.75 22.5 15.75C22.5 18 21.75 19.5 19.5 19.5C17.25 19.5 12 21.7528 12 21.7528V6.25278Z"></path></svg>
                </button>
                <button id="history-btn" class="header-btn p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button id="settings-btn" class="header-btn p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Conteúdo do Slide -->
        <main id="slide-container" class="w-full h-full pt-16"></main>

        <!-- Navegação -->
        <div id="slide-nav" class="fixed bottom-0 left-0 right-0 p-4 flex justify-between items-center z-30">
            <button id="prev-slide" class="p-2 rounded-full bg-gray-500/30 hover:bg-gray-500/50 text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div id="slide-counter" class="text-sm text-gray-800 dark:text-gray-200 bg-gray-200/50 dark:bg-gray-800/50 px-3 py-1 rounded-full"></div>
            <button id="next-slide" class="p-2 rounded-full bg-gray-500/30 hover:bg-gray-500/50 text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>

        <!-- Painel de Configurações -->
        <div id="settings-panel" class="sidebar fixed top-0 right-0 h-full w-full md:w-96 bg-gray-100 dark:bg-gray-800 shadow-lg z-50 p-4 flex flex-col text-gray-800 dark:text-gray-200 border-l border-gray-200 dark:border-gray-700" style="transform: translateX(100%);">
            <!-- Header do Painel -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Configurações</h2>
                <button id="close-settings" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <!-- Conteúdo das Configurações -->
            <div class="space-y-4">
                <div>
                    <label for="display-mode" class="block text-sm font-medium">Modo de Exibição</label>
                    <select id="display-mode" class="w-full p-2 mt-1 border rounded bg-gray-200 dark:bg-gray-700 dark:border-gray-600">
                        <option value="slides">Slides</option>
                        <option value="reader">Leitura Rápida</option>
                    </select>
                </div>
                <div id="wpm-setting" class="hidden">
                     <label class="block text-sm font-medium">Palavras por Minuto (PPM)</label>
                     <div class="flex items-center mt-1">
                        <button id="wpm-decrease" class="px-3 py-1 border rounded-l bg-gray-200 dark:bg-gray-700">-</button>
                        <span id="wpm-value" class="px-4 py-1 border-t border-b bg-white dark:bg-gray-800">250</span>
                        <button id="wpm-increase" class="px-3 py-1 border rounded-r bg-gray-200 dark:bg-gray-700">+</button>
                     </div>
                </div>
            </div>
        </div>
        
        <!-- Barra Lateral de Histórico -->
        <div id="history-sidebar" class="sidebar fixed top-0 right-0 h-full w-full md:w-96 bg-gray-100 dark:bg-gray-800 shadow-lg z-50 p-4 flex flex-col text-gray-800 dark:text-gray-200 border-l border-gray-200 dark:border-gray-700" style="transform: translateX(100%);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Histórico de Visualização</h2>
                <button id="close-history-sidebar" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="history-sidebar-content" class="flex-grow overflow-y-auto"></div>
        </div>

        <!-- Barra Lateral da Bíblia -->
        <div id="bible-sidebar" class="sidebar fixed top-0 left-0 h-full w-full md:w-96 bg-gray-100/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg z-50 p-4 flex flex-col text-gray-800 dark:text-gray-200 border-r border-gray-200 dark:border-gray-700" style="transform: translateX(-100%);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Bíblia</h2>
                <button id="close-bible-sidebar" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <select id="bible-version-select" class="w-full p-2 border rounded bg-gray-200 dark:bg-gray-700 dark:border-gray-600">
                    <option value="NVI">NVI</option>
                    <option value="ARA">ARA</option>
                </select>
                <select id="bible-book-select" class="w-full p-2 border rounded bg-gray-200 dark:bg-gray-700 dark:border-gray-600"></select>
                <select id="bible-chapter-select" class="w-full p-2 border rounded bg-gray-200 dark:bg-gray-700 dark:border-gray-600"></select>
            </div>
            <div id="bible-content" class="flex-grow overflow-y-auto pr-2 text-sm space-y-2">
                <!-- O conteúdo da Bíblia será inserido aqui -->
            </div>
        </div>

    </div>
    
    <div id="loader" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Elementos da UI
        const homeView = document.getElementById('home-view');
        const presentationView = document.getElementById('presentation-view');
        const pageIdInput = document.getElementById('page-id-input');
        const generateBtn = document.getElementById('generate-btn');
        const errorMessage = document.getElementById('error-message');
        const backToHomeBtn = document.getElementById('back-to-home');
        const slideContainer = document.getElementById('slide-container');
        const prevSlideBtn = document.getElementById('prev-slide');
        const nextSlideBtn = document.getElementById('next-slide');
        const slideCounter = document.getElementById('slide-counter');
        const pageTitle = document.getElementById('page-title');
        const loader = document.getElementById('loader');
        
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettingsBtn = document.getElementById('close-settings');
        const displayModeSelect = document.getElementById('display-mode');
        const wpmSetting = document.getElementById('wpm-setting');
        const wpmValue = document.getElementById('wpm-value');
        const wpmIncreaseBtn = document.getElementById('wpm-increase');
        const wpmDecreaseBtn = document.getElementById('wpm-decrease');

        const historyBtn = document.getElementById('history-btn');
        const historySidebar = document.getElementById('history-sidebar');
        const closeHistorySidebarBtn = document.getElementById('close-history-sidebar');
        const historySidebarContent = document.getElementById('history-sidebar-content');

        // Elementos da Barra da Bíblia
        const bibleSidebar = document.getElementById('bible-sidebar');
        const closeBibleSidebarBtn = document.getElementById('close-bible-sidebar');
        const bibleSidebarBtn = document.getElementById('bible-sidebar-btn');
        const bibleVersionSelect = document.getElementById('bible-version-select');
        const bibleBookSelect = document.getElementById('bible-book-select');
        const bibleChapterSelect = document.getElementById('bible-chapter-select');
        const bibleContent = document.getElementById('bible-content');

        // Estado da Aplicação
        let state = {
            slides: [],
            currentPage: null,
            currentSlide: 0,
            history: JSON.parse(localStorage.getItem('notionHistory') || '{}'),
            settings: JSON.parse(localStorage.getItem('notionSettings') || JSON.stringify({
                displayMode: 'slides',
                wpm: 250
            })),
            readerInterval: null,
        };

        const bibleEditions = {
            'NVI': './Bíblias/NVI.json',
            'ARA': './Bíblias/ARA.json'
        };
        let currentBible = [];
        let currentVersion = 'NVI';

        // --- Funções Principais ---

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function toggleLoader(show) {
            loader.classList.toggle('hidden', !show);
        }

        function extractPageId(input) {
            try {
                const url = new URL(input);
                const path = url.pathname;
                const match = path.match(/([a-f0-9]{32})/);
                if (match) return match[1];
                const parts = path.split('-');
                return parts[parts.length - 1];
            } catch (e) {
                if (input.match(/^[a-f0-9]{32}$/)) return input;
                const parts = input.split('-');
                return parts[parts.length - 1];
            }
        }

        async function fetchNotionPage(pageId) {
            toggleLoader(true);
            try {
                const response = await fetch(`/api/notion-proxy?pageId=${pageId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao buscar a página.');
                }
                const data = await response.json();
                state.currentPage = data;
                processBlocks(data.blocks);
                updateHistory(pageId, getPageTitle(data));
                renderRecentHistory(); 
                goToSlide(0);
                homeView.classList.add('hidden');
                presentationView.classList.remove('hidden');
            } catch (error) {
                showError(error.message);
                console.error(error);
            } finally {
                toggleLoader(false);
            }
        }
        
        function getPageTitle(pageData) {
            try {
                return pageData.properties.title.title[0].plain_text;
            } catch (e) {
                return "Página sem Título";
            }
        }

        function processBlocks(blocks) {
            state.slides = [];
            let currentSlideContent = '';

            function blockToHtml(block) {
                // Implementação da conversão de blocos para HTML (igual ao seu script original)
                const richTextToHtml = (richText) => richText.map(rt => {
                    let text = rt.plain_text;
                    if(rt.href) text = `<a href="${rt.href}" target="_blank" class="text-blue-400 hover:underline">${text}</a>`;
                    if(rt.annotations.bold) text = `<strong>${text}</strong>`;
                    if(rt.annotations.italic) text = `<em>${text}</em>`;
                    if(rt.annotations.strikethrough) text = `<s>${text}</s>`;
                    if(rt.annotations.code) text = `<code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-sm">${text}</code>`;
                    return text;
                }).join('');

                switch (block.type) {
                    case 'heading_1': return `<h1 class="text-4xl font-bold mb-4">${richTextToHtml(block.heading_1.rich_text)}</h1>`;
                    case 'heading_2': return `<h2 class="text-3xl font-bold mb-3">${richTextToHtml(block.heading_2.rich_text)}</h2>`;
                    case 'heading_3': return `<h3 class="text-2xl font-bold mb-2">${richTextToHtml(block.heading_3.rich_text)}</h3>`;
                    case 'paragraph': return `<p class="mb-2 max-w-prose">${richTextToHtml(block.paragraph.rich_text)}</p>`;
                    case 'bulleted_list_item':
                    case 'numbered_list_item':
                        let content = `<li>${richTextToHtml(block[block.type].rich_text)}`;
                        if (block.children) {
                            content += block.type === 'bulleted_list_item' ? '<ul>' : '<ol>';
                            content += block.children.map(child => blockToHtml(child)).join('');
                            content += block.type === 'bulleted_list_item' ? '</ul>' : '</ol>';
                        }
                        content += '</li>';
                        return content;
                    case 'quote': return `<blockquote class="border-l-4 border-gray-300 dark:border-gray-600 pl-4 my-4 italic">${richTextToHtml(block.quote.rich_text)}</blockquote>`;
                    case 'callout':
                        return `<div class="p-4 rounded-lg my-2 flex items-start gap-3 bg-gray-200 dark:bg-gray-800"><span class="text-xl">${block.callout.icon.emoji}</span><div class="flex-1">${richTextToHtml(block.callout.rich_text)}</div></div>`;
                    case 'divider': return '<hr class="my-6 border-gray-300 dark:border-gray-700">';
                    case 'image':
                        const url = block.image.type === 'external' ? block.image.external.url : block.image.file.url;
                        return `<img src="${url}" alt="Imagem do Notion" class="max-w-full max-h-[70vh] my-4 rounded-lg shadow-md mx-auto">`;
                    default: return '';
                }
            }

            blocks.forEach(block => {
                if (block.type === 'divider') {
                    if (currentSlideContent.trim()) {
                        state.slides.push(currentSlideContent);
                    }
                    currentSlideContent = '';
                } else {
                    currentSlideContent += blockToHtml(block);
                }
            });

            if (currentSlideContent.trim()) {
                state.slides.push(currentSlideContent);
            }
            if (state.slides.length === 0) {
                 state.slides.push('<div class="text-center text-gray-500">Nenhum conteúdo encontrado. Adicione um bloco de "divisor" (---) para separar os slides.</div>');
            }
        }
        
        function renderSlide(slideHtml, index) {
            state.currentSlide = index;
            slideContainer.innerHTML = `<div class="slide fade-in">${slideHtml}</div>`;
            slideCounter.textContent = `${index + 1} / ${state.slides.length}`;
            updateNavButtons();
            
            // Lógica do modo leitor
            if (state.readerInterval) clearInterval(state.readerInterval);
            if (state.settings.displayMode === 'reader') {
                const words = slideContainer.innerText.split(/\s+/).filter(Boolean);
                let wordIndex = 0;
                slideContainer.innerHTML = `<div id="reader-box" class="text-5xl font-semibold p-8"></div>`;
                const readerBox = document.getElementById('reader-box');
                
                state.readerInterval = setInterval(() => {
                    if (wordIndex < words.length) {
                        readerBox.textContent = words[wordIndex++];
                    } else {
                        clearInterval(state.readerInterval);
                    }
                }, 60000 / state.settings.wpm);
            }
        }

        const originalRenderSlide = renderSlide;
        renderSlide = (slideHtml, index) => {
            const linkedHtml = parseAndLinkVerses(slideHtml);
            originalRenderSlide(linkedHtml, index);
        };

        function goToSlide(index) {
            if (index >= 0 && index < state.slides.length) {
                renderSlide(state.slides[index], index);
            }
        }
        function goToNextSlide() { goToSlide(state.currentSlide + 1); }
        function goToPrevSlide() { goToSlide(state.currentSlide - 1); }

        function updateNavButtons() {
            prevSlideBtn.disabled = state.currentSlide === 0;
            nextSlideBtn.disabled = state.currentSlide === state.slides.length - 1;
            prevSlideBtn.classList.toggle('opacity-50', prevSlideBtn.disabled);
            nextSlideBtn.classList.toggle('opacity-50', nextSlideBtn.disabled);
        }

        // --- Funções de Histórico ---
        function updateHistory(id, title) {
            state.history[id] = { title, lastAccessed: new Date().toISOString() };
            localStorage.setItem('notionHistory', JSON.stringify(state.history));
        }

        function renderRecentHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            const sortedHistory = Object.entries(state.history).sort((a, b) => new Date(b[1].lastAccessed) - new Date(a[1].lastAccessed));
            
            if (sortedHistory.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">Nenhuma página visitada ainda.</p>';
                return;
            }

            sortedHistory.slice(0, 5).forEach(([id, data]) => {
                const item = document.createElement('button');
                item.className = 'w-full text-left p-3 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md shadow-sm transition-colors';
                item.dataset.id = id;
                item.innerHTML = `<span class="font-semibold">${data.title}</span><br><span class="text-xs text-gray-500 dark:text-gray-400">${id}</span>`;
                item.onclick = () => {
                    pageIdInput.value = id;
                    fetchNotionPage(id);
                };
                historyList.appendChild(item);
            });
        }

        function renderHistorySidebar() {
             historySidebarContent.innerHTML = '';
             const sortedHistory = Object.entries(state.history).sort((a, b) => new Date(b[1].lastAccessed) - new Date(a[1].lastAccessed));
             sortedHistory.forEach(([id, data]) => {
                const item = document.createElement('button');
                item.className = 'w-full text-left p-3 mb-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md transition-colors history-item';
                item.dataset.id = id;
                item.innerHTML = `<span class="font-semibold">${data.title}</span><br><span class="text-xs text-gray-500 dark:text-gray-400">ID: ${id}</span>`;
                item.onclick = () => fetchNotionPage(id);
                historySidebarContent.appendChild(item);
             });
        }
        
        // --- Funções da Bíblia ---
        async function loadBible(version) {
            try {
                const response = await fetch(bibleEditions[version]);
                currentBible = await response.json();
                populateBookSelect();
            } catch (error) {
                console.error('Erro ao carregar a Bíblia:', error);
                bibleContent.innerHTML = '<p>Não foi possível carregar o texto bíblico.</p>';
            }
        }

        function populateBookSelect() {
            bibleBookSelect.innerHTML = '';
            if (!currentBible || currentBible.length === 0) return;
            currentBible.forEach((book, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = book.name;
                bibleBookSelect.appendChild(option);
            });
            populateChapterSelect();
        }

        function populateChapterSelect() {
            const bookIndex = bibleBookSelect.value;
            if (!currentBible[bookIndex]) return;
            const book = currentBible[bookIndex];
            bibleChapterSelect.innerHTML = '';
            book.chapters.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Cap. ${index + 1}`;
                bibleChapterSelect.appendChild(option);
            });
            displayChapter();
        }

        function displayChapter() {
            const bookIndex = bibleBookSelect.value;
            const chapterIndex = bibleChapterSelect.value;
             if (!currentBible[bookIndex] || !currentBible[bookIndex].chapters[chapterIndex]) return;
            const chapter = currentBible[bookIndex].chapters[chapterIndex];
            bibleContent.innerHTML = chapter.map((verse, index) =>
                `<p><span class="font-bold text-blue-400 mr-2">${index + 1}</span><span id="verse-${bookIndex}-${chapterIndex}-${index}">${verse}</span></p>`
            ).join('');
        }
        
        function highlightVerse(bookIndex, chapterIndex, verseIndex) {
            const verseElement = document.getElementById(`verse-${bookIndex}-${chapterIndex}-${verseIndex}`);
            if (verseElement) {
                // Limpa destaques anteriores
                document.querySelectorAll('.highlighted-verse').forEach(el => el.classList.remove('highlighted-verse'));
                verseElement.parentElement.classList.add('highlighted-verse');
                verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function getBookAbbreviations() {
            // Mapeia abreviações para nomes completos para normalização
            const abbrevs = {};
            currentBible.forEach(book => {
                abbrevs[book.abbrev.toLowerCase().replace(/\s/g, '')] = book.name;
                abbrevs[book.name.toLowerCase().replace(/\s/g, '')] = book.name;
            });
            return abbrevs;
        }

        function parseAndLinkVerses(text) {
             if (currentBible.length === 0) return text;
            
             const bookAbbrevs = currentBible.flatMap(b => [b.abbrev.replace('.', '\\.'), b.name]);
             const bookRegexPart = `(?:\\d\\s*)?(${bookAbbrevs.join('|')})`;
            
             // Regex para capturar referências como "Jo 3.16", "1 Coríntios 13:4-7", "Gn 1.1,3,5-7"
             const verseRegex = new RegExp(`${bookRegexPart}[\\s\\.]*(\\d+)(?:[:\\.](\\d+(?:(?:,\\d+)|(?:-\\d+))*))?`, 'gi');

             return text.replace(verseRegex, (match, bookName, chapter, verses) => {
                const book = currentBible.find(b => b.name === bookName || b.abbrev === bookName);
                if (!book) return match;

                const bookIndex = currentBible.indexOf(book);
                const chapterIndex = parseInt(chapter, 10) - 1;

                const verseRanges = (verses || '1').split(',').flatMap(part => {
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(Number);
                        const range = [];
                        for (let i = start; i <= end; i++) range.push(i);
                        return range;
                    }
                    return [Number(part)];
                });
                
                const firstVerse = verseRanges[0] - 1;

                return `<a href="#" class="bible-link text-blue-400 hover:underline" data-book="${bookIndex}" data-chapter="${chapterIndex}" data-verses="${JSON.stringify(verseRanges.map(v => v - 1))}">${match}</a>`;
            });
        }
        
        // --- Funções de UI e Eventos ---
        
        function applySettings() {
            localStorage.setItem('notionSettings', JSON.stringify(state.settings));
            wpmValue.textContent = state.settings.wpm;
            wpmSetting.classList.toggle('hidden', state.settings.displayMode !== 'reader');
            slideContainer.classList.toggle('items-start', state.settings.displayMode === 'reader');
            
            if (state.slides.length > 0) {
                 goToSlide(state.currentSlide);
            }
        }

        function closeAllSidebars() {
            settingsPanel.classList.remove('open');
            historySidebar.classList.remove('open');
            bibleSidebar.classList.remove('open');
        }

        generateBtn.addEventListener('click', () => {
            const pageId = extractPageId(pageIdInput.value.trim());
            if (pageId) {
                errorMessage.classList.add('hidden');
                fetchNotionPage(pageId);
            } else {
                showError('ID da página inválido.');
            }
        });

        backToHomeBtn.addEventListener('click', () => {
            presentationView.classList.add('hidden');
            homeView.classList.remove('hidden');
            renderRecentHistory();
        });

        prevSlideBtn.addEventListener('click', goToPrevSlide);
        nextSlideBtn.addEventListener('click', goToNextSlide);

        settingsBtn.addEventListener('click', () => { closeAllSidebars(); settingsPanel.classList.add('open'); });
        closeSettingsBtn.addEventListener('click', () => settingsPanel.classList.remove('open'));

        historyBtn.addEventListener('click', () => { closeAllSidebars(); renderHistorySidebar(); historySidebar.classList.add('open'); });
        closeHistorySidebarBtn.addEventListener('click', () => historySidebar.classList.remove('open'));

        // Eventos da Bíblia
        bibleSidebarBtn.addEventListener('click', () => { closeAllSidebars(); bibleSidebar.classList.add('open'); });
        closeBibleSidebarBtn.addEventListener('click', () => bibleSidebar.classList.remove('open'));
        
        bibleVersionSelect.addEventListener('change', () => {
            currentVersion = bibleVersionSelect.value;
            loadBible(currentVersion);
        });

        bibleBookSelect.addEventListener('change', populateChapterSelect);
        bibleChapterSelect.addEventListener('change', displayChapter);

        document.body.addEventListener('click', e => {
            const link = e.target.closest('.bible-link');
            if (link) {
                e.preventDefault();
                const { book, chapter, verses } = link.dataset;
                const verseList = JSON.parse(verses);
                
                closeAllSidebars();
                bibleSidebar.classList.add('open');

                // Atualiza os selects e o conteúdo
                bibleBookSelect.value = book;
                populateChapterSelect();
                bibleChapterSelect.value = chapter;
                displayChapter();
                
                // O destaque precisa de um pequeno delay para garantir que o conteúdo foi renderizado
                setTimeout(() => {
                    document.querySelectorAll('.highlighted-verse').forEach(el => el.classList.remove('highlighted-verse'));
                    verseList.forEach(verseIndex => {
                        const verseElement = document.getElementById(`verse-${book}-${chapter}-${verseIndex}`);
                        if (verseElement) {
                             verseElement.parentElement.classList.add('highlighted-verse');
                             // Rola para o primeiro versículo da seleção
                             if (verseIndex === verseList[0]) {
                                verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                             }
                        }
                    });
                }, 100);
            }
        });


        displayModeSelect.addEventListener('change', e => { state.settings.displayMode = e.target.value; applySettings(); });
        wpmIncreaseBtn.addEventListener('click', () => { state.settings.wpm = Math.min(state.settings.wpm + 10, 500); applySettings(); });
        wpmDecreaseBtn.addEventListener('click', () => { state.settings.wpm = Math.max(state.settings.wpm - 10, 20); applySettings(); });
        
        document.addEventListener('keydown', e => {
            if (presentationView.classList.contains('hidden')) return;
            if (e.key === 'Escape') { closeAllSidebars(); }
            if (settingsPanel.classList.contains('open') || historySidebar.classList.contains('open') || bibleSidebar.classList.contains('open')) return;
            if (state.settings.displayMode === 'slides') {
                if (e.key === 'ArrowRight' || e.key === ' ') goToNextSlide();
                if (e.key === 'ArrowLeft') goToPrevSlide();
            }
        });

        // --- Inicialização ---
        function showTutorial() {
            state.currentPage = { properties: { title: { title: [{ plain_text: "Bem-vindo!" }] } } };
            state.slides = [
                `
                <h1 class="text-4xl font-bold mb-4">Bem-vindo ao Visualizador de Notas!</h1>
                <p class="max-w-prose">Este é um tutorial interativo. Use as setas para navegar.</p>
                <p class="text-sm mt-4 text-gray-500">Para começar, insira o ID de uma página do Notion na tela inicial.</p>
                `,
                `
                <h2 class="text-3xl font-bold mb-4">Nova Funcionalidade: Bíblia Integrada</h2>
                <p class="max-w-prose">Agora você pode referenciar versículos bíblicos em suas notas, e eles se tornarão links automaticamente.</p>
                <p class="max-w-prose mt-4">Clique no ícone de livro no cabeçalho para abrir a Bíblia a qualquer momento.</p>
                `,
                `
                <h2 class="text-3xl font-bold mb-4">Teste os Links da Bíblia</h2>
                <p class="max-w-prose">Clique nas referências abaixo para vê-las na barra lateral:</p>
                <ul class="list-disc mt-4 space-y-2 text-left max-w-sm mx-auto">
                    <li>Nome por extenso: <strong>João 3:16</strong></li>
                    <li>Com abreviação: <strong>Gn 1.1</strong></li>
                    <li>Intervalo de versículos: <strong>1 Coríntios 13:4-7</strong></li>
                    <li>Múltiplos versículos: <strong>Ef 6.11,12</strong></li>
                </ul>
                `
            ];
            goToSlide(0);
            pageTitle.textContent = getPageTitle(state.currentPage);
            homeView.classList.add('hidden');
            presentationView.classList.remove('hidden');
        }

        applySettings();
        const urlParams = new URLSearchParams(window.location.search);
        loadBible(currentVersion).then(() => {
             if (urlParams.has('pageId')) {
                 pageIdInput.value = urlParams.get('pageId');
                 generateBtn.click();
             } else {
                 renderRecentHistory();
                 if (Object.keys(state.history).length === 0) {
                    showTutorial();
                 }
             }
        });

    });
</script>
</body>
</html>
