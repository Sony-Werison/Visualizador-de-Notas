<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif; --font-serif: 'Lora', serif; --font-mono: 'Roboto Mono', monospace;
        }
        body { font-family: var(--font-sans); touch-action: pan-y; background-color: #111827; }
        .font-sans { font-family: var(--font-sans); }
        .font-serif { font-family: var(--font-serif); }
        .font-mono { font-family: var(--font-mono); }
        .slide-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .settings-panel { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        .settings-panel.open { transform: translateX(0); }
        #slides-container::-webkit-scrollbar { width: 8px; }
        #slides-container::-webkit-scrollbar-track { background: transparent; }
        #slides-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        .control-btn-group button.active { background-color: #3b82f6; color: white; }
        .fade-out { animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center min-h-screen">

    <div id="app" class="w-full h-screen flex flex-col">
        <!-- Tela de Configuração Inicial -->
        <div id="setup-view" class="w-full max-w-xl mx-auto my-auto bg-gray-800 p-8 rounded-xl shadow-lg space-y-6">
            <h1 class="text-3xl font-bold text-white text-center">Visualizador de Notas do Notion</h1>
            <input type="text" id="pageId" placeholder="Cole a URL da sua página aqui" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition text-white">
            <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Visualizar</button>
            <div id="error-message" class="text-red-500 text-center font-medium hidden"></div>
        </div>

        <!-- Tela de Apresentação -->
        <div id="presentation-view" class="hidden w-full h-full flex flex-col relative overflow-hidden">
            <header class="w-full p-4 flex justify-between items-center absolute top-0 left-0 z-20 bg-gradient-to-b from-black/60 to-transparent">
                <h1 id="page-title" class="text-sm font-semibold text-white truncate max-w-xs md:max-w-md"></h1>
                <div class="flex items-center gap-4">
                    <div id="main-timer-controls" class="flex items-center gap-2 p-1 bg-gray-900/50 rounded-lg">
                        <button id="timer-play-pause-btn" title="Iniciar/Pausar Tempo" class="p-1.5"></button>
                        <span id="overall-timer" class="text-lg font-mono text-white" title="Tempo total da sessão">0:00</span>
                    </div>
                    <button id="settings-toggle-btn" title="Ajustes" class="p-2 rounded-lg hover:bg-gray-700/50 transition"></button>
                </div>
            </header>

            <main id="slides-container" class="w-full h-full flex-1 flex flex-col items-center justify-center overflow-y-auto px-8 py-24 transition-all duration-300"></main>
            
            <div id="floating-play-btn-container" class="absolute inset-0 flex items-center justify-center z-10 hidden">
                <button id="floating-play-btn" class="p-4 bg-gray-900/50 rounded-full text-white"></button>
            </div>

            <footer id="footer-bar" class="w-full p-4 flex justify-between items-center absolute bottom-0 left-0 z-20 bg-gradient-to-t from-black/60 to-transparent">
                 <button id="prev-btn" title="Anterior" class="p-3 rounded-full hover:bg-gray-700/50 disabled:opacity-20 transition"></button>
                 <div id="footer-info" class="text-sm font-mono text-center"></div>
                 <button id="next-btn" title="Próximo" class="p-3 rounded-full hover:bg-gray-700/50 disabled:opacity-20 transition"></button>
            </footer>

            <aside id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-80 bg-gray-800/95 backdrop-blur-sm shadow-2xl z-30 flex flex-col">
                <div class="p-4 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-lg">Ajustes</h3>
                    <button id="close-settings-btn" title="Fechar" class="p-2"></button>
                </div>
                <div class="flex-1 p-6 space-y-6 overflow-y-auto">
                    <div>
                        <h4 class="font-semibold mb-2">Modo de Exibição</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="displayMode" data-value="slides" class="flex-1 px-2 py-1 rounded">Páginas</button>
                            <button data-setting="displayMode" data-value="scroll" class="flex-1 px-2 py-1 rounded">Rolagem</button>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Fonte</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="fontFamily" data-value="font-sans" class="flex-1 px-2 py-1 rounded">Sans</button>
                            <button data-setting="fontFamily" data-value="font-serif" class="flex-1 px-2 py-1 rounded">Serif</button>
                            <button data-setting="fontFamily" data-value="font-mono" class="flex-1 px-2 py-1 rounded">Mono</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Tamanho da Fonte</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                             <button data-setting="fontSize" data-value="-2" class="flex-1 px-2 py-1 rounded">P</button>
                             <button data-setting="fontSize" data-value="-1" class="flex-1 px-2 py-1 rounded">M</button>
                             <button data-setting="fontSize" data-value="0" class="flex-1 px-2 py-1 rounded">G</button>
                             <button data-setting="fontSize" data-value="1" class="flex-1 px-2 py-1 rounded">XG</button>
                             <button data-setting="fontSize" data-value="2" class="flex-1 px-2 py-1 rounded">2XG</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Espaçamento entre Linhas</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="lineHeight" data-value="leading-normal" class="flex-1 px-2 py-1 rounded">Simples</button>
                            <button data-setting="lineHeight" data-value="leading-relaxed" class="flex-1 px-2 py-1 rounded">1.5</button>
                            <button data-setting="lineHeight" data-value="leading-loose" class="flex-1 px-2 py-1 rounded">Duplo</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Margens</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="textWidth" data-value="max-w-xl" class="flex-1 px-2 py-1 rounded">Estreito</button>
                            <button data-setting="textWidth" data-value="max-w-3xl" class="flex-1 px-2 py-1 rounded">Normal</button>
                            <button data-setting="textWidth" data-value="max-w-5xl" class="flex-1 px-2 py-1 rounded">Solto</button>
                        </div>
                    </div>
                    <div id="teleprompter-controls" class="pt-4 border-t border-gray-700">
                        <h4 class="font-semibold mb-2">Teleprompter (PPM)</h4>
                        <div class="flex items-center justify-between">
                             <button id="wpm-decrease" class="px-3 py-1 bg-gray-700 rounded transition">-</button>
                             <span id="wpm-display" class="font-mono text-center">180</span>
                             <button id="wpm-increase" class="px-3 py-1 bg-gray-700 rounded transition">+</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <div id="loading-view" class="hidden my-auto"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mx-auto"></div></div>
    </div>

    <script>
        // --- Ícones SVG ---
        const ICONS = {
            play: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`,
            pause: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`,
            settings: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            close: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            arrowLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
            arrowRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
        };
        
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- Element Selectors ---
        const setupView = $('#setup-view'), presentationView = $('#presentation-view'), loadingView = $('#loading-view');
        const pageIdInput = $('#pageId'), generateBtn = $('#generate-btn'), errorMessage = $('#error-message');
        const pageTitle = $('#page-title'), slidesContainer = $('#slides-container');
        const prevBtn = $('#prev-btn'), nextBtn = $('#next-btn'), footerInfo = $('#footer-info'), footerBar = $('#footer-bar');
        const mainTimerControls = $('#main-timer-controls'), timerPlayPauseBtn = $('#timer-play-pause-btn'), overallTimerEl = $('#overall-timer');
        const floatingPlayBtnContainer = $('#floating-play-btn-container'), floatingPlayBtn = $('#floating-play-btn');
        const settingsPanel = $('#settings-panel'), settingsToggleBtn = $('#settings-toggle-btn'), closeSettingsBtn = $('#close-settings-btn');
        const teleprompterControls = $('#teleprompter-controls'), wpmDecreaseBtn = $('#wpm-decrease'), wpmIncreaseBtn = $('#wpm-increase'), wpmDisplay = $('#wpm-display');

        // --- State Management ---
        let state = {
            pageData: null, rawBlocks: [], slides: [], currentSlide: 0, pageTitle: '',
            isTimerRunning: false, overallTimerInterval: null, overallSeconds: 0,
            isSettingsOpen: false, isTeleprompterPlaying: false, animationFrameId: null,
            settings: {
                displayMode: 'scroll', fontFamily: 'font-sans', fontSize: 0,
                lineHeight: 'leading-relaxed', textWidth: 'max-w-3xl', wpm: 180,
            }
        };

        // --- Core Functions ---
        const extractPageId = (input) => {
            if (!input) return '';
            try {
                if (input.startsWith('http')) {
                    const url = new URL(input);
                    const pathParts = url.pathname.split('/');
                    const lastPart = pathParts[pathParts.length - 1];
                    const idFromEnd = lastPart.split('-').pop();
                    if (idFromEnd && /^[0-9a-f]{32}$/.test(idFromEnd)) return idFromEnd;
                }
                const cleanId = input.split('-').pop().replace(/[^0-9a-fA-F]/g, '');
                if (/^[0-9a-f]{32}$/.test(cleanId)) return cleanId;
            } catch (e) {}
            return '';
        }

        async function fetchNotionContent() {
            const pageId = extractPageId(pageIdInput.value.trim());
            if (!pageId) { showError("URL ou ID da Página inválido."); return; }
            showView('loading');
            try {
                const response = await fetch(`/.netlify/functions/notion-proxy?pageId=${pageId}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `Erro ${response.status}`);
                state.pageData = data.page;
                state.rawBlocks = data.blocks.results;
                const titleProperty = Object.values(state.pageData.properties).find(p => p.type === 'title');
                state.pageTitle = titleProperty ? titleProperty.title[0].plain_text : 'Sem Título';
                rebuildSlidesAndRender();
                showView('presentation');
            } catch (error) {
                showError(`Erro: ${error.message}. Verifique a URL e as permissões.`);
                showView('setup');
            }
        }

        const parseBlocksIntoSlides = (blocks) => {
            if (!blocks || blocks.length === 0) return [[]];
            if (state.settings.displayMode === 'scroll') return [blocks];
            const slides = []; let currentSlideContent = [];
            blocks.forEach(block => {
                const isHeading = block.type === 'heading_1' || block.type === 'heading_2';
                if (isHeading && currentSlideContent.length > 0) { slides.push(currentSlideContent); currentSlideContent = []; }
                currentSlideContent.push(block);
            });
            if (currentSlideContent.length > 0) slides.push(currentSlideContent);
            return slides.length > 0 ? slides : [[]];
        }

        const createHtmlFromBlock = (block) => {
            const type = block.type; const content = block[type];
            if (!content) return null;
            const processRichText = (richText) => richText ? richText.map(t => t.plain_text).join('') : '';
            let el;
            switch(type) {
                case 'heading_1': el = document.createElement('h1'); el.className = 'text-4xl font-bold text-white leading-tight'; el.textContent = processRichText(content.rich_text); break;
                case 'heading_2': el = document.createElement('h2'); el.className = 'text-3xl font-semibold text-gray-100 mt-8 leading-snug'; el.textContent = processRichText(content.rich_text); break;
                case 'heading_3': el = document.createElement('h3'); el.className = 'text-2xl font-medium text-gray-200 mt-6'; el.textContent = processRichText(content.rich_text); break;
                case 'paragraph': el = document.createElement('p'); el.innerHTML = processRichText(content.rich_text) || '&nbsp;'; break;
                case 'bulleted_list_item': case 'numbered_list_item': el = document.createElement('li'); el.className = 'ml-6'; el.textContent = `• ${processRichText(content.rich_text)}`; break;
                case 'image': el = document.createElement('img'); const url = content.type === 'external' ? content.external.url : content.file.url; el.src = url; el.className = 'max-w-full h-auto rounded-lg shadow-lg my-6 mx-auto block'; break;
                case 'divider': el = document.createElement('hr'); el.className = 'my-8 border-gray-700'; break;
                case 'quote': el = document.createElement('blockquote'); el.className = 'pl-4 border-l-4 border-gray-500 italic text-gray-400'; el.textContent = processRichText(content.rich_text); break;
                default: return null;
            }
            return el;
        }
        
        const renderCurrentSlide = () => {
            const slideData = state.slides[state.currentSlide];
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-content w-full h-full space-y-4 text-left';
            if (!slideData || slideData.length === 0) {
                wrapper.innerHTML = `<p class="text-center text-gray-400">Nenhum conteúdo.</p>`;
            } else {
                slideData.forEach(block => {
                    const el = createHtmlFromBlock(block);
                    if (el) wrapper.appendChild(el);
                });
            }
            slidesContainer.innerHTML = ''; slidesContainer.appendChild(wrapper);
            pageTitle.textContent = state.pageTitle;
            applySettings(); updateControls();
        }
        
        const rebuildSlidesAndRender = () => { state.slides = parseBlocksIntoSlides(state.rawBlocks); state.currentSlide = 0; renderCurrentSlide(); }

        // --- UI & Controls ---
        const showView = (view) => {
            [setupView, presentationView, loadingView].forEach(v => v.classList.add('hidden'));
            if (view === 'setup') { setupView.classList.remove('hidden'); stopTimer(); }
            else if (view === 'presentation') presentationView.classList.remove('hidden');
            else if (view === 'loading') loadingView.classList.remove('hidden');
        }
        const showError = (msg) => { errorMessage.textContent = msg; errorMessage.classList.remove('hidden'); }
        const goToNextSlide = () => { if (state.currentSlide < state.slides.length - 1) { state.currentSlide++; renderCurrentSlide(); } }
        const goToPrevSlide = () => { if (state.currentSlide > 0) { state.currentSlide--; renderCurrentSlide(); } }

        const updateControls = () => {
            const isScroll = state.settings.displayMode === 'scroll';
            footerBar.style.display = 'flex';
            prevBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            nextBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            floatingPlayBtnContainer.classList.toggle('hidden', !isScroll);
            if (!isScroll) {
                prevBtn.disabled = state.currentSlide === 0;
                nextBtn.disabled = state.currentSlide >= state.slides.length - 1;
                stopTeleprompter();
            }
            updateFooterInfo();
        }
        
        const countWords = (el) => (el.innerText || '').trim().split(/\s+/).filter(Boolean).length;
        const countWordsInBlock = (block) => (block[block.type]?.rich_text || []).map(t => t.plain_text).join(' ').trim().split(/\s+/).filter(Boolean).length;
        const formatTime = (s) => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;

        const updateFooterInfo = () => {
            const wpm = state.settings.wpm;
            if (state.settings.displayMode === 'scroll') {
                const totalWords = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
                footerInfo.textContent = `Leitura: ~${formatTime((totalWords / wpm) * 60)}`;
            } else {
                const wordsOnPage = countWords(slidesContainer);
                const totalWordsAll = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
                footerInfo.innerHTML = `<span>Página ${state.currentSlide + 1}/${state.slides.length}</span><span class="mx-2">&bull;</span><span>~${formatTime((wordsOnPage/wpm)*60)} de ~${formatTime((totalWordsAll/wpm)*60)}</span>`;
            }
        }
        
        // --- Settings Panel ---
        const toggleSettingsPanel = (open) => { state.isSettingsOpen = open; settingsPanel.classList.toggle('open', open); }

        const applySettings = () => {
            const content = $('.slide-content');
            if (!content) return;
            const classes = ['font-sans','font-serif','font-mono','leading-normal','leading-relaxed','leading-loose','max-w-xl','max-w-3xl','max-w-5xl'];
            content.classList.remove(...classes);
            content.classList.add(state.settings.fontFamily, state.settings.lineHeight, state.settings.textWidth);
            content.style.fontSize = `${1.125 + (state.settings.fontSize * 0.125)}rem`;
            wpmDisplay.textContent = state.settings.wpm;
            updateFooterInfo(); updateSettingsUI();
        }

        const updateSettingsUI = () => {
            for (const key in state.settings) {
                if (key === 'wpm') continue;
                $$(`[data-setting="${key}"]`).forEach(btn => btn.classList.toggle('active', btn.dataset.value == state.settings[key]));
            }
        }

        const handleSettingChange = (e) => {
            const btn = e.target.closest('button[data-setting]');
            if (!btn) return;
            const { setting, value } = btn.dataset;
            state.settings[setting] = isNaN(value) ? value : parseInt(value);
            localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings));
            if (setting === 'displayMode') rebuildSlidesAndRender(); else applySettings();
        }

        // --- Timers & Teleprompter ---
        const startTimer = () => {
            if (state.isTimerRunning) return;
            state.isTimerRunning = true;
            timerPlayPauseBtn.innerHTML = ICONS.pause;
            state.overallTimerInterval = setInterval(() => { state.overallSeconds++; overallTimerEl.textContent = formatTime(state.overallSeconds); }, 1000);
        }
        const stopTimer = () => {
            state.isTimerRunning = false;
            timerPlayPauseBtn.innerHTML = ICONS.play;
            clearInterval(state.overallTimerInterval);
        }
        const toggleTimer = () => state.isTimerRunning ? stopTimer() : startTimer();

        const startTeleprompter = () => {
            if (state.isTeleprompterPlaying) return;
            state.isTeleprompterPlaying = true;
            floatingPlayBtn.innerHTML = ICONS.pause;
            floatingPlayBtnContainer.classList.add('fade-out');
            const loop = () => {
                const scrollableHeight = slidesContainer.scrollHeight - slidesContainer.clientHeight;
                if (slidesContainer.scrollTop >= scrollableHeight) { stopTeleprompter(); return; }
                const pixelsPerMinute = (state.settings.wpm / 60) * 50; // Heurística: 1 palavra ~ 50 pixels
                slidesContainer.scrollTop += (pixelsPerMinute / 60) / 60;
                state.animationFrameId = requestAnimationFrame(loop);
            };
            state.animationFrameId = requestAnimationFrame(loop);
        }
        const stopTeleprompter = () => {
            state.isTeleprompterPlaying = false;
            floatingPlayBtn.innerHTML = ICONS.play;
            floatingPlayBtnContainer.classList.remove('fade-out', 'hidden');
            cancelAnimationFrame(state.animationFrameId);
        }
        const toggleTeleprompter = () => state.isTeleprompterPlaying ? stopTeleprompter() : startTeleprompter();

        // --- Initialization ---
        const init = () => {
            timerPlayPauseBtn.innerHTML = ICONS.play; settingsToggleBtn.innerHTML = ICONS.settings;
            closeSettingsBtn.innerHTML = ICONS.close; prevBtn.innerHTML = ICONS.arrowLeft;
            nextBtn.innerHTML = ICONS.arrowRight; floatingPlayBtn.innerHTML = ICONS.play;
            
            const savedSettings = JSON.parse(localStorage.getItem('notionViewerSettings'));
            if (savedSettings) state.settings = { ...state.settings, ...savedSettings };

            generateBtn.addEventListener('click', fetchNotionContent);
            settingsToggleBtn.addEventListener('click', () => toggleSettingsPanel(true));
            closeSettingsBtn.addEventListener('click', () => toggleSettingsPanel(false));
            settingsPanel.addEventListener('click', handleSettingChange);
            timerPlayPauseBtn.addEventListener('click', toggleTimer);
            floatingPlayBtn.addEventListener('click', toggleTeleprompter);
            nextBtn.addEventListener('click', goToNextSlide);
            prevBtn.addEventListener('click', goToPrevSlide);
            wpmIncreaseBtn.addEventListener('click', () => { state.settings.wpm += 10; applySettings(); });
            wpmDecreaseBtn.addEventListener('click', () => { if (state.settings.wpm > 20) { state.settings.wpm -= 10; applySettings(); } });
            
            document.addEventListener('keydown', e => {
                if (presentationView.classList.contains('hidden')) return;
                if (e.key === 'ArrowRight') goToNextSlide();
                if (e.key === 'ArrowLeft') goToPrevSlide();
                if (e.key === 'Escape') toggleSettingsPanel(false);
                if (e.key === ' ' && state.settings.displayMode === 'scroll') { e.preventDefault(); toggleTeleprompter(); }
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('pageId')) {
                pageIdInput.value = urlParams.get('pageId');
                generateBtn.click();
            }
            updateSettingsUI();
        }
        
        init();
    </script>
</body>
</html>

