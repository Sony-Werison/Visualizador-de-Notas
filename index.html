<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif; --font-serif: 'Lora', serif; --font-mono: 'Roboto Mono', monospace;
        }
        body { font-family: var(--font-sans); touch-action: pan-y; background-color: #191919; color: #d1d5db; overflow: hidden; }
        .font-sans { font-family: var(--font-sans); }
        .font-serif { font-family: var(--font-serif); }
        .font-mono { font-family: var(--font-mono); }
        .slide-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .settings-panel, .history-sidebar { transition: transform 0.3s ease-in-out; }
        .settings-panel { transform: translateX(100%); }
        .settings-panel.open { transform: translateX(0); }
        .history-sidebar { transform: translateX(-100%); }
        .history-sidebar.open { transform: translateX(0); }

        #slides-container::-webkit-scrollbar, #history-list::-webkit-scrollbar { width: 8px; }
        #slides-container::-webkit-scrollbar-track, #history-list::-webkit-scrollbar-track { background: transparent; }
        #slides-container::-webkit-scrollbar-thumb, #history-list::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        .control-btn-group button.active { background-color: #475569; color: white; }
        .footer-item:not(:first-child)::before {
            content: '|';
            margin: 0 0.5rem; /* mx-2 */
            color: #4b5563; /* text-gray-600 */
        }
        .history-item.active { background-color: #475569 !important; color: white !important; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <div id="app" class="w-full h-screen flex flex-col">
        <!-- Tela de Configuração Inicial -->
        <div id="setup-view" class="w-full max-w-xl mx-auto my-auto bg-gray-800 p-8 rounded-xl shadow-lg space-y-6">
            <h1 class="text-3xl font-bold text-white text-center">Visualizador de Notas do Notion</h1>
            <input type="text" id="pageId" placeholder="Cole a URL da sua página aqui" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition text-white">
            <div class="flex gap-4">
                <button id="generate-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Visualizar</button>
                <button id="preview-btn" class="flex-1 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition">Ver Prévia</button>
            </div>
            <div id="error-message" class="text-red-500 text-center font-medium hidden"></div>
        </div>

        <!-- Tela de Apresentação -->
        <div id="presentation-view" class="hidden w-full h-full flex flex-col relative overflow-hidden">
            <header class="w-full p-4 flex justify-between items-center absolute top-0 left-0 z-20 bg-[#191919]/90 backdrop-blur-sm">
                <div class="w-1/3">
                    <span id="clock" class="text-lg font-mono text-white"></span>
                </div>
                <div class="w-1/3 text-center">
                    <h1 id="page-title" class="text-sm font-semibold text-white truncate"></h1>
                </div>
                <div class="w-1/3 flex justify-end items-center gap-4">
                    <div id="main-timer-controls" class="flex items-center gap-2 p-2 bg-black/30 rounded-lg">
                        <button id="timer-play-pause-btn" title="Iniciar/Pausar Tempo" class="p-0.5"></button>
                        <span id="overall-timer" class="text-lg font-mono text-white" title="Tempo total da sessão">0:00</span>
                    </div>
                    <button id="settings-toggle-btn" title="Ajustes" class="p-2 rounded-lg bg-black/30 hover:bg-gray-700/50 transition"></button>
                </div>
            </header>

            <main id="slides-container" class="w-full h-full flex-1 flex flex-col items-center overflow-y-auto px-8 pt-24 transition-all duration-300"></main>
            
            <footer id="footer-bar" class="w-full p-4 flex justify-between items-center absolute bottom-0 left-0 z-20 bg-[#191919]/90 backdrop-blur-sm">
                <div class="w-1/3">
                    <button id="history-toggle-btn" title="Navegação / Histórico" class="hidden p-3 rounded-full bg-black/30 hover:bg-gray-700/50 transition"></button>
                </div>
                <div class="w-1/3 text-center flex justify-center items-center gap-4">
                    <div id="footer-info" class="text-sm font-mono leading-tight"></div>
                </div>
                <div class="w-1/3 flex justify-end items-center gap-2">
                    <button id="prev-btn" title="Anterior" class="p-3 rounded-full bg-black/30 hover:bg-gray-700/50 disabled:opacity-20 transition"></button>
                    <button id="next-btn" title="Próximo" class="p-3 rounded-full bg-black/30 hover:bg-gray-700/50 disabled:opacity-20 transition"></button>
                </div>
            </footer>

            <aside id="history-sidebar" class="history-sidebar fixed top-0 left-0 h-full w-80 bg-gray-800/95 backdrop-blur-sm shadow-2xl z-20 flex flex-col">
                 <div class="p-4 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-lg">Navegação</h3>
                    <button id="close-history-btn" title="Fechar" class="p-2"></button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto"></div>
            </aside>

            <aside id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-80 bg-gray-800/95 backdrop-blur-sm shadow-2xl z-30 flex flex-col">
                <div class="p-4 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-lg">Ajustes</h3>
                    <button id="close-settings-btn" title="Fechar" class="p-2"></button>
                </div>
                <div class="flex-1 p-6 space-y-6 overflow-y-auto">
                    <div>
                        <h4 class="font-semibold mb-2">Modo de Exibição</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="displayMode" data-value="slides" class="flex-1 px-2 py-1 rounded">Páginas</button>
                            <button data-setting="displayMode" data-value="scroll" class="flex-1 px-2 py-1 rounded">Rolagem</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Fonte</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="fontFamily" data-value="font-sans" class="flex-1 px-2 py-1 rounded">Sans</button>
                            <button data-setting="fontFamily" data-value="font-serif" class="flex-1 px-2 py-1 rounded">Serif</button>
                            <button data-setting="fontFamily" data-value="font-mono" class="flex-1 px-2 py-1 rounded">Mono</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Tamanho da Fonte</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                             <button data-setting="fontSize" data-value="-2" class="flex-1 px-2 py-1 rounded">P</button>
                             <button data-setting="fontSize" data-value="-1" class="flex-1 px-2 py-1 rounded">M</button>
                             <button data-setting="fontSize" data-value="0" class="flex-1 px-2 py-1 rounded">G</button>
                             <button data-setting="fontSize" data-value="1" class="flex-1 px-2 py-1 rounded">XG</button>
                             <button data-setting="fontSize" data-value="2" class="flex-1 px-2 py-1 rounded">2XG</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Espaçamento entre Linhas</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="lineHeight" data-value="leading-normal" class="flex-1 px-2 py-1 rounded">Simples</button>
                            <button data-setting="lineHeight" data-value="leading-relaxed" class="flex-1 px-2 py-1 rounded">1.5</button>
                            <button data-setting="lineHeight" data-value="leading-loose" class="flex-1 px-2 py-1 rounded">Duplo</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Margens</h4>
                        <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                            <button data-setting="textWidth" data-value="max-w-xl" class="flex-1 px-2 py-1 rounded">Estreito</button>
                            <button data-setting="textWidth" data-value="max-w-3xl" class="flex-1 px-2 py-1 rounded">Normal</button>
                            <button data-setting="textWidth" data-value="max-w-5xl" class="flex-1 px-2 py-1 rounded">Solto</button>
                        </div>
                    </div>
                    <div id="wpm-controls" class="pt-4 border-t border-gray-700">
                        <h4 class="font-semibold mb-2">Velocidade de Leitura (PPM)</h4>
                        <div class="flex items-center justify-between">
                             <button id="wpm-decrease" class="px-3 py-1 bg-gray-700 rounded transition">-</button>
                             <span id="wpm-display" class="font-mono text-center">180</span>
                             <button id="wpm-increase" class="px-3 py-1 bg-gray-700 rounded transition">+</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <div id="loading-view" class="hidden my-auto"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mx-auto"></div></div>
    </div>

    <script>
        const ICONS = {
            play: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`,
            pause: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`,
            settings: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            close: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            arrowLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
            arrowRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
            menu: `<svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`,
        };
        
        const $ = (selector) => document.querySelector(selector);
        
        const setupView = $('#setup-view'), presentationView = $('#presentation-view'), loadingView = $('#loading-view');
        const pageIdInput = $('#pageId'), generateBtn = $('#generate-btn'), previewBtn = $('#preview-btn'), errorMessage = $('#error-message');
        const clockEl = $('#clock'), pageTitle = $('#page-title'), slidesContainer = $('#slides-container');
        const prevBtn = $('#prev-btn'), nextBtn = $('#next-btn'), footerInfo = $('#footer-info');
        const timerPlayPauseBtn = $('#timer-play-pause-btn'), overallTimerEl = $('#overall-timer');
        const settingsPanel = $('#settings-panel'), settingsToggleBtn = $('#settings-toggle-btn'), closeSettingsBtn = $('#close-settings-btn');
        const wpmDecreaseBtn = $('#wpm-decrease'), wpmIncreaseBtn = $('#wpm-increase'), wpmDisplay = $('#wpm-display');
        const historySidebar = $('#history-sidebar'), historyToggleBtn = $('#history-toggle-btn'), closeHistoryBtn = $('#close-history-btn'), historyList = $('#history-list');

        let state = {
            rawBlocks: [], slides: [], currentSlide: 0, pageTitle: '',
            isTimerRunning: false, overallTimerInterval: null, overallSeconds: 0, pageSeconds: 0, 
            pageTimeHistory: {}, clockInterval: null,
            settings: {
                displayMode: 'slides', fontFamily: 'font-sans', fontSize: 0,
                lineHeight: 'leading-relaxed', textWidth: 'max-w-3xl', wpm: 180,
            }
        };

        const MOCK_DATA = {
            pageTitle: "Página de Exemplo",
            blocks: [
                { type: 'heading_1', heading_1: { rich_text: [{ plain_text: 'Bem-vindo à Pré-visualização' }] } },
                { type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Esta é uma página de exemplo para você testar as funcionalidades visuais. O texto a seguir foi expandido para demonstrar a funcionalidade de rolagem no modo "Rolagem".' }] } },
                { type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat. Duis semper. Duis arcu massa, scelerisque vitae, consequat in, pretium a, enim. Pellentesque congue. Ut in risus volutpat libero pharetra tempor. Cras vestibulum bibendum augue. Praesent egestas leo in pede. Praesent blandit odio eu enim. Pellentesque sed dui ut augue blandit sodales. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Aliquam nibh.' }] } },
                { type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Aenean quam. In scelerisque sem at dolor. Maecenas mattis. Sed convallis tristique sem. Proin ut ligula vel nunc egestas porttitor. Morbi lectus risus, iaculis vel, suscipit quis, luctus non, massa. Fusce ac turpis quis ligula lacinia aliquet. Mauris ipsum. Nulla metus metus, ullamcorper vel, tincidunt sed, euismod in, nibh. Quisque volutpat condimentum velit. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nam nec ante. Sed lacinia, urna non tincidunt mattis, tortor neque adipiscing diam, a cursus ipsum ante quis turpis. Nulla facilisi. Ut fringilla. Suspendisse potenti. Nunc feugiat mi a tellus consequat imperdiet. Vestibulum sapien. Proin quam. Etiam ultrices.' }] } },
                { type: 'heading_2', heading_2: { rich_text: [{ plain_text: 'Recursos Suportados (Página 2)' }] } },
                { type: 'bulleted_list_item', bulleted_list_item: { rich_text: [{ plain_text: 'Títulos, parágrafos e listas.' }] } },
                { type: 'paragraph', paragraph: { rich_text: [
                    { plain_text: 'Texto com ', annotations: { bold: false, italic: false, strikethrough: false, underline: false, code: false, color: 'default' } },
                    { plain_text: 'várias', annotations: { bold: true, color: 'blue' } }, { plain_text: ' ', annotations: {} },
                    { plain_text: 'formatações', annotations: { italic: true, color: 'red' } }, { plain_text: '.', annotations: {} },
                ]}},
                { type: 'callout', callout: { icon: { emoji: '💡' }, rich_text: [{ plain_text: 'Isto é um callout, ideal para destacar informações importantes.' }], color: 'gray_background' } },
                { type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Suspendisse in justo eu magna luctus suscipit. Sed lectus. Integer euismod lacus luctus magna. Quisque cursus, metus vitae pharetra auctor, sem massa mattis sem, at interdum magna augue eget diam. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Morbi lacinia molestie dui. Praesent blandit dolor. Sed non quam. In vel mi sit amet augue congue elementum. Morbi in ipsum sit amet pede facilisis laoreet. Donec lacus nunc, viverra nec, blandit vel, egestas et, augue. Vestibulum tincidunt malesuada tellus. Ut ultrices ultrices enim. Curabitur sit amet mauris. Morbi in dui quis est pulvinar ullamcorper. Nulla facilisi. Integer lacinia sollicitudin massa. Cras metus.' }] } },
                { type: 'heading_2', heading_2: { rich_text: [{ plain_text: 'Outra Página (Página 3)' }] } },
                { type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'No modo "Páginas", qualquer título de nível 1, 2 ou 3 iniciará uma nova página. Use o painel de Ajustes para alternar entre os modos de visualização.' }] } },
                { type: 'quote', quote: { rich_text: [{ plain_text: 'Citações também são formatadas para fácil leitura.' }]}},
                { type: 'paragraph', paragraph: { rich_text: [{ plain_text: 'Aliquam erat volutpat. Nunc eleifend leo vitae magna. In id erat non orci commodo lobortis. Proin neque massa, cursus ut, gravida ut, lobortis eget, lacus. Sed diam. Praesent fermentum tempor tellus. Nullam tempus. Mauris ac felis vel velit tristique imperdiet. Donec at pede. Etiam vel neque nec dui dignissim bibendum. Vivamus id enim. Phasellus neque orci, porta a, aliquet quis, semper a, massa. Phasellus purus. Pellentesque tristique imperdiet tortor. Nam euismod tellus id erat.' }] } },
            ]
        };

        const extractPageId = (input) => {
            if (!input) return ''; try { if (input.startsWith('http')) { const url = new URL(input); const pathParts = url.pathname.split('/'); const lastPart = pathParts[pathParts.length - 1]; const idFromEnd = lastPart.split('-').pop(); if (idFromEnd && /^[0-9a-f]{32}$/.test(idFromEnd)) return idFromEnd; } const cleanId = input.split('-').pop().replace(/[^0-9a-fA-F]/g, ''); if (/^[0-9a-f]{32}$/.test(cleanId)) return cleanId; } catch (e) {} return '';
        };

        async function fetchNotionContent(isPreview = false) {
            if (isPreview) {
                state.pageTitle = MOCK_DATA.pageTitle; state.rawBlocks = MOCK_DATA.blocks;
                rebuildSlidesAndRender(); showView('presentation'); return;
            }
            const pageId = extractPageId(pageIdInput.value.trim());
            if (!pageId) { showError("URL ou ID da Página inválido."); return; }
            showView('loading');
            try {
                const response = await fetch(`/.netlify/functions/notion-proxy?pageId=${pageId}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `Erro ${response.status}`);
                const titleProperty = Object.values(data.page.properties).find(p => p.type === 'title');
                state.pageTitle = titleProperty ? titleProperty.title[0].plain_text : 'Sem Título';
                state.rawBlocks = data.blocks.results;
                rebuildSlidesAndRender(); showView('presentation');
            } catch (error) { showError(`Erro: ${error.message}.`); showView('setup'); }
        }

        const parseBlocksIntoSlides = (blocks) => {
            if (!blocks || blocks.length === 0) return [[]];
            if (state.settings.displayMode === 'scroll') return [blocks];
            const slides = []; let currentSlideContent = [];
            blocks.forEach(block => {
                const isHeading = block.type === 'heading_1' || block.type === 'heading_2' || block.type === 'heading_3';
                if (isHeading && currentSlideContent.length > 0) { slides.push(currentSlideContent); currentSlideContent = []; }
                currentSlideContent.push(block);
            });
            if (currentSlideContent.length > 0) slides.push(currentSlideContent);
            return slides.length > 0 ? slides : [[]];
        };

        const processRichText = (richTextArray) => {
            if (!richTextArray) return '';
            const colorMap = {
                "gray": "text-gray-400", "brown": "text-yellow-600", "orange": "text-orange-500", "yellow": "text-yellow-400", "green": "text-green-500", "blue": "text-blue-500", "purple": "text-purple-500", "pink": "text-pink-500", "red": "text-red-500",
                "gray_background": "bg-gray-700/50 px-1 rounded", "brown_background": "bg-yellow-800/50 px-1 rounded", "orange_background": "bg-orange-800/50 px-1 rounded", "yellow_background": "bg-yellow-800/50 px-1 rounded", "green_background": "bg-green-800/50 px-1 rounded", "blue_background": "bg-blue-800/50 px-1 rounded", "purple_background": "bg-purple-800/50 px-1 rounded", "pink_background": "bg-pink-800/50 px-1 rounded", "red_background": "bg-red-800/50 px-1 rounded"
            };
            return richTextArray.map(text => {
                const annotations = text.annotations || {};
                const classList = [];
                if (annotations.bold) classList.push('font-bold');
                if (annotations.italic) classList.push('italic');
                if (annotations.strikethrough) classList.push('line-through');
                if (annotations.underline) classList.push('underline');
                if (annotations.code) classList.push('font-mono bg-gray-700/50 px-1 py-0.5 rounded text-sm');
                if (annotations.color !== 'default') classList.push(colorMap[annotations.color]);
                return `<span class="${classList.join(' ')}">${text.plain_text.replace(/\n/g, '<br>')}</span>`;
            }).join('');
        };

        const createHtmlFromBlock = (block) => {
            const type = block.type; const content = block[type]; if (!content) return null;
            let el;
            switch(type) {
                case 'heading_1': el = document.createElement('h1'); el.className = 'text-4xl font-bold text-white leading-tight'; el.innerHTML = processRichText(content.rich_text); break;
                case 'heading_2': el = document.createElement('h2'); el.className = 'text-3xl font-semibold text-gray-100 mt-8 leading-snug'; el.innerHTML = processRichText(content.rich_text); break;
                case 'heading_3': el = document.createElement('h3'); el.className = 'text-2xl font-medium text-gray-200 mt-6'; el.innerHTML = processRichText(content.rich_text); break;
                case 'paragraph': el = document.createElement('p'); el.innerHTML = processRichText(content.rich_text) || '&nbsp;'; break;
                case 'bulleted_list_item': case 'numbered_list_item': el = document.createElement('li'); el.className = 'ml-6 list-disc'; el.innerHTML = processRichText(content.rich_text); break;
                case 'image': el = document.createElement('img'); el.src = content.type === 'external' ? content.external.url : content.file.url; el.className = 'max-w-full h-auto rounded-lg shadow-lg my-6 mx-auto block'; break;
                case 'divider': el = document.createElement('hr'); el.className = 'my-8 border-gray-700'; break;
                case 'quote': el = document.createElement('blockquote'); el.className = 'pl-4 border-l-4 border-gray-500 italic text-gray-400'; el.innerHTML = processRichText(content.rich_text); break;
                case 'callout':
                    const bgColor = content.color === 'default' ? 'bg-gray-800/80' : 'bg-gray-800';
                    el = document.createElement('div'); el.className = `p-4 rounded-lg flex items-start gap-4 my-4 ${bgColor}`;
                    const icon = content.icon.emoji || 'ℹ️';
                    el.innerHTML = `<span>${icon}</span><div class="flex-1">${processRichText(content.rich_text)}</div>`;
                    break;
                default: return null;
            }
            return el;
        };
        
        const renderCurrentSlide = () => {
            const slideData = state.slides[state.currentSlide];
            const wrapper = document.createElement('div'); wrapper.className = 'slide-content w-full h-full space-y-4 text-left';
            if (!slideData || slideData.length === 0) { wrapper.innerHTML = `<p class="text-center text-gray-400">Nenhum conteúdo.</p>`;
            } else { slideData.forEach(block => { const el = createHtmlFromBlock(block); if (el) wrapper.appendChild(el); }); }
            const spacer = document.createElement('div');
            spacer.style.height = '50vh';
            wrapper.appendChild(spacer);
            slidesContainer.innerHTML = ''; slidesContainer.appendChild(wrapper); pageTitle.textContent = state.pageTitle; applySettings(); updateControls(); renderHistorySidebar();
        };
        
        const rebuildSlidesAndRender = () => { state.slides = parseBlocksIntoSlides(state.rawBlocks); state.currentSlide = 0; state.pageSeconds = 0; state.pageTimeHistory = {}; renderCurrentSlide(); };
        const showView = (view) => {
            [setupView, presentationView, loadingView].forEach(v => v.classList.add('hidden'));
            clearInterval(state.clockInterval);
            if (view === 'setup') {
                setupView.classList.remove('hidden'); stopTimer();
            } else if (view === 'presentation') {
                presentationView.classList.remove('hidden'); updateClock(); state.clockInterval = setInterval(updateClock, 1000);
            } else if (view === 'loading') {
                loadingView.classList.remove('hidden');
            }
        };
        const showError = (msg) => { errorMessage.textContent = msg; errorMessage.classList.remove('hidden'); };
        
        const recordPageTime = () => {
            if (state.isTimerRunning || state.overallSeconds > 0) {
                const currentPage = state.currentSlide;
                state.pageTimeHistory[currentPage] = (state.pageTimeHistory[currentPage] || 0) + state.pageSeconds;
            }
        };

        const goToSlide = (index) => { if(index >= 0 && index < state.slides.length) { recordPageTime(); state.currentSlide = index; state.pageSeconds = 0; renderCurrentSlide(); toggleHistorySidebar(false); }};
        const goToNextSlide = () => { if (state.currentSlide < state.slides.length - 1) { goToSlide(state.currentSlide + 1); } };
        const goToPrevSlide = () => { if (state.currentSlide > 0) { goToSlide(state.currentSlide - 1); } };

        const updateControls = () => {
            const isScroll = state.settings.displayMode === 'scroll';
            prevBtn.style.visibility = isScroll ? 'hidden' : 'visible'; nextBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            if (!isScroll) { prevBtn.disabled = state.currentSlide === 0; nextBtn.disabled = state.currentSlide >= state.slides.length - 1; }
            updateFooterInfo();
        };
        
        const countWordsInBlock = (block) => (block[block.type]?.rich_text || []).map(t => t.plain_text).join(' ').trim().split(/\s+/).filter(Boolean).length;
        const formatTime = (s) => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;

        const updateFooterInfo = () => {
            const wpm = state.settings.wpm;
            const totalWordsAll = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
            const totalTimeInSeconds = (totalWordsAll / wpm) * 60;
            
            if (state.settings.displayMode === 'scroll') {
                const { scrollTop, scrollHeight, clientHeight } = slidesContainer;
                const scrollBottom = scrollTop + clientHeight;
                const scrollPercentRead = scrollHeight > clientHeight ? Math.min(1, scrollBottom / scrollHeight) : 1;
                const remainingTimeInSeconds = totalTimeInSeconds * (1 - scrollPercentRead);
                footerInfo.innerHTML = `<div class="flex flex-nowrap justify-center items-center">
                    <span class="footer-item" title="Tempo Total Estimado">Total: ${formatTime(totalTimeInSeconds)}</span>
                    <span class="footer-item" title="Tempo Restante Estimado">Restante: ${formatTime(remainingTimeInSeconds)}</span>
                </div>`;
            } else {
                const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc + countWordsInBlock(b), 0);
                const pageTimeInSeconds = (wordsOnPage / wpm) * 60;

                const wordsFromCurrentPageOn = state.slides.slice(state.currentSlide).flat().reduce((acc, b) => acc + countWordsInBlock(b), 0);
                const remainingTimeInSeconds = (wordsFromCurrentPageOn / wpm) * 60;
                
                footerInfo.innerHTML = `<div class="flex flex-col justify-center items-center">
                    <div class="flex flex-nowrap">
                        <span class="footer-item" title="Página Atual">Pág: ${state.currentSlide + 1}/${state.slides.length}</span>
                        <span class="footer-item" title="Tempo da Página">Página: ${formatTime(pageTimeInSeconds)}</span>
                        <span class="footer-item" title="Tempo Total Estimado">Total: ${formatTime(totalTimeInSeconds)}</span>
                    </div>
                    <div title="Tempo Restante Estimado">Restante: ${formatTime(remainingTimeInSeconds)}</div>
                </div>`;
            }
        };

        const renderHistorySidebar = () => {
            const shouldShow = state.settings.displayMode === 'slides' && state.slides.length > 1;
            historyToggleBtn.classList.toggle('hidden', !shouldShow);
            if (!shouldShow) { toggleHistorySidebar(false); return; }

            historyList.innerHTML = '';
            state.slides.forEach((slide, index) => {
                const firstBlock = slide[0];
                let pageTitleText = `Página ${index + 1}`;
                const headingType = ['heading_1', 'heading_2', 'heading_3'].find(h => firstBlock && firstBlock.type === h);
                if(headingType) {
                    const richText = firstBlock[headingType].rich_text;
                    if (richText && richText.length > 0) pageTitleText = richText.map(t => t.plain_text).join('');
                }

                const wordsOnPage = slide.reduce((acc, b) => acc + countWordsInBlock(b), 0);
                const estimatedTime = formatTime((wordsOnPage / state.settings.wpm) * 60);
                const spentTimeRaw = state.pageTimeHistory[index] || 0;
                const currentSpentTime = (state.isTimerRunning && index === state.currentSlide) ? spentTimeRaw + state.pageSeconds : spentTimeRaw;
                const spentTime = (state.isTimerRunning || spentTimeRaw > 0) ? formatTime(currentSpentTime) : '...';

                const item = document.createElement('button');
                item.className = `history-item w-full text-left p-4 hover:bg-gray-700/50 transition-colors border-b border-gray-700/50 ${index === state.currentSlide ? 'active' : ''}`;
                item.dataset.index = index;
                item.innerHTML = `<div class="font-semibold text-white truncate" title="${pageTitleText}">${pageTitleText}</div>
                                  <div class="text-sm font-mono text-gray-400 mt-1">Gasto: ${spentTime} / Previsto: ${estimatedTime}</div>`;
                historyList.appendChild(item);
            });
        };
        
        const toggleHistorySidebar = (open) => historySidebar.classList.toggle('open', open);
        const toggleSettingsPanel = (open) => settingsPanel.classList.toggle('open', open);

        const applySettings = () => {
            const content = $('.slide-content'); if (!content) return;
            const classes = ['font-sans','font-serif','font-mono','leading-normal','leading-relaxed','leading-loose','max-w-xl','max-w-3xl','max-w-5xl'];
            content.classList.remove(...classes); content.classList.add(state.settings.fontFamily, state.settings.lineHeight, state.settings.textWidth);
            content.style.fontSize = `${1.125 + (state.settings.fontSize * 0.125)}rem`;
            wpmDisplay.textContent = state.settings.wpm; updateFooterInfo(); updateSettingsUI(); renderHistorySidebar();
        };

        const updateSettingsUI = () => {
            for (const key in state.settings) {
                if (key === 'wpm') continue;
                document.querySelectorAll(`[data-setting="${key}"]`).forEach(btn => btn.classList.toggle('active', btn.dataset.value == state.settings[key]));
            }
        };

        const handleSettingChange = (e) => {
            const btn = e.target.closest('button[data-setting]'); if (!btn) return;
            const { setting, value } = btn.dataset; state.settings[setting] = isNaN(value) ? value : parseInt(value);
            localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings));
            if (setting === 'displayMode') rebuildSlidesAndRender(); else applySettings();
        };
        
        const updateClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}`;
        };

        const startTimer = () => {
            if (state.isTimerRunning) return;
            state.isTimerRunning = true;
            timerPlayPauseBtn.innerHTML = ICONS.pause;
            state.pageSeconds = 0;
            state.overallTimerInterval = setInterval(() => {
                state.overallSeconds++; state.pageSeconds++;
                overallTimerEl.textContent = formatTime(state.overallSeconds);
                renderHistorySidebar();
            }, 1000);
            renderHistorySidebar();
        };

        const stopTimer = () => {
            if (!state.isTimerRunning) return;
            recordPageTime();
            state.isTimerRunning = false;
            timerPlayPauseBtn.innerHTML = ICONS.play;
            clearInterval(state.overallTimerInterval);
            renderHistorySidebar();
        };

        const toggleTimer = () => state.isTimerRunning ? stopTimer() : startTimer();

        // Swipe Gesture Handling
        let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
        
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchMove(e) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
        }

        function handleTouchEnd() {
            if (state.settings.displayMode !== 'slides') return;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) { // Horizontal swipe
                if (deltaX < 0) { // Swipe Left
                    goToNextSlide();
                } else { // Swipe Right
                    goToPrevSlide();
                }
            }
        }


        const init = () => {
            timerPlayPauseBtn.innerHTML = ICONS.play; settingsToggleBtn.innerHTML = ICONS.settings;
            closeSettingsBtn.innerHTML = ICONS.close; prevBtn.innerHTML = ICONS.arrowLeft; nextBtn.innerHTML = ICONS.arrowRight;
            historyToggleBtn.innerHTML = ICONS.menu; closeHistoryBtn.innerHTML = ICONS.close;
            
            const savedSettings = JSON.parse(localStorage.getItem('notionViewerSettings'));
            if (savedSettings) state.settings = { ...state.settings, ...savedSettings };

            generateBtn.addEventListener('click', () => fetchNotionContent(false));
            previewBtn.addEventListener('click', () => fetchNotionContent(true));
            settingsToggleBtn.addEventListener('click', () => toggleSettingsPanel(true));
            closeSettingsBtn.addEventListener('click', () => toggleSettingsPanel(false));
            historyToggleBtn.addEventListener('click', () => toggleHistorySidebar(true));
            closeHistoryBtn.addEventListener('click', () => toggleHistorySidebar(false));
            historyList.addEventListener('click', (e) => {
                const item = e.target.closest('.history-item');
                if(item) goToSlide(parseInt(item.dataset.index));
            });

            slidesContainer.addEventListener('scroll', updateFooterInfo);
            slidesContainer.addEventListener('touchstart', handleTouchStart, false);
            slidesContainer.addEventListener('touchmove', handleTouchMove, false);
            slidesContainer.addEventListener('touchend', handleTouchEnd, false);
            settingsPanel.addEventListener('click', handleSettingChange);
            timerPlayPauseBtn.addEventListener('click', toggleTimer);
            nextBtn.addEventListener('click', goToNextSlide);
            prevBtn.addEventListener('click', goToPrevSlide);
            wpmIncreaseBtn.addEventListener('click', () => { state.settings.wpm = Math.min(state.settings.wpm + 10, 500); applySettings(); });
            wpmDecreaseBtn.addEventListener('click', () => { state.settings.wpm = Math.max(state.settings.wpm - 10, 20); applySettings(); });
            
            document.addEventListener('keydown', e => {
                if (presentationView.classList.contains('hidden')) return;
                if (e.key === 'ArrowRight') goToNextSlide();
                if (e.key === 'ArrowLeft') goToPrevSlide();
                if (e.key === 'Escape') {
                    toggleSettingsPanel(false);
                    toggleHistorySidebar(false);
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('pageId')) { pageIdInput.value = urlParams.get('pageId'); generateBtn.click(); }
            updateSettingsUI();
        };
        
        init();
    </script>
</body>
</html>

