<!DOCTYPE html>
<html lang="pt-BR" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    <!-- Meta tags para "Adicionar à Tela Inicial" (PWA) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Notion Viewer">
    <meta name="apple-mobile-web-app-title" content="Notion Viewer">
    <meta name="theme-color" content="#191919">
    <meta name="msapplication-navbutton-color" content="#191919">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-starturl" content="/">
    <!-- Manifesto do Web App e Favicons -->
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon"
        href="https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/95f7d88494945691deb8f5fe339eaad080b56f19/favicon.png">
    <link rel="shortcut icon"
        href="https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/95f7d88494945691deb8f5fe339eaad080b56f19/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@400;500;700&family=Merriweather:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-serif: 'Merriweather', serif;
            --font-display: 'Poppins', sans-serif;
            /* Variável para a altura real da viewport */
            --app-height: 100vh;
        }

        body {
            font-family: var(--font-sans);
            touch-action: pan-y;
            overflow: hidden;
        }

        #app {
            height: var(--app-height);
        }

        /* Usa a altura real */
        .font-sans {
            font-family: var(--font-sans);
        }

        .font-serif {
            font-family: var(--font-serif);
        }

        .font-display {
            font-family: var(--font-display);
        }

        .leading-extra {
            line-height: 2.5 !important;
        }

        .slide-content {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .settings-panel,
        .history-sidebar,
        #bible-sidebar {
            transition: transform 0.3s ease-in-out;
        }

        .settings-panel {
            transform: translateX(100%);
        }

        .settings-panel.open {
            transform: translateX(0);
        }

        .history-sidebar,
        #bible-sidebar {
            transform: translateX(-100%);
        }

        .history-sidebar.open,
        #bible-sidebar.open {
            transform: translateX(0);
        }

        #slides-container::-webkit-scrollbar,
        #history-list::-webkit-scrollbar,
        .settings-panel-content::-webkit-scrollbar,
        #bible-verses::-webkit-scrollbar {
            width: 8px;
        }

        #slides-container::-webkit-scrollbar-track,
        #history-list::-webkit-scrollbar-track,
        .settings-panel-content::-webkit-scrollbar-track,
        #bible-verses::-webkit-scrollbar-track {
            background: transparent;
        }

        #slides-container::-webkit-scrollbar-thumb,
        #history-list::-webkit-scrollbar-thumb,
        .settings-panel-content::-webkit-scrollbar-thumb,
        #bible-verses::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        #doc-progress-bar,
        #page-progress-bar {
            transition: width 0.3s ease-out;
        }

        /* --- Dark Theme (Default) --- */
        html.theme-dark body {
            background-color: #191919;
            color: #d1d5db;
        }

        html.theme-dark #setup-view {
            background-color: #191919;
        }

        html.theme-dark .control-btn-group,
        html.theme-dark select {
            background-color: #374151;
        }

        html.theme-dark .control-btn-group button.active {
            background-color: #4b5563;
            color: white;
        }

        html.theme-dark .history-item.active,
        .dark .callout-item.active {
            background-color: #475569 !important;
            color: white !important;
        }

        html.theme-dark .subtext-dark {
            color: #9ca3af;
        }

        html.theme-dark header,
        html.theme-dark footer {
            background-color: rgba(25, 25, 25, 0.85);
            backdrop-filter: blur(4px);
        }

        html.theme-dark .settings-panel,
        html.theme-dark .history-sidebar,
        html.theme-dark #bible-sidebar {
            background-color: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(4px);
        }

        html.theme-dark #wpm-decrease,
        html.theme-dark #wpm-increase {
            background-color: #374151
        }

        html.theme-dark blockquote {
            border-color: #4b5563;
        }

        html.theme-dark hr {
            border-color: #374151;
        }

        html.theme-dark .progress-bar-bg {
            background-color: #374151;
        }

        html.theme-dark #history-container {
            border-color: #374151;
        }

        html.theme-dark #recent-history-list button {
            background-color: #374151;
        }

        html.theme-dark #recent-history-list button:hover {
            background-color: #4b5563;
        }

        /* Notion Colors Dark */
        html.theme-dark .notion-callout.notion-default_background {
            background-color: rgba(255, 255, 255, 0.05);
        }

        html.theme-dark .notion-callout.notion-gray_background {
            background-color: #373737;
        }

        html.theme-dark .notion-callout.notion-brown_background {
            background-color: #4d3a2d;
        }

        html.theme-dark .notion-callout.notion-orange_background {
            background-color: #633d24;
        }

        html.theme-dark .notion-callout.notion-yellow_background {
            background-color: #614c1a;
        }

        html.theme-dark .notion-callout.notion-green_background {
            background-color: #25473c;
        }

        html.theme-dark .notion-callout.notion-blue_background {
            background-color: #203e58;
        }

        html.theme-dark .notion-callout.notion-purple_background {
            background-color: #44325e;
        }

        html.theme-dark .notion-callout.notion-pink_background {
            background-color: #5c2c40;
        }

        html.theme-dark .notion-callout.notion-red_background {
            background-color: #693130;
        }

        /* --- Light Theme Styles --- */
        html.theme-light body {
            background-color: #f9fafb;
            color: #111827;
        }

        html.theme-light #setup-view {
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        html.theme-light h1,
        html.theme-light h2,
        html.theme-light h3,
        html.theme-light h4,
        html.theme-light #page-title {
            color: #111827;
        }

        html.theme-light input#pageId {
            background-color: #f3f4f6;
            color: #111827;
            border-color: #d1d5db;
        }

        html.theme-light header,
        html.theme-light footer {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
        }

        html.theme-light #clock,
        html.theme-light #overall-timer,
        html.theme-light #footer-info {
            color: #1f2937;
        }

        html.theme-light .header-btn,
        html.theme-light .footer-btn {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        html.theme-light .settings-panel,
        html.theme-light .history-sidebar,
        html.theme-light #bible-sidebar {
            background-color: rgba(249, 250, 251, 0.95);
            backdrop-filter: blur(4px);
        }

        html.theme-light .control-btn-group,
        html.theme-light select {
            background-color: #e5e7eb;
        }

        html.theme-light .control-btn-group button.active {
            background-color: #ffffff;
            color: #111827;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        html.theme-light .history-item.active,
        html.theme-light .callout-item.active {
            background-color: #dbeafe !important;
            color: #1e40af !important;
        }

        html.theme-light .history-item.active .text-gray-400,
        html.theme-light .history-item.active .subtext-light,
        html.theme-light .callout-item.active .text-gray-400 {
            color: #1e3a8a !important;
        }

        html.theme-light .history-item .text-gray-400,
        html.theme-light .callout-item .text-gray-400 {
            color: #6b7280;
        }

        html.theme-light .history-item .font-semibold,
        html.theme-light .callout-item .font-semibold {
            color: #111827;
        }

        html.theme-light blockquote {
            color: #374151;
            border-color: #d1d5db;
        }

        html.theme-light hr {
            border-color: #e5e7eb;
        }

        html.theme-light .border-b {
            border-color: #e5e7eb;
        }

        html.theme-light #slides-container::-webkit-scrollbar-thumb,
        html.theme-light #history-list::-webkit-scrollbar-thumb,
        html.theme-light .settings-panel-content::-webkit-scrollbar-thumb,
        html.theme-light #bible-verses::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
        }

        html.theme-light #wpm-decrease,
        html.theme-light #wpm-increase {
            background-color: #e5e7eb
        }

        html.theme-light .progress-bar-bg {
            background-color: #e5e7eb;
        }

        html.theme-light #history-container {
            border-color: #e5e7eb;
        }

        html.theme-light #recent-history-list button {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        html.theme-light #recent-history-list button:hover {
            background-color: #e5e7eb;
        }

        /* Notion Colors Light */
        html.theme-light .notion-callout.notion-default_background {
            background-color: #f3f4f6;
        }

        html.theme-light .notion-callout.notion-gray_background {
            background-color: #e5e7eb;
        }

        html.theme-light .notion-callout.notion-brown_background {
            background-color: #fef3e5;
        }

        html.theme-light .notion-callout.notion-orange_background {
            background-color: #feefe5;
        }

        html.theme-light .notion-callout.notion-yellow_background {
            background-color: #fff9e2;
        }

        html.theme-light .notion-callout.notion-green_background {
            background-color: #e5f7f3;
        }

        html.theme-light .notion-callout.notion-blue_background {
            background-color: #e4f3ff;
        }

        html.theme-light .notion-callout.notion-purple_background {
            background-color: #f4f0ff;
        }

        html.theme-light .notion-callout.notion-pink_background {
            background-color: #fff0f7;
        }

        html.theme-light .notion-callout.notion-red_background {
            background-color: #fff0f0;
        }

        /* --- Sepia Theme --- */
        html.theme-sepia body {
            background-color: #f4e8d1;
            color: #5b4636;
        }

        html.theme-sepia #setup-view {
            background-color: #f4e8d1;
        }

        html.theme-sepia header,
        html.theme-sepia footer {
            background-color: rgba(244, 232, 209, 0.85);
            backdrop-filter: blur(4px);
        }

        html.theme-sepia .settings-panel,
        html.theme-sepia .history-sidebar,
        html.theme-sepia #bible-sidebar {
            background-color: rgba(229, 217, 193, 0.95);
        }

        html.theme-sepia .header-btn,
        html.theme-sepia .footer-btn,
        html.theme-sepia #wpm-decrease,
        html.theme-sepia #wpm-increase {
            background-color: #dcd1b8;
            color: #5b4636;
        }

        html.theme-sepia .control-btn-group,
        html.theme-sepia select {
            background-color: #dcd1b8;
        }

        html.theme-sepia .control-btn-group button.active {
            background-color: #c9bc9d;
        }

        html.theme-sepia hr,
        html.theme-sepia blockquote,
        html.theme-sepia #history-container,
        html.theme-sepia .border-b {
            border-color: #c9bc9d;
        }

        html.theme-sepia .progress-bar-bg {
            background-color: #dcd1b8;
        }

        html.theme-sepia #page-progress-bar {
            background-color: #8c6f56;
        }

        html.theme-sepia #doc-progress-bar {
            background-color: #6b5543;
        }

        html.theme-sepia .notion-callout.notion-default_background {
            background-color: rgba(91, 70, 54, 0.08);
        }

        html.theme-sepia #recent-history-list button {
            background-color: #dcd1b8;
            color: #5b4636;
        }

        html.theme-sepia #recent-history-list button:hover {
            background-color: #c9bc9d;
        }

        html.theme-sepia .notion-callout.notion-gray_background {
            background-color: #dcd1b8;
        }

        html.theme-sepia .notion-callout.notion-brown_background {
            background-color: #eaddc7;
        }

        html.theme-sepia .notion-callout.notion-orange_background {
            background-color: #e9dccb;
        }

        html.theme-sepia .notion-callout.notion-yellow_background {
            background-color: #e9e3c7;
        }

        html.theme-sepia .notion-callout.notion-green_background {
            background-color: #c7d2cc;
        }

        html.theme-sepia .notion-callout.notion-blue_background {
            background-color: #c7d2d9;
        }

        html.theme-sepia .notion-callout.notion-purple_background {
            background-color: #d6d2de;
        }

        html.theme-sepia .notion-callout.notion-pink_background {
            background-color: #ded2d7;
        }

        html.theme-sepia .notion-callout.notion-red_background {
            background-color: #ded2d2;
        }

        /* --- Light Green Theme --- */
        html.theme-light-green body {
            background-color: #ecfdf5;
            color: #065f46;
        }

        html.theme-light-green #setup-view {
            background-color: #ecfdf5;
        }

        html.theme-light-green header,
        html.theme-light-green footer {
            background-color: rgba(236, 253, 245, 0.85);
            backdrop-filter: blur(4px);
        }

        html.theme-light-green .settings-panel,
        html.theme-light-green .history-sidebar,
        html.theme-light-green #bible-sidebar {
            background-color: rgba(221, 250, 235, 0.95);
        }

        html.theme-light-green .header-btn,
        html.theme-light-green .footer-btn,
        html.theme-light-green #wpm-decrease,
        html.theme-light-green #wpm-increase {
            background-color: #d1fae5;
            color: #065f46;
        }

        html.theme-light-green .control-btn-group,
        html.theme-light-green select {
            background-color: #d1fae5;
        }

        html.theme-light-green .control-btn-group button.active {
            background-color: #a7f3d0;
        }

        html.theme-light-green hr,
        html.theme-light-green blockquote,
        html.theme-light-green #history-container,
        html.theme-light-green .border-b {
            border-color: #a7f3d0;
        }

        html.theme-light-green .progress-bar-bg {
            background-color: #d1fae5;
        }

        html.theme-light-green .notion-callout.notion-default_background {
            background-color: rgba(6, 95, 70, 0.08);
        }

        html.theme-light-green #recent-history-list button {
            background-color: #d1fae5;
            color: #065f46;
        }

        html.theme-light-green #recent-history-list button:hover {
            background-color: #a7f3d0;
        }

        html.theme-light-green .notion-callout.notion-gray_background {
            background-color: #d1fae5;
        }

        html.theme-light-green .notion-callout.notion-brown_background {
            background-color: #fef3c7;
        }

        html.theme-light-green .notion-callout.notion-orange_background {
            background-color: #ffedd5;
        }

        html.theme-light-green .notion-callout.notion-yellow_background {
            background-color: #fef9c3;
        }

        html.theme-light-green .notion-callout.notion-green_background {
            background-color: #d1fae5;
        }

        html.theme-light-green .notion-callout.notion-blue_background {
            background-color: #dbeafe;
        }

        html.theme-light-green .notion-callout.notion-purple_background {
            background-color: #e9d5ff;
        }

        html.theme-light-green .notion-callout.notion-pink_background {
            background-color: #fce7f3;
        }

        html.theme-light-green .notion-callout.notion-red_background {
            background-color: #fee2e2;
        }

        /* --- Light Blue Theme --- */
        html.theme-light-blue body {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }

        html.theme-light-blue #setup-view {
            background-color: #e0f2fe;
        }

        html.theme-light-blue header,
        html.theme-light-blue footer {
            background-color: rgba(224, 242, 254, 0.85);
            backdrop-filter: blur(4px);
        }

        html.theme-light-blue .settings-panel,
        html.theme-light-blue .history-sidebar,
        html.theme-light-blue #bible-sidebar {
            background-color: rgba(207, 234, 252, 0.95);
        }

        html.theme-light-blue .header-btn,
        html.theme-light-blue .footer-btn,
        html.theme-light-blue #wpm-decrease,
        html.theme-light-blue #wpm-increase {
            background-color: #bae6fd;
            color: #0c4a6e;
        }

        html.theme-light-blue .control-btn-group,
        html.theme-light-blue select {
            background-color: #bae6fd;
        }

        html.theme-light-blue .control-btn-group button.active {
            background-color: #7dd3fc;
        }

        html.theme-light-blue hr,
        html.theme-light-blue blockquote,
        html.theme-light-blue #history-container,
        html.theme-light-blue .border-b {
            border-color: #7dd3fc;
        }

        html.theme-light-blue .progress-bar-bg {
            background-color: #bae6fd;
        }

        html.theme-light-blue .notion-callout.notion-default_background {
            background-color: rgba(12, 74, 110, 0.08);
        }

        html.theme-light-blue #recent-history-list button {
            background-color: #bae6fd;
            color: #0c4a6e;
        }

        html.theme-light-blue #recent-history-list button:hover {
            background-color: #7dd3fc;
        }

        html.theme-light-blue .notion-callout.notion-gray_background {
            background-color: #bfdbfe;
        }

        html.theme-light-blue .notion-callout.notion-brown_background {
            background-color: #fde68a;
        }

        html.theme-light-blue .notion-callout.notion-orange_background {
            background-color: #fed7aa;
        }

        html.theme-light-blue .notion-callout.notion-yellow_background {
            background-color: #fef08a;
        }

        html.theme-light-blue .notion-callout.notion-green_background {
            background-color: #d1fae5;
        }

        html.theme-light-blue .notion-callout.notion-blue_background {
            background-color: #bfdbfe;
        }

        html.theme-light-blue .notion-callout.notion-purple_background {
            background-color: #e9d5ff;
        }

        html.theme-light-blue .notion-callout.notion-pink_background {
            background-color: #fce7f3;
        }

        html.theme-light-blue .notion-callout.notion-red_background {
            background-color: #fee2e2;
        }

        /* --- Text Highlight Styles --- */
        .slide-content .text-highlight {
            padding: 2px 4px;
            border-radius: 4px;
            margin: -2px -4px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .slide-content .font-bold.text-highlight {
            display: inline-block;
        }

        /* Light Theme Highlights (Vivid Colors) */
        html.theme-light .text-highlight.notion-gray_background {
            background-color: #d1d5db;
        }

        /* gray-300 */
        html.theme-light .text-highlight.notion-brown_background {
            background-color: #fed7aa;
        }

        /* orange-200 */
        html.theme-light .text-highlight.notion-orange_background {
            background-color: #ffedd5;
        }

        /* orange-100 */
        html.theme-light .text-highlight.notion-yellow_background {
            background-color: #fef08a;
        }

        /* yellow-200 */
        html.theme-light .text-highlight.notion-green_background {
            background-color: #bbf7d0;
        }

        /* green-200 */
        html.theme-light .text-highlight.notion-blue_background {
            background-color: #bfdbfe;
        }

        /* blue-200 */
        html.theme-light .text-highlight.notion-purple_background {
            background-color: #ddd6fe;
        }

        /* purple-200 */
        html.theme-light .text-highlight.notion-pink_background {
            background-color: #fbcfe8;
        }

        /* pink-200 */
        html.theme-light .text-highlight.notion-red_background {
            background-color: #fecaca;
        }

        /* red-200 */
        /* Dark Theme Highlights */
        html.theme-dark .text-highlight.notion-gray_background {
            background-color: #373737;
        }

        html.theme-dark .text-highlight.notion-brown_background {
            background-color: #4d3a2d;
        }

        html.theme-dark .text-highlight.notion-orange_background {
            background-color: #633d24;
        }

        html.theme-dark .text-highlight.notion-yellow_background {
            background-color: #614c1a;
        }

        html.theme-dark .text-highlight.notion-green_background {
            background-color: #25473c;
        }

        html.theme-dark .text-highlight.notion-blue_background {
            background-color: #203e58;
        }

        html.theme-dark .text-highlight.notion-purple_background {
            background-color: #44325e;
        }

        html.theme-dark .text-highlight.notion-pink_background {
            background-color: #5c2c40;
        }

        html.theme-dark .text-highlight.notion-red_background {
            background-color: #693130;
        }

        /* Sepia Theme Highlights */
        html.theme-sepia .text-highlight.notion-gray_background {
            background-color: rgba(91, 70, 54, 0.2);
        }

        html.theme-sepia .text-highlight.notion-brown_background {
            background-color: #d8c1ac;
        }

        html.theme-sepia .text-highlight.notion-orange_background {
            background-color: #e6c8b4;
        }

        html.theme-sepia .text-highlight.notion-yellow_background {
            background-color: #e6d9b4;
        }

        html.theme-sepia .text-highlight.notion-green_background {
            background-color: #b9d1c9;
        }

        html.theme-sepia .text-highlight.notion-blue_background {
            background-color: #b9c9d1;
        }

        html.theme-sepia .text-highlight.notion-purple_background {
            background-color: #d1c9d9;
        }

        html.theme-sepia .text-highlight.notion-pink_background {
            background-color: #d9c9cf;
        }

        html.theme-sepia .text-highlight.notion-red_background {
            background-color: #d9c9c9;
        }

        /* Light Green Theme Highlights */
        html.theme-light-green .text-highlight.notion-gray_background {
            background-color: #d1fae5;
        }

        html.theme-light-green .text-highlight.notion-brown_background {
            background-color: #fde68a;
        }

        html.theme-light-green .text-highlight.notion-orange_background {
            background-color: #fed7aa;
        }

        html.theme-light-green .text-highlight.notion-yellow_background {
            background-color: #fef08a;
        }

        html.theme-light-green .text-highlight.notion-green_background {
            background-color: #bbf7d0;
        }

        html.theme-light-green .text-highlight.notion-blue_background {
            background-color: #bfdbfe;
        }

        html.theme-light-green .text-highlight.notion-purple_background {
            background-color: #ddd6fe;
        }

        html.theme-light-green .text-highlight.notion-pink_background {
            background-color: #fbcfe8;
        }

        html.theme-light-green .text-highlight.notion-red_background {
            background-color: #fecaca;
        }

        /* Light Blue Theme Highlights */
        html.theme-light-blue .text-highlight.notion-gray_background {
            background-color: #bae6fd;
        }

        html.theme-light-blue .text-highlight.notion-brown_background {
            background-color: #fde68a;
        }

        html.theme-light-blue .text-highlight.notion-orange_background {
            background-color: #fed7aa;
        }

        html.theme-light-blue .text-highlight.notion-yellow_background {
            background-color: #fef08a;
        }

        html.theme-light-blue .text-highlight.notion-green_background {
            background-color: #bbf7d0;
        }

        html.theme-light-blue .text-highlight.notion-blue_background {
            background-color: #93c5fd;
        }

        html.theme-light-blue .text-highlight.notion-purple_background {
            background-color: #ddd6fe;
        }

        html.theme-light-blue .text-highlight.notion-pink_background {
            background-color: #fbcfe8;
        }

        html.theme-light-blue .text-highlight.notion-red_background {
            background-color: #fecaca;
        }

        /* --- Sidebar Push Effect --- */
        #presentation-view>header,
        #presentation-view>footer,
        #presentation-view>main {
            transition: margin-left 0.3s ease-in-out, margin-right 0.3s ease-in-out, width 0.3s ease-in-out;
            width: 100%;
        }

        body.history-open #presentation-view>header,
        body.history-open #presentation-view>footer,
        body.history-open #presentation-view>main {
            margin-left: 33.3333%;
            width: calc(100% - 33.3333%);
        }

        body.bible-open #presentation-view>header,
        body.bible-open #presentation-view>footer,
        body.bible-open #presentation-view>main {
            margin-left: 33.3333%;
            width: calc(100% - 33.3333%);
        }

        body.settings-open #presentation-view>header,
        body.settings-open #presentation-view>footer,
        body.settings-open #presentation-view>main {
            margin-right: 20rem;
            /* w-80 */
            width: calc(100% - 20rem);
        }

        #history-sidebar,
        #bible-sidebar {
            width: 33.3333%;
        }

        .verse.highlighted {
            /* background-color: rgba(255, 255, 0, 0.3); /* Cor padrão */
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }

        /* --- Estilos de Destaque para Versículos --- */

        /* 1. Preenchimento (Fill) */
        #bible-verses.style-fill.highlight-yellow .verse.highlighted { background-color: rgba(254, 240, 138, 0.6); }
        #bible-verses.style-fill.highlight-blue .verse.highlighted { background-color: rgba(147, 197, 253, 0.6); }
        #bible-verses.style-fill.highlight-green .verse.highlighted { background-color: rgba(134, 239, 172, 0.6); }
        #bible-verses.style-fill.highlight-pink .verse.highlighted { background-color: rgba(249, 168, 212, 0.6); }
        #bible-verses.style-fill.highlight-indigo .verse.highlighted { background-color: rgba(165, 180, 252, 0.6); }

        /* Cores de Destaque para Versículos - Correção Tema Escuro */
        html.theme-dark #bible-verses.style-fill .verse.highlighted,
        html.theme-sepia #bible-verses.style-fill .verse.highlighted {
            color: #111827; /* Texto escuro para melhor contraste */
        }
        /* Ajuste de opacidade para melhor legibilidade no tema escuro */
        html.theme-dark #bible-verses.style-fill.highlight-yellow .verse.highlighted,
        html.theme-sepia #bible-verses.style-fill.highlight-yellow .verse.highlighted { background-color: rgba(254, 240, 138, 0.8); }
        html.theme-dark #bible-verses.style-fill.highlight-blue .verse.highlighted,
        html.theme-sepia #bible-verses.style-fill.highlight-blue .verse.highlighted { background-color: rgba(147, 197, 253, 0.8); }
        html.theme-dark #bible-verses.style-fill.highlight-green .verse.highlighted,
        html.theme-sepia #bible-verses.style-fill.highlight-green .verse.highlighted { background-color: rgba(134, 239, 172, 0.8); }
        html.theme-dark #bible-verses.style-fill.highlight-pink .verse.highlighted,
        html.theme-sepia #bible-verses.style-fill.highlight-pink .verse.highlighted { background-color: rgba(249, 168, 212, 0.8); }
        html.theme-dark #bible-verses.style-fill.highlight-indigo .verse.highlighted,
        html.theme-sepia #bible-verses.style-fill.highlight-indigo .verse.highlighted { background-color: rgba(165, 180, 252, 0.8); }


        /* 2. Cor da Fonte (Font Color) */
        /* Cores para temas escuros */
        html.theme-dark #bible-verses.style-font.highlight-yellow .verse.highlighted,
        html.theme-sepia #bible-verses.style-font.highlight-yellow .verse.highlighted { color: #fef08a; }
        html.theme-dark #bible-verses.style-font.highlight-blue .verse.highlighted,
        html.theme-sepia #bible-verses.style-font.highlight-blue .verse.highlighted { color: #93c5fd; }
        html.theme-dark #bible-verses.style-font.highlight-green .verse.highlighted,
        html.theme-sepia #bible-verses.style-font.highlight-green .verse.highlighted { color: #86efac; }
        html.theme-dark #bible-verses.style-font.highlight-pink .verse.highlighted,
        html.theme-sepia #bible-verses.style-font.highlight-pink .verse.highlighted { color: #f9a8d4; }
        html.theme-dark #bible-verses.style-font.highlight-indigo .verse.highlighted,
        html.theme-sepia #bible-verses.style-font.highlight-indigo .verse.highlighted { color: #a5b4fc; }
        /* Cores para temas claros */
        html:not(.theme-dark):not(.theme-sepia) #bible-verses.style-font.highlight-yellow .verse.highlighted { color: #ca8a04; }
        html:not(.theme-dark):not(.theme-sepia) #bible-verses.style-font.highlight-blue .verse.highlighted { color: #2563eb; }
        html:not(.theme-dark):not(.theme-sepia) #bible-verses.style-font.highlight-green .verse.highlighted { color: #16a34a; }
        html:not(.theme-dark):not(.theme-sepia) #bible-verses.style-font.highlight-pink .verse.highlighted { color: #db2777; }
        html:not(.theme-dark):not(.theme-sepia) #bible-verses.style-font.highlight-indigo .verse.highlighted { color: #4f46e5; }

        /* 3. Contorno (Outline) */
        #bible-verses.style-outline .verse.highlighted {
            box-shadow: 0 0 0 2px var(--highlight-color);
        }
        #bible-verses.style-outline.highlight-yellow { --highlight-color: #facc15; }
        #bible-verses.style-outline.highlight-blue { --highlight-color: #60a5fa; }
        #bible-verses.style-outline.highlight-green { --highlight-color: #4ade80; }
        #bible-verses.style-outline.highlight-pink { --highlight-color: #f472b6; }
        #bible-verses.style-outline.highlight-indigo { --highlight-color: #818cf8; }

        .bible-ref-link {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
    </style>


</head>

<body class="flex flex-col items-center justify-center min-h-screen">
    <div id="app" class="w-full flex flex-col">
        <!-- Tela de Configuração Inicial -->
        <div id="setup-view" class="w-full h-full flex flex-col items-center justify-center">
            <div class="w-full max-w-xl mx-auto p-8 rounded-xl space-y-6">
                <h1 class="text-3xl font-bold text-center">Visualizador de Notas do Notion</h1>
                <p class="text-center text-gray-400">Cole a URL de uma página pública do Notion para começar.</p>
                <input type="text" id="pageId" placeholder="Cole a URL ou ID da sua página aqui"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                <div class="flex gap-4">
                    <button id="generate-btn"
                        class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Visualizar</button>
                    <button id="preview-btn"
                        class="flex-1 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition">Ver
                        Tutorial</button>
                </div>
                <div id="history-container" class="pt-4 border-t hidden">
                    <h3 class="text-sm font-semibold text-center text-gray-500 mb-3">Acessos Recentes</h3>
                    <div id="recent-history-list" class="space-y-2">
                        <!-- Injetado via JS -->
                    </div>
                </div>
                <div id="error-message" class="text-red-500 text-center font-medium hidden"></div>
            </div>
        </div><!-- Tela de Apresentação -->
        <div id="presentation-view" class="hidden w-full h-full flex-col relative overflow-hidden">
            <header class="w-full p-4 flex justify-between items-center fixed top-0 left-0 z-20">
                <div class="w-1/3 flex items-center gap-2">
                    <button id="home-btn" title="Voltar ao Início" class="header-btn p-2.5 rounded-lg transition"></button>
                    <span id="clock" class="text-lg font-mono"></span>
                </div>
                <div class="w-1/3 text-center">
                    <h1 id="page-title" class="text-sm font-semibold truncate"></h1>
                </div>
                <div class="w-1/3 flex justify-end items-center gap-2">
                    <button id="auto-scroll-toggle-btn" title="Rolagem Automática"
                        class="header-btn p-2.5 rounded-lg transition"></button>
                    <div id="main-timer-controls" class="header-btn flex items-center gap-2 p-2 rounded-lg">
                        <button id="timer-play-pause-btn" title="Iniciar/Pausar Tempo" class="p-0.5"></button>
                        <span id="overall-timer" class="text-lg font-mono" title="Tempo total da sessão">0:00</span>
                    </div>
                    <button id="settings-toggle-btn" title="Ajustes"
                        class="header-btn p-2.5 rounded-lg transition"></button>
                </div>
            </header>
            <main id="slides-container"
                class="w-full h-full flex-1 flex flex-col items-center overflow-y-auto px-12 pt-24 pb-24"></main>
            <footer id="footer-bar" class="w-full p-4 flex justify-between items-center fixed bottom-0 left-0 z-20">
                <div class="w-1/4 flex items-center gap-2">
                    <button id="history-toggle-btn" title="Navegação / Histórico"
                        class="footer-btn hidden p-3 rounded-full transition"></button>
                    <button id="bible-toggle-btn-footer" title="Bíblia"
                        class="footer-btn p-3 rounded-full transition"></button>
                </div>
                <div id="footer-center" class="w-1/2 px-4">
                    <!-- Conteúdo do rodapé injetado via JS -->
                </div>
                <div class="w-1/4 flex justify-end items-center gap-2">
                    <button id="prev-btn" title="Anterior"
                        class="footer-btn p-3 rounded-full disabled:opacity-20 transition"></button>
                    <button id="next-btn" title="Próximo"
                        class="footer-btn p-3 rounded-full disabled:opacity-20 transition"></button>
                </div>
            </footer>
            <aside id="history-sidebar" class="history-sidebar fixed top-0 left-0 h-full shadow-2xl z-40 flex flex-col">
                <div class="p-4 flex justify-between items-center border-b">
                    <h3 class="font-bold text-lg">Navegação</h3>
                    <button id="close-history-btn" title="Fechar" class="p-2"></button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto"></div>
            </aside>
            <aside id="bible-sidebar" class="fixed top-0 left-0 h-full shadow-2xl z-40 flex flex-col">
                <div class="p-4 flex justify-between items-center border-b">
                    <h3 class="font-bold text-lg">Bíblia</h3>
                    <button id="close-bible-btn" title="Fechar" class="p-2"></button>
                </div>
                <div class="p-2 space-y-2 border-b">
                    <select id="bible-version-select"
                        class="w-full p-2 rounded-md border-transparent focus:ring-2 focus:ring-blue-500"></select>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="bible-book-select"
                            class="w-full p-2 rounded-md border-transparent focus:ring-2 focus:ring-blue-500"></select>
                        <select id="bible-chapter-select"
                            class="w-full p-2 rounded-md border-transparent focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div id="bible-verses" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm pb-20"></div>
                <div id="bible-nav-footer" class="p-2 border-t flex justify-between items-center">
                    <button id="bible-prev-chapter-btn" title="Capítulo Anterior" class="footer-btn p-3 rounded-full disabled:opacity-20 transition"></button>
                    <button id="bible-next-chapter-btn" title="Próximo Capítulo" class="footer-btn p-3 rounded-full disabled:opacity-20 transition"></button>
                </div>
            </aside>
            <aside id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-80 shadow-2xl z-40 flex flex-col">
                <div class="p-4 flex justify-between items-center border-b">
                    <h3 class="font-bold text-lg">Ajustes</h3>
                    <button id="close-settings-btn" title="Fechar" class="p-2"></button>
                </div>
                <div class="settings-panel-content flex-1 p-6 space-y-8 overflow-y-auto">
                    <div>
                        <h4 class="font-semibold mb-3">Modo de Exibição</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="displayMode" data-value="slides"
                                class="flex-1 px-2 py-1 rounded">Páginas</button>
                            <button data-setting="displayMode" data-value="scroll"
                                class="flex-1 px-2 py-1 rounded">Rolagem</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Cor da Página</h4>
                        <div class="flex justify-around items-center p-1">
                            <button data-setting="theme" data-value="light"
                                class="theme-btn w-8 h-8 rounded-full bg-white border-2" title="Claro"></button>
                            <button data-setting="theme" data-value="dark"
                                class="theme-btn w-8 h-8 rounded-full bg-[#191919] border-2" title="Escuro"></button>
                            <button data-setting="theme" data-value="sepia"
                                class="theme-btn w-8 h-8 rounded-full bg-[#f4e8d1] border-2" title="Sépia"></button>
                            <button data-setting="theme" data-value="light-green"
                                class="theme-btn w-8 h-8 rounded-full bg-[#ecfdf5] border-2" title="Verde Claro"></button>
                            <button data-setting="theme" data-value="light-blue"
                                class="theme-btn w-8 h-8 rounded-full bg-[#e0f2fe] border-2" title="Azul Claro"></button>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-3">Versão da Bíblia Padrão</h4>
                         <select id="default-bible-version-select" data-setting="bibleVersion"
                            class="w-full p-2 rounded-md border-transparent focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Estilo de Destaque (Versículo)</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="verseHighlightStyle" data-value="fill" class="flex-1 px-2 py-1 rounded">Preencher</button>
                            <button data-setting="verseHighlightStyle" data-value="font" class="flex-1 px-2 py-1 rounded">Fonte</button>
                            <button data-setting="verseHighlightStyle" data-value="outline" class="flex-1 px-2 py-1 rounded">Contorno</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Cor de Destaque (Versículo)</h4>
                        <div class="flex justify-around items-center p-1">
                            <button data-setting="verseHighlightColor" data-value="highlight-yellow" class="theme-btn w-8 h-8 rounded-full bg-yellow-300 border-2" title="Amarelo"></button>
                            <button data-setting="verseHighlightColor" data-value="highlight-green" class="theme-btn w-8 h-8 rounded-full bg-green-300 border-2" title="Verde"></button>
                            <button data-setting="verseHighlightColor" data-value="highlight-blue" class="theme-btn w-8 h-8 rounded-full bg-blue-300 border-2" title="Azul"></button>
                            <button data-setting="verseHighlightColor" data-value="highlight-indigo" class="theme-btn w-8 h-8 rounded-full bg-indigo-300 border-2" title="Índigo"></button>
                            <button data-setting="verseHighlightColor" data-value="highlight-pink" class="theme-btn w-8 h-8 rounded-full bg-pink-300 border-2" title="Rosa"></button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Quebras de Página</h4>
                         <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="pageBreakHeadings" data-value="heading_1"
                                class="flex-1 px-2 py-1 rounded">H1</button>
                            <button data-setting="pageBreakHeadings" data-value="heading_2"
                                class="flex-1 px-2 py-1 rounded">H2</button>
                            <button data-setting="pageBreakHeadings" data-value="heading_3"
                                class="flex-1 px-2 py-1 rounded">H3</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Margens</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="textWidth" data-value="max-w-[33vw]"
                                class="flex-1 px-2 py-1 rounded">Estreito</button>
                            <button data-setting="textWidth" data-value="max-w-[66vw]"
                                class="flex-1 px-2 py-1 rounded">Normal</button>
                            <button data-setting="textWidth" data-value="max-w-full"
                                class="flex-1 px-2 py-1 rounded">Largo</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Posicionamento Horizontal</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="contentAlign" data-value="items-start"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"
                                title="Alinhar à Esquerda"></button>
                            <button data-setting="contentAlign" data-value="items-center"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"
                                title="Centralizar"></button>
                            <button data-setting="contentAlign" data-value="items-end"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"
                                title="Alinhar à Direita"></button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Alinhamento do Texto</h4>
                         <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="textAlign" data-value="text-left"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                            <button data-setting="textAlign" data-value="text-center"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                            <button data-setting="textAlign" data-value="text-right"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                            <button data-setting="textAlign" data-value="text-justify"
                                class="flex-1 px-2 py-1 rounded flex items-center justify-center"></button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Fonte</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="fontFamily" data-value="font-sans"
                                class="flex-1 px-2 py-1 rounded font-sans">Inter</button>
                            <button data-setting="fontFamily" data-value="font-serif"
                                class="flex-1 px-2 py-1 rounded font-serif">Merriweather</button>
                            <button data-setting="fontFamily" data-value="font-display"
                                class="flex-1 px-2 py-1 rounded font-display">Poppins</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Tamanho da Fonte (Texto)</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                             <button data-setting="fontSize" data-value="0" class="flex-1 px-2 py-1 rounded">P</button>
                             <button data-setting="fontSize" data-value="1" class="flex-1 px-2 py-1 rounded">M</button>
                             <button data-setting="fontSize" data-value="2" class="flex-1 px-2 py-1 rounded">G</button>
                             <button data-setting="fontSize" data-value="3" class="flex-1 px-2 py-1 rounded">XG</button>
                             <button data-setting="fontSize" data-value="4" class="flex-1 px-2 py-1 rounded">2XG</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Tamanho da Fonte (Destaques)</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="calloutFontSize" data-value="0"
                                class="flex-1 px-2 py-1 rounded">P</button>
                            <button data-setting="calloutFontSize" data-value="1"
                                class="flex-1 px-2 py-1 rounded">M</button>
                            <button data-setting="calloutFontSize" data-value="2"
                                class="flex-1 px-2 py-1 rounded">G</button>
                            <button data-setting="calloutFontSize" data-value="3"
                                class="flex-1 px-2 py-1 rounded">XG</button>
                            <button data-setting="calloutFontSize" data-value="4"
                                class="flex-1 px-2 py-1 rounded">2XG</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Tamanho da Fonte (Bíblia)</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="bibleFontSize" data-value="0"
                                class="flex-1 px-2 py-1 rounded">P</button>
                            <button data-setting="bibleFontSize" data-value="1"
                                class="flex-1 px-2 py-1 rounded">M</button>
                            <button data-setting="bibleFontSize" data-value="2"
                                class="flex-1 px-2 py-1 rounded">G</button>
                            <button data-setting="bibleFontSize" data-value="3"
                                class="flex-1 px-2 py-1 rounded">XG</button>
                            <button data-setting="bibleFontSize" data-value="4"
                                class="flex-1 px-2 py-1 rounded">2XG</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Espaçamento entre Linhas</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="lineHeight" data-value="leading-relaxed"
                                class="flex-1 px-2 py-1 rounded">Normal</button>
                            <button data-setting="lineHeight" data-value="leading-loose"
                                class="flex-1 px-2 py-1 rounded">Largo</button>
                            <button data-setting="lineHeight" data-value="leading-extra"
                                class="flex-1 px-2 py-1 rounded">Extra</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Andamento no Rodapé</h4>
                        <div class="control-btn-group flex rounded-md p-1">
                            <button data-setting="progressDisplay" data-value="time"
                                class="flex-1 px-2 py-1 rounded">Tempo</button>
                            <button data-setting="progressDisplay" data-value="percent"
                                class="flex-1 px-2 py-1 rounded">%</button>
                        </div>
                    </div>
                    <div id="wpm-controls" class="pt-4 border-t">
                        <h4 class="font-semibold mb-2">Velocidade de Leitura (PPM)</h4>
                        <p class="text-xs text-gray-400 mb-2">Isso também ajusta a velocidade da Rolagem Automática.</p>
                        <div class="flex items-center justify-between">
                            <button id="wpm-decrease" class="px-3 py-1 rounded transition">-</button>
                            <span id="wpm-display" class="font-mono text-center text-lg">180</span>
                            <button id="wpm-increase" class="px-3 py-1 rounded transition">+</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        <div id="loading-view" class="hidden w-full h-full flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400"></div>
        </div>


    </div>
    <script>
        const ICONS = {
            play: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`,
            pause: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`,
            settings: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            close: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            arrowLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
            arrowRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
            menu: `<svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`,
            sun: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
            moon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            home: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            scrollPlay: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 13l-5 5-5-5M17 6l-5 5-5-5"/></svg>`,
            scrollPause: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
            book: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
            alignLeft: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>`,
            alignCenter: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg>`,
            alignRight: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></svg>`,
            alignJustify: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg>`,
            alignHorizontalStart: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 21V3h2v18H4zm4-4V7h12v10H8z"/></svg>`,
            alignHorizontalCenter: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 21V3h2v18H2zm18 0V3h2v18h-2zM6 17V7h12v10H6z"/></svg>`,
            alignHorizontalEnd: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 21V3h2v18h-2zM4 17V7h12v10H4z"/></svg>`
        };
        const $ = (selector) => document.querySelector(selector);
        const setupView = $('#setup-view'),
            presentationView = $('#presentation-view'),
            loadingView = $('#loading-view');
        const pageIdInput = $('#pageId'),
            generateBtn = $('#generate-btn'),
            previewBtn = $('#preview-btn'),
            errorMessage = $('#error-message');
        const clockEl = $('#clock'),
            pageTitle = $('#page-title'),
            slidesContainer = $('#slides-container');
        const prevBtn = $('#prev-btn'),
            nextBtn = $('#next-btn'),
            footerCenter = $('#footer-center');
        const timerPlayPauseBtn = $('#timer-play-pause-btn'),
            overallTimerEl = $('#overall-timer');
        const settingsPanel = $('#settings-panel'),
            settingsToggleBtn = $('#settings-toggle-btn'),
            closeSettingsBtn = $('#close-settings-btn');
        const homeBtn = $('#home-btn');
        const wpmDecreaseBtn = $('#wpm-decrease'),
            wpmIncreaseBtn = $('#wpm-increase'),
            wpmDisplay = $('#wpm-display');
        const historySidebar = $('#history-sidebar'),
            historyToggleBtn = $('#history-toggle-btn'),
            closeHistoryBtn = $('#close-history-btn'),
            historyList = $('#history-list');
        const bibleSidebar = $('#bible-sidebar'),
            bibleToggleBtn = $('#bible-toggle-btn-footer'),
            closeBibleBtn = $('#close-bible-btn');
        const bibleVersionSelect = $('#bible-version-select'),
            defaultBibleVersionSelect = $('#default-bible-version-select'),
            bibleBookSelect = $('#bible-book-select'),
            bibleChapterSelect = $('#bible-chapter-select'),
            bibleVersesContainer = $('#bible-verses');
        const biblePrevChapterBtn = $('#bible-prev-chapter-btn');
        const bibleNextChapterBtn = $('#bible-next-chapter-btn');
        const autoScrollToggleBtn = $('#auto-scroll-toggle-btn');
        let state = {
            rawBlocks: [],
            slides: [],
            currentSlide: 0,
            pageTitle: '',
            isTimerRunning: false,
            overallTimerInterval: null,
            overallSeconds: 0,
            pageSeconds: 0,
            pageTimeHistory: {},
            clockInterval: null,
            isAutoScrolling: false,
            autoScrollInterval: null,
            settings: {
                theme: 'theme-dark',
                displayMode: 'slides',
                fontFamily: 'font-sans',
                fontSize: 2,
                lineHeight: 'leading-loose',
                textWidth: 'max-w-[66vw]',
                wpm: 180,
                progressDisplay: 'time',
                pageBreakHeadings: ['heading_1', 'heading_2'],
                textAlign: 'text-left',
                contentAlign: 'items-center',
                calloutFontSize: 2,
                bibleFontSize: 2,
                verseHighlightColor: 'highlight-yellow',
                verseHighlightStyle: 'fill',
                bibleVersion: 'NVI',
            },
            bible: {
                versions: {}, // Armazena os dados das bíblias carregadas. Ex: { NVI: data, ARA: data }
                currentBook: 0,
                currentChapter: 0,
            }
        };
        const MOCK_DATA = {
            pageTitle: "Tutorial Interativo",
            blocks: {
                results: [{
                    id: 'mock-1',
                    type: 'heading_1',
                    heading_1: {
                        rich_text: [{
                            plain_text: 'Bem-vindo ao Tutorial Interativo!'
                        }]
                    }
                }, {
                    id: 'mock-2',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            plain_text: 'Esta é uma página de exemplo para você explorar todas as funcionalidades do Visualizador de Notas. Vamos começar!'
                        }]
                    }
                }, {
                    id: 'mock-3',
                    type: 'callout',
                    callout: {
                        icon: {
                            emoji: '➡️'
                        },
                        rich_text: [{
                            plain_text: 'Use as setas do teclado, deslize o dedo na tela ou use os botões no rodapé para navegar entre as páginas do tutorial.'
                        }],
                        color: 'default_background'
                    }
                }, {
                    id: 'mock-h-2',
                    type: 'heading_2',
                    heading_2: {
                        rich_text: [{
                            plain_text: 'Modos de Visualização'
                        }]
                    }
                }, {
                    id: 'mock-p-1',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            plain_text: 'Existem dois modos principais. Você pode alternar entre eles no painel de Ajustes (⚙️).'
                        }]
                    }
                }, {
                    id: 'mock-p-2',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: '1. Modo Páginas (Padrão):'
                            },
                            annotations: {
                                bold: true
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' Divide o conteúdo em "slides", usando os títulos (H1, H2, H3) como pontos de quebra. Ideal para apresentações.'
                            }
                        }]
                    }
                }, {
                    id: 'mock-p-3',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: '2. Modo Rolagem:'
                            },
                            annotations: {
                                bold: true
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' Exibe todo o conteúdo como uma única página contínua, similar a um artigo. Neste modo, um botão de rolagem automática ( '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: '🔽',
                                annotations: {
                                    code: true
                                }
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' ) aparecerá no topo.'
                            }
                        }]
                    }
                }, {
                    id: 'mock-h-4',
                    type: 'heading_2',
                    heading_2: {
                        rich_text: [{
                            plain_text: 'Barra Lateral da Bíblia (📖)'
                        }]
                    }
                }, {
                    id: 'mock-p-5',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            plain_text: 'A antiga barra de Destaques agora é um poderoso navegador da Bíblia! As referências a versículos no seu texto são detectadas e transformadas em links automaticamente.'
                        }]
                    }
                }, {
                    id: 'mock-p-6',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: 'Clique nos exemplos para testar: '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'Jo 3.16'
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: '1 Coríntios 13:4-7'
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' ou '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'Rm 8:28,31'
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: '.'
                            }
                        }]
                    }
                }, {
                    id: 'mock-callout-bible',
                    type: 'callout',
                    callout: {
                        icon: {
                            emoji: '🔧'
                        },
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: 'Dica: '
                            },
                            annotations: {
                                bold: true
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'Você pode escolher sua versão preferida da Bíblia (NVI, ARA, etc.) no painel de Ajustes.'
                            }
                        }],
                        color: 'green_background'
                    }
                }, {
                    id: 'mock-h-5',
                    type: 'heading_2',
                    heading_2: {
                        rich_text: [{
                            plain_text: 'Formatação de Texto'
                        }]
                    }
                }, {
                    id: 'mock-p-8',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            plain_text: 'O visualizador é compatível com as formatações básicas do Notion.'
                        }]
                    }
                }, {
                    id: 'mock-p-11',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: 'E, claro, os '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'destaques com cor de fundo'
                            },
                            "annotations": {
                                "color": "red_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' são exibidos com o novo estilo!'
                            }
                        }]
                    }
                }, {
                    id: 'mock-p-12',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: 'Aqui estão mais exemplos: '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'cinza'
                            },
                            "annotations": {
                                "color": "gray_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'marrom'
                            },
                            "annotations": {
                                "color": "brown_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'laranja'
                            },
                            "annotations": {
                                "color": "orange_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'amarelo'
                            },
                            "annotations": {
                                "color": "yellow_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'verde'
                            },
                            "annotations": {
                                "color": "green_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'azul'
                            },
                            "annotations": {
                                "color": "blue_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ', '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'roxo'
                            },
                            "annotations": {
                                "color": "purple_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' e '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'rosa'
                            },
                            "annotations": {
                                "color": "pink_background"
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: '.'
                            }
                        }]
                    }
                }, {
                    id: 'mock-p-14',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            type: 'text',
                            text: {
                                content: 'Teste de '
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: 'negrito e destaque',
                                "annotations": {
                                    "bold": true,
                                    "color": "yellow_background"
                                }
                            }
                        }, {
                            type: 'text',
                            text: {
                                content: ' juntos.'
                            }
                        }]
                    }
                }, {
                    id: 'mock-h-7',
                    type: 'heading_1',
                    heading_1: {
                        rich_text: [{
                            plain_text: 'Pronto para Começar?'
                        }]
                    }
                }, {
                    id: 'mock-p-13',
                    type: 'paragraph',
                    paragraph: {
                        rich_text: [{
                            plain_text: 'Clique no ícone (🏠) no canto superior esquerdo para voltar à tela inicial, cole a URL de uma página pública do Notion e aproveite a leitura!'
                        }]
                    }
                }, ]
            },
            page: {
                properties: {
                    title: {
                        title: [{
                            plain_text: "Tutorial Interativo"
                        }]
                    }
                }
            }
        };
        const extractPageId = (input) => {
            if (!input) return '';
            try {
                if (input.startsWith('http')) {
                    const url = new URL(input);
                    const pathParts = url.pathname.split('/');
                    const lastPart = pathParts[pathParts.length - 1];
                    const idFromEnd = lastPart.split('-').pop();
                    if (idFromEnd && /^[0-9a-f]{32}$/.test(idFromEnd)) return idFromEnd;
                }
                const cleanId = input.split('-').pop().replace(/[^0-9a-fA-F]/g, '');
                if (/^[0-9a-f]{32}$/.test(cleanId)) return cleanId;
            } catch (e) {}
            return '';
        };
        async function fetchNotionContent(isPreview = false) {
            if (isPreview) {
                const data = MOCK_DATA;
                const titleProperty = Object.values(data.page.properties).find(p => p.type === 'title');
                state.pageTitle = titleProperty ? titleProperty.title[0].plain_text : 'Tutorial Interativo';
                state.rawBlocks = data.blocks.results;
                rebuildSlidesAndRender();
                showView('presentation');
                toggleSettingsPanel(true);
                return;
            }
            const pageId = extractPageId(pageIdInput.value.trim());
            if (!pageId) {
                showError("URL ou ID da Página inválido.");
                return;
            }
            showView('loading');
            try {
                const response = await fetch(`/api/notion-proxy?pageId=${pageId}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({
                        message: `Erro HTTP ${response.status}`
                    }));
                    throw new Error(errorData.message || 'Falha ao buscar a página.');
                }
                const data = await response.json();
                const titleProperty = Object.values(data.page.properties).find(p => p.type === 'title');
                state.pageTitle = titleProperty ? titleProperty.title[0].plain_text : 'Tutorial Interativo';
                state.rawBlocks = data.blocks.results;
                saveToHistory(pageId, state.pageTitle);
                rebuildSlidesAndRender();
                showView('presentation');
            } catch (error) {
                showError(`Falha ao buscar conteúdo: ${error.message}. Verifique a URL e se a página é pública.`);
                showView('setup');
            }
        }
        const parseBlocksIntoSlides = (blocks) => {
            if (!blocks || blocks.length === 0) return [
                []
            ];
            if (state.settings.displayMode === 'scroll') {
                bibleToggleBtn.classList.remove('hidden');
                return [blocks];
            };
            const slides = [];
            let currentSlideContent = [];
            blocks.forEach(block => {
                const isHeading = state.settings.pageBreakHeadings.includes(block.type);
                if (isHeading && currentSlideContent.length > 0) {
                    slides.push(currentSlideContent);
                    currentSlideContent = [];
                }
                currentSlideContent.push(block);
            });
            if (currentSlideContent.length > 0) slides.push(currentSlideContent);
            return slides.length > 0 ? slides : [
                []
            ];
        };
        const countPotentialSlides = (blocks) => {
            if (!blocks || blocks.length === 0) return 1;
            let slideCount = 0;
            let currentSlideContent = [];
            blocks.forEach(block => {
                const isHeading = state.settings.pageBreakHeadings.includes(block.type);
                if (isHeading && currentSlideContent.length > 0) {
                    slideCount++;
                    currentSlideContent = [];
                }
                currentSlideContent.push(block);
            });
            if (currentSlideContent.length > 0) slideCount++;
            return slideCount > 0 ? slideCount : 1;
        };
        const processRichText = (richTextArray) => {
            if (!richTextArray) return '';
            const colorMap = {
                "gray": "text-gray-500",
                "brown": "text-yellow-700",
                "orange": "text-orange-600",
                "yellow": "text-yellow-600",
                "green": "text-green-600",
                "blue": "text-blue-600",
                "purple": "text-purple-600",
                "pink": "text-pink-600",
                "red": "text-red-600"
            };
            const lightColorMap = {
                "gray": "text-gray-600",
                "brown": "text-yellow-800",
                "orange": "text-orange-700",
                "yellow": "text-yellow-800",
                "green": "text-green-700",
                "blue": "text-blue-700",
                "purple": "text-purple-700",
                "pink": "text-pink-700",
                "red": "text-red-700",
            }
            let html = richTextArray.map(text => {
                const annotations = text.annotations || {};
                const classList = [];
                if (annotations.bold) classList.push('font-bold');
                if (annotations.italic) classList.push('italic');
                if (annotations.strikethrough) classList.push('line-through');
                if (annotations.underline) classList.push('underline');
                if (annotations.code) classList.push(
                    'font-mono bg-gray-200 dark:bg-gray-700/50 px-1 py-0.5 rounded text-sm text-red-500');
                if (annotations.color && annotations.color !== 'default') {
                    if (annotations.color.includes('_background')) {
                        classList.push('text-highlight', `notion-${annotations.color}`);
                    } else {
                        const isLightTheme = ['theme-light', 'theme-sepia', 'theme-light-green',
                            'theme-light-blue'
                        ].includes(state.settings.theme);
                        const finalColorMap = isLightTheme ? lightColorMap : colorMap;
                        classList.push(finalColorMap[annotations.color] || colorMap[annotations
                            .color]);
                    }
                }
                const plainText = text.plain_text || (text.text ? text.text.content : '');
                let content = plainText.replace(/\n/g, '<br>');
                if (text.href) {
                    return `<a href="${text.href}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline ${classList.join(' ')}">${content}</a>`;
                }
                return `<span class="${classList.join(' ')}">${content}</span>`;
            }).join('');
            return parseAndLinkBibleReferences(html);
        };
        const createHtmlFromBlock = (block) => {
            const type = block.type;
            const content = block[type];
            if (!content) return null;
            let el;
            switch (type) {
                case 'heading_1':
                    el = document.createElement('h1');
                    el.className = 'font-bold leading-tight';
                    el.innerHTML = processRichText(content.rich_text);
                    break;
                case 'heading_2':
                    el = document.createElement('h2');
                    el.className = 'font-semibold mt-10 leading-snug';
                    el.innerHTML = processRichText(content.rich_text);
                    break;
                case 'heading_3':
                    el = document.createElement('h3');
                    el.className = 'font-medium mt-8';
                    el.innerHTML = processRichText(content.rich_text);
                    break;
                case 'paragraph':
                    el = document.createElement('p');
                    el.innerHTML = processRichText(content.rich_text) || '&nbsp;';
                    break;
                case 'bulleted_list_item':
                case 'numbered_list_item':
                    el = document.createElement('li');
                    el.innerHTML = processRichText(content.rich_text);
                    // Lida com blocos aninhados recursivamente
                    if (block.children && block.children.length > 0) {
                        renderBlocks(block.children, el);
                    }
                    break;
                case 'image':
                    el = document.createElement('img');
                    el.src = content.type === 'external' ? content.external.url : content.file.url;
                    el.className = 'max-w-full h-auto rounded-lg shadow-lg my-6 mx-auto block';
                    break;
                case 'divider':
                    el = document.createElement('hr');
                    el.className = 'my-8';
                    break;
                case 'quote':
                    el = document.createElement('blockquote');
                    el.className = 'pl-3 border-l-4';
                    el.innerHTML = processRichText(content.rich_text);
                    break;
                case 'callout':
                    const iconHTML = content.icon ?
                        `<span class="text-xl w-6 text-center">${content.icon.emoji}</span>` : '';
                    el = document.createElement('div');
                    el.className =
                        `p-4 rounded-lg flex items-start my-4 notion-callout ${content.color ? 'notion-' + content.color : 'notion-default_background'}`;
                    el.innerHTML =
                        `${iconHTML}<div class="flex-1 ${content.icon ? 'ml-2' : ''}">${processRichText(content.rich_text)}</div>`;
                    break;
                default:
                    return null;
            }
            if (el && block.id) {
                el.id = `block-${block.id}`;
            }
            return el;
        };
        const renderCurrentSlide = () => {
            const slideData = state.slides[state.currentSlide];
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-content w-full h-full space-y-5';
            renderBlocks(slideData, wrapper); // Usa a nova função para renderizar com aninhamento
            const spacer = document.createElement('div');
            spacer.style.height = '50vh';
            wrapper.appendChild(spacer);
            slidesContainer.innerHTML = '';
            slidesContainer.appendChild(wrapper);
            pageTitle.textContent = state.pageTitle;
            applySettings();
            updateControls();
            renderHistorySidebar();
            requestAnimationFrame(() => requestAnimationFrame(updateFooterInfo));
        };
        const rebuildSlidesAndRender = () => {
            stopAutoScroll();
            const pageCount = countPotentialSlides(state.rawBlocks);
            const slidesButton = document.querySelector('[data-setting="displayMode"][data-value="slides"]');
            if (slidesButton) {
                if (pageCount <= 1) {
                    slidesButton.disabled = true;
                    slidesButton.classList.add('opacity-50', 'cursor-not-allowed');
                    state.settings.displayMode = 'scroll';
                } else {
                    slidesButton.disabled = false;
                    slidesButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            state.slides = parseBlocksIntoSlides(state.rawBlocks);
            state.currentSlide = 0;
            state.pageSeconds = 0;
            state.pageTimeHistory = {};
            renderCurrentSlide();
            slidesContainer.scrollTop = 0;
        };
        const showView = (view) => {
            // Hide all views first by adding 'hidden' and removing 'flex'
            [setupView, presentationView, loadingView].forEach(v => {
                v.classList.add('hidden');
                v.classList.remove('flex');
            });
            clearInterval(state.clockInterval);
            if (view === 'setup') {
                setupView.classList.remove('hidden');
                setupView.classList.add('flex'); // Make setup view visible and flex
                renderRecentHistory();
                stopTimer();
                stopAutoScroll();
                closeAllSidebars();
            } else if (view === 'presentation') {
                presentationView.classList.remove('hidden');
                presentationView.classList.add('flex'); // Make presentation view visible and flex
                updateClock();
                state.clockInterval = setInterval(updateClock, 1000);
            } else if (view === 'loading') {
                loadingView.classList.remove('hidden');
                loadingView.classList.add('flex'); // Make loading view visible and flex
            }
        };
        const showError = (msg) => {
            errorMessage.textContent = msg;
            errorMessage.classList.remove('hidden');
        };
        const recordPageTime = () => {
            if (state.isTimerRunning || state.overallSeconds > 0) {
                const currentPage = state.currentSlide;
                state.pageTimeHistory[currentPage] = (state.pageTimeHistory[currentPage] || 0) + state.pageSeconds;
            }
        };
        const goToSlide = (index) => {
            if (index >= 0 && index < state.slides.length) {
                recordPageTime();
                stopAutoScroll();
                state.currentSlide = index;
                state.pageSeconds = 0;
                slidesContainer.scrollTop = 0;
                renderCurrentSlide();
                toggleHistorySidebar(false);
            }
        };
        const goToNextSlide = () => {
            if (state.currentSlide < state.slides.length - 1) {
                goToSlide(state.currentSlide + 1);
            }
        };
        const goToPrevSlide = () => {
            if (state.currentSlide > 0) {
                goToSlide(state.currentSlide - 1);
            }
        };
        const updateControls = () => {
            const isScroll = state.settings.displayMode === 'scroll';
            prevBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            nextBtn.style.visibility = isScroll ? 'hidden' : 'visible';
            if (!isScroll) {
                prevBtn.disabled = state.currentSlide === 0;
                nextBtn.disabled = state.currentSlide >= state.slides.length - 1;
            }
            stopAutoScroll();
            updateFooterInfo();
        };
        const countWordsInBlock = (block) => {
            const richText = block[block.type]?.rich_text;
            if (!richText) return 0;
            return richText.map(t => t.plain_text || (t.text ? t.text.content : '')).join(' ').trim().split(
                /\s+/).filter(Boolean).length;
        };
        const formatTime = (s) => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
        const updateFooterInfo = () => {
            const wpm = state.settings.wpm;
            const totalWordsAll = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
            if (totalWordsAll === 0) {
                footerCenter.innerHTML = '';
                return;
            }
            const {
                scrollTop,
                scrollHeight,
                clientHeight
            } = slidesContainer;
            const pageBarHTML =
                `<div class="w-full rounded-full h-2 progress-bar-bg"><div id="page-progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%;"></div></div>`;
            const docBarHTML =
                `<div class="w-full rounded-full h-2 progress-bar-bg"><div id="doc-progress-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%;"></div></div>`;
            if (state.settings.displayMode === 'scroll') {
                let scrollPercent = scrollHeight > clientHeight ? (scrollTop / (scrollHeight - clientHeight)) : 1;
                scrollPercent = Math.max(0, Math.min(1, scrollPercent)); // Garante que a porcentagem esteja entre 0 e 1
                const wordsRead = totalWordsAll * scrollPercent;
                const wordsRemaining = totalWordsAll - wordsRead;
                const totalTimeInSeconds = (totalWordsAll / wpm) * 60;
                const remainingTimeInSeconds = (wordsRemaining / wpm) * 60;
                const infoHTML =
                    `<div class="text-center text-sm font-mono mb-2">Total: ${formatTime(totalTimeInSeconds)} | Restante: ${formatTime(remainingTimeInSeconds)}</div>`;
                const barHTML = `<div class="w-full">${docBarHTML}</div>`;
                footerCenter.innerHTML = infoHTML + barHTML;
                $('#doc-progress-bar').style.width = `${scrollPercent * 100}%`;
            } else { // SLIDES MODE
                const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc +
                    countWordsInBlock(b), 0);
                let pageScrollPercent = scrollHeight > clientHeight ? (scrollTop / (scrollHeight - clientHeight)) : (
                    wordsOnPage > 0 ? 1 : 0);
                pageScrollPercent = Math.max(0, Math.min(1,
                    pageScrollPercent)); // Garante que a porcentagem esteja entre 0 e 1
                const pageTimeSeconds = (wordsOnPage / wpm) * 60;
                const pageWordsRead = wordsOnPage * pageScrollPercent;
                const pageWordsRemaining = wordsOnPage - pageWordsRead;
                const pageTimeRemainingSeconds = (pageWordsRemaining / wpm) * 60;
                const wordsBeforeCurrentPage = state.slides.slice(0, state.currentSlide).flat().reduce((acc, b) =>
                    acc + countWordsInBlock(b), 0);
                const totalWordsRead = wordsBeforeCurrentPage + pageWordsRead;
                const docTimeSeconds = (totalWordsAll / wpm) * 60;
                const docTimeRemainingSeconds = (docTimeSeconds) - ((totalWordsRead / wpm) * 60);
                const docPercent = totalWordsAll > 0 ? (totalWordsRead / totalWordsAll) * 100 : 0;
                let infoHTML = '',
                    barsHTML = '';
                if (state.settings.progressDisplay === 'percent') {
                    infoHTML =
                        `<div class="flex justify-around items-center text-xs w-full mb-2"> <div class="w-1/2 text-center"><span>Página: ${state.currentSlide + 1}/${state.slides.length} | ${Math.round(pageScrollPercent * 100)}%</span></div> <div class="w-1/2 text-center"><span>Documento: ${Math.round(docPercent)}%</span></div> </div>`;
                } else { // 'time' display
                    infoHTML =
                        `<div class="flex flex-col md:flex-row justify-around text-xs w-full mb-2 gap-2 md:gap-0"> <div class="w-full md:w-1/2 text-center"> <div class="font-bold">Página (${state.currentSlide + 1}/${state.slides.length})</div> <div>Total: ${formatTime(pageTimeSeconds)} | Restante: ${formatTime(pageTimeRemainingSeconds)}</div> </div> <div class="w-full md:w-1/2 text-center"> <div class="font-bold">Documento</div> <div>Total: ${formatTime(docTimeSeconds)} | Restante: ${formatTime(docTimeRemainingSeconds)}</div> </div> </div>`;
                }
                barsHTML =
                    `<div class="w-full flex items-center justify-center gap-4"> <div class="flex-1">${pageBarHTML}</div> <div class="flex-1">${docBarHTML}</div> </div>`;
                footerCenter.innerHTML = infoHTML + barsHTML;
                $('#page-progress-bar').style.width = `${pageScrollPercent * 100}%`;
                $('#doc-progress-bar').style.width = `${docPercent}%`;
            }
        };
        const renderHistorySidebar = () => {
            const shouldShow = state.settings.displayMode === 'slides' && state.slides.length > 1;
            historyToggleBtn.classList.toggle('hidden', !shouldShow);
            if (!shouldShow) {
                toggleHistorySidebar(false);
                return;
            }
            historyList.innerHTML = '';
            state.slides.forEach((slide, index) => {
                const firstBlock = slide[0];
                let pageTitleText = `Página ${index + 1}`;
                const headingType = ['heading_1', 'heading_2', 'heading_3'].find(h => firstBlock &&
                    firstBlock.type === h);
                if (headingType) {
                    const richText = firstBlock[headingType].rich_text;
                    if (richText && richText.length > 0) pageTitleText = richText.map(t => t
                        .plain_text).join('');
                }
                const wordsOnPage = slide.reduce((acc, b) => acc + countWordsInBlock(b), 0);
                const estimatedTime = formatTime((wordsOnPage / state.settings.wpm) * 60);
                const spentTimeRaw = state.pageTimeHistory[index] || 0;
                const currentSpentTime = (state.isTimerRunning && index === state.currentSlide) ?
                    spentTimeRaw + state.pageSeconds : spentTimeRaw;
                const spentTime = (state.isTimerRunning || spentTimeRaw > 0) ? formatTime(
                    currentSpentTime) : '...';
                const item = document.createElement('button');
                item.className =
                    `history-item w-full text-left p-4 hover:bg-opacity-50 transition-colors border-b ${index === state.currentSlide ? 'active' : ''}`;
                item.dataset.index = index;
                item.innerHTML =
                    `<div class="font-semibold truncate" title="${pageTitleText}">${pageTitleText}</div> <div class="text-sm font-mono mt-1 ${document.documentElement.classList.contains('light') ? 'subtext-light' : 'text-gray-400'}">Gasto: ${spentTime} / Previsto: ${estimatedTime}</div>`;
                historyList.appendChild(item);
            });
        };
        const closeAllSidebars = () => {
            document.body.classList.remove('history-open', 'bible-open', 'settings-open');
            historySidebar.classList.remove('open');
            settingsPanel.classList.remove('open');
            bibleSidebar.classList.remove('open');
        };
        const toggleHistorySidebar = (open) => {
            if (open) {
                closeAllSidebars();
                historySidebar.classList.add('open');
                document.body.classList.add('history-open');
            } else {
                historySidebar.classList.remove('open');
                document.body.classList.remove('history-open');
            }
        };
        const toggleSettingsPanel = (open) => {
            if (open) {
                closeAllSidebars();
                settingsPanel.classList.add('open');
                document.body.classList.add('settings-open');
            } else {
                settingsPanel.classList.remove('open');
                document.body.classList.remove('settings-open');
            }
        };
        const toggleBibleSidebar = (open) => {
            if (open) {
                closeAllSidebars();
                bibleSidebar.classList.add('open');
                document.body.classList.add('bible-open');
            } else {
                bibleSidebar.classList.remove('open');
                document.body.classList.remove('bible-open');
            }
        };
        const applyTheme = (newTheme) => {
            if (newTheme) {
                state.settings.theme = newTheme;
            } else {
                // Ao iniciar, garante que o tema antigo seja compatível
                if (state.settings.theme === 'light' || state.settings.theme === 'dark') {
                    state.settings.theme = `theme-${state.settings.theme}`;
                }
            }
            const themes = ['theme-light', 'theme-dark', 'theme-sepia', 'theme-light-green', 'theme-light-blue'];
            document.documentElement.className = ''; // Limpa classes para evitar conflitos
            document.documentElement.classList.add(state.settings.theme);
            // Se a mudança de tema foi intencional (newTheme existe), renderiza novamente
            if (newTheme) {
                if (!presentationView.classList.contains('hidden')) {
                    renderCurrentSlide();
                } else {
                    applySettings();
                }
            }
        };
        const applySettings = () => {
            const contentWrapper = slidesContainer;
            if (!contentWrapper) return;
            const alignContentClasses = ['items-start', 'items-center', 'items-end'];
            contentWrapper.classList.remove(...alignContentClasses);
            contentWrapper.classList.add(state.settings.contentAlign);
            const alignClasses = ['text-left', 'text-center', 'text-right', 'text-justify'];
            contentWrapper.classList.remove(...alignClasses);
            contentWrapper.classList.add(state.settings.textAlign);
            const content = contentWrapper.querySelector('.slide-content');
            if (!content) return;
            const fontClasses = ['font-sans', 'font-serif', 'font-display', 'leading-relaxed', 'leading-loose',
                'leading-extra', 'max-w-xl', 'max-w-3xl', 'max-w-5xl', 'max-w-[33%]', 'max-w-[66%]',
                'max-w-full', 'max-w-[33vw]', 'max-w-[66vw]'
            ];
            content.classList.remove(...fontClasses);
            content.classList.add(state.settings.fontFamily, state.settings.lineHeight, state.settings
                .textWidth);
            const baseSizeRem = 1.25 + (state.settings.fontSize * 0.2);
            content.style.fontSize = `${baseSizeRem}rem`;
            content.querySelectorAll('h1').forEach(h => h.style.fontSize = `${baseSizeRem * 1.8}rem`);
            content.querySelectorAll('h2').forEach(h => h.style.fontSize = `${baseSizeRem * 1.5}rem`);
            content.querySelectorAll('h3').forEach(h => h.style.fontSize = `${baseSizeRem * 1.25}rem`);
            
            const calloutBaseSizeRem = 1.0 + (state.settings.calloutFontSize * 0.15);
            document.querySelectorAll('.notion-callout .flex-1').forEach(el => el.style.fontSize = `${calloutBaseSizeRem}rem`);

            const bibleBaseSizeRem = 1.0 + (state.settings.bibleFontSize * 0.15);
            if (bibleVersesContainer) {
                bibleVersesContainer.style.fontSize = `${bibleBaseSizeRem}rem`;
            }

            // Aplicar cor e estilo de destaque do versículo
            const highlightColorClasses = ['highlight-yellow', 'highlight-green', 'highlight-blue', 'highlight-indigo', 'highlight-pink'];
            const highlightStyleClasses = ['style-fill', 'style-font', 'style-outline'];
            if(bibleVersesContainer) {
                bibleVersesContainer.classList.remove(...highlightColorClasses);
                bibleVersesContainer.classList.add(state.settings.verseHighlightColor);

                bibleVersesContainer.classList.remove(...highlightStyleClasses);
                bibleVersesContainer.classList.add(`style-${state.settings.verseHighlightStyle}`);
            }

            wpmDisplay.textContent = state.settings.wpm;
            localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings));
            updateFooterInfo();
            updateSettingsUI();
            renderHistorySidebar();
        };
        const updateSettingsUI = () => {
            for (const key in state.settings) {
                if (key === 'wpm') continue;
                if (key === 'pageBreakHeadings') {
                    document.querySelectorAll(`[data-setting="pageBreakHeadings"]`).forEach(btn => {
                        btn.classList.toggle('active', state.settings.pageBreakHeadings.includes(btn
                            .dataset.value));
                    });
                } else {
                    document.querySelectorAll(`[data-setting="${key}"]`).forEach(el => {
                        let valueToCompare = state.settings[key];
                        if (key === 'theme') {
                            valueToCompare = valueToCompare.replace('theme-', '');
                        }
                        if (el.tagName === 'SELECT') {
                            el.value = valueToCompare;
                        } else if (el.tagName === 'BUTTON') {
                            el.classList.toggle('active', el.dataset.value == valueToCompare);
                            if (key === 'theme' || key === 'verseHighlightColor') {
                                if (el.dataset.value === valueToCompare) {
                                    el.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                                    const ringColor = document.documentElement.classList.contains(
                                        'theme-light') ? '#F9FAFB' : '#1F293B';
                                    el.style.setProperty('--tw-ring-offset-color', ringColor);
                                } else {
                                    el.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                                }
                            }
                        }
                    });
                }
            }
        };
        // Função para renderizar blocos, agrupando itens de lista
        function renderBlocks(blocks, container) {
            if (!blocks) return;
            let i = 0;
            while (i < blocks.length) {
                const block = blocks[i];
                // Agrupa itens de lista consecutivos
                if (block.type === 'bulleted_list_item' || block.type === 'numbered_list_item') {
                    const listTag = block.type === 'bulleted_list_item' ? 'ul' : 'ol';
                    const listEl = document.createElement(listTag);
                    listEl.className = 'list-outside space-y-2 mt-2';
                    if (listTag === 'ul') listEl.classList.add('list-disc', 'pl-6');
                    if (listTag === 'ol') listEl.classList.add('list-decimal', 'pl-6');
                    let j = i;
                    while (j < blocks.length && blocks[j].type === block.type) {
                        const li = createHtmlFromBlock(blocks[j]);
                        if (li) listEl.appendChild(li);
                        j++;
                    }
                    container.appendChild(listEl);
                    i = j;
                } else {
                    // Lida com itens que não são de lista
                    const el = createHtmlFromBlock(block);
                    if (el) container.appendChild(el);
                    i++;
                }
            }
        }
        const handleSettingChange = (e) => {
            const el = e.target;
            if (!el.dataset.setting) return;
            const {
                setting,
                value
            } = el.dataset;
            let settingChanged = false;
            if (el.tagName === 'SELECT') {
                if (state.settings[setting] !== el.value) {
                    state.settings[setting] = el.value;
                    settingChanged = true;
                }
            } else if (el.tagName === 'BUTTON') {
                const btn = el.closest('button[data-setting]');
                if (!btn) return;
                const {
                    setting,
                    value
                } = btn.dataset;
                if (setting === 'theme') {
                    const newTheme = `theme-${value}`;
                    if (state.settings.theme !== newTheme) {
                        applyTheme(newTheme);
                    }
                    return;
                }
                if (setting === 'pageBreakHeadings') {
                    const currentBreaks = state.settings.pageBreakHeadings;
                    const isCurrentlySet = currentBreaks.includes(value);
                    if (isCurrentlySet) {
                        if (currentBreaks.length > 1) {
                            state.settings.pageBreakHeadings = currentBreaks.filter(h => h !== value);
                            settingChanged = true;
                        }
                    } else {
                        state.settings.pageBreakHeadings.push(value);
                        settingChanged = true;
                    }
                } else {
                    const newValue = (setting === 'textWidth' || setting === 'contentAlign') ? value : (isNaN(
                        value) ? value : parseInt(value));
                    if (state.settings[setting] !== newValue) {
                        state.settings[setting] = newValue;
                        settingChanged = true;
                    }
                }
            }
            if (settingChanged) {
                if (setting === 'displayMode' || setting === 'pageBreakHeadings' || setting === 'bibleVersion') {
                    if (setting === 'bibleVersion') {
                        loadAndDisplayBibleChapter(state.bible.currentBook, state.bible.currentChapter);
                    }
                    rebuildSlidesAndRender();
                } else {
                    applySettings();
                }
            }
        };
        const updateClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            clockEl.textContent = `${hours}:${minutes}`;
        };
        const startTimer = () => {
            if (state.isTimerRunning) return;
            state.isTimerRunning = true;
            timerPlayPauseBtn.innerHTML = ICONS.pause;
            state.pageSeconds = 0;
            state.overallTimerInterval = setInterval(() => {
                state.overallSeconds++;
                state.pageSeconds++;
                overallTimerEl.textContent = formatTime(state.overallSeconds);
                renderHistorySidebar();
            }, 1000);
            renderHistorySidebar();
        };
        const stopTimer = () => {
            if (!state.isTimerRunning) return;
            recordPageTime();
            state.isTimerRunning = false;
            timerPlayPauseBtn.innerHTML = ICONS.play;
            clearInterval(state.overallTimerInterval);
            renderHistorySidebar();
        };
        const toggleTimer = () => state.isTimerRunning ? stopTimer() : startTimer();
        const startAutoScroll = () => {
            if (state.isAutoScrolling) return;
            const {
                scrollTop,
                scrollHeight,
                clientHeight
            } = slidesContainer;
            const scrollableHeight = scrollHeight - clientHeight;
            const wpm = state.settings.wpm;
            // Case 1: Page is NOT scrollable. We just wait and then advance.
            if (scrollableHeight < 1 && state.settings.displayMode === 'slides') {
                const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc +
                    countWordsInBlock(b), 0);
                const duration = ((wordsOnPage / wpm) * 60 * 1000);
                if (duration < 100) return;
                state.isAutoScrolling = true;
                autoScrollToggleBtn.innerHTML = ICONS.scrollPause;
                state.autoScrollInterval = setTimeout(() => {
                    if (state.isAutoScrolling) {
                        stopAutoScroll();
                        if (state.currentSlide < state.slides.length - 1) {
                            goToNextSlide();
                        }
                    }
                }, duration);
                return;
            }
            // Case 2: Page IS scrollable.
            const remainingScroll = scrollableHeight - scrollTop;
            if (remainingScroll <= 1) return;
            let wordsRemaining = 0;
            if (state.settings.displayMode === 'scroll') {
                const totalWordsAll = state.rawBlocks.reduce((acc, b) => acc + countWordsInBlock(b), 0);
                const scrollPercent = (scrollTop / scrollableHeight);
                const wordsRead = totalWordsAll * scrollPercent;
                wordsRemaining = totalWordsAll - wordsRead;
            } else { // slides mode
                const wordsOnPage = (state.slides[state.currentSlide] || []).reduce((acc, b) => acc +
                    countWordsInBlock(b), 0);
                const pageScrollPercent = (scrollTop / scrollableHeight);
                const pageWordsRead = wordsOnPage * pageScrollPercent;
                wordsRemaining = wordsOnPage - pageWordsRead;
            }
            const totalDuration = ((wordsRemaining / wpm) * 60 * 1000);
            if (totalDuration <= 100) {
                stopAutoScroll();
                return;
            }
            state.isAutoScrolling = true;
            autoScrollToggleBtn.innerHTML = ICONS.scrollPause;
            let startTime = null;
            const startScrollTop = scrollTop;
            const scrollStep = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / totalDuration, 1);
                slidesContainer.scrollTop = startScrollTop + remainingScroll * progress;
                if (progress < 1) {
                    state.autoScrollInterval = requestAnimationFrame(scrollStep);
                } else {
                    stopAutoScroll();
                    if (state.settings.displayMode === 'slides' && state.currentSlide < state.slides.length - 1) {
                        setTimeout(goToNextSlide, 1000);
                    }
                }
            };
            state.autoScrollInterval = requestAnimationFrame(scrollStep);
        };
        const stopAutoScroll = () => {
            if (!state.isAutoScrolling) return;
            state.isAutoScrolling = false;
            autoScrollToggleBtn.innerHTML = ICONS.scrollPlay;
            if (state.autoScrollInterval) {
                cancelAnimationFrame(state.autoScrollInterval);
                clearTimeout(state.autoScrollInterval); // Handles both setTimeout and rAF
            }
            state.autoScrollInterval = null;
        };
        const toggleAutoScroll = () => state.isAutoScrolling ? stopAutoScroll() : startAutoScroll();
        const saveToHistory = (id, title) => {
            if (!id || !title) return;
            let history = JSON.parse(localStorage.getItem('notionViewerHistory')) || [];
            history = history.filter(item => item.id !== id);
            history.unshift({
                id,
                title
            });
            history = history.slice(0, 3);
            localStorage.setItem('notionViewerHistory', JSON.stringify(history));
        };
        const renderRecentHistory = () => {
            const historyContainer = $('#history-container');
            const historyList = $('#recent-history-list');
            const history = JSON.parse(localStorage.getItem('notionViewerHistory')) || [];
            if (history.length > 0) {
                historyList.innerHTML = '';
                history.forEach(item => {
                    const button = document.createElement('button');
                    button.className =
                        'w-full text-left px-4 py-3 rounded-lg transition truncate text-white';
                    button.textContent = item.title;
                    button.title = item.title;
                    button.dataset.id = item.id;
                    button.addEventListener('click', () => {
                        pageIdInput.value = item.id;
                        generateBtn.click();
                    });
                    historyList.appendChild(button);
                });
                historyContainer.classList.remove('hidden');
            } else {
                historyContainer.classList.add('hidden');
            }
        };
        // Swipe Gesture Handling
        let touchStartX = 0,
            touchEndX = 0,
            touchStartY = 0,
            touchEndY = 0;

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchMove(e) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
        }

        function handleTouchEnd() {
            if (state.settings.displayMode !== 'slides') return;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) { // Horizontal swipe
                if (deltaX < 0) {
                    goToNextSlide();
                } else {
                    goToPrevSlide();
                }
            }
        }

        // --- BIBLE FUNCTIONS ---
        const BIBLE_METADATA = {
            versions: [{
                id: 'NVI',
                name: 'Nova Versão Internacional',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/NVI.json'
            }, {
                id: 'ACF',
                name: 'Almeida Corrigida Fiel',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/ACF.json'
            }, {
                id: 'ARA',
                name: 'Almeida Revista e Atualizada',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/ARA.json'
            }, {
                id: 'ARC',
                name: 'Almeida Revista e Corrigida',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/ARC.json'
            }, {
                id: 'NAA',
                name: 'Nova Almeida Atualizada',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/NAA.json'
            }, {
                id: 'NBV',
                name: 'Nova Bíblia Viva',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/NBV.json'
            }, {
                id: 'NTLH',
                name: 'Nova Tradução na Linguagem de Hoje',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/NTLH.json'
            }, {
                id: 'NVT',
                name: 'Nova Versão Transformadora',
                url: 'https://raw.githubusercontent.com/Sony-Werison/Visualizador-de-Notas-Notion/main/B%C3%ADblias/NVT.json'
            }],
            books: ["Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute",
                "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias",
                "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias",
                "Lamentações", "Ezequiel", "Daniel", "Oséias", "Joel", "Amós", "Obadias", "Jonas", "Miquéias",
                "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias", "Mateus", "Marcos", "Lucas",
                "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses",
                "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito",
                "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas",
                "Apocalipse"
            ],
            abbreviations: {
                "Gn": "Gênesis", "Êx": "Êxodo", "Lv": "Levítico", "Nm": "Números", "Dt": "Deuteronômio",
                "Js": "Josué", "Jz": "Juízes", "Rt": "Rute", "1Sm": "1 Samuel", "2Sm": "2 Samuel",
                "1Rs": "1 Reis", "2Rs": "2 Reis", "1Cr": "1 Crônicas", "2Cr": "2 Crônicas", "Ed": "Esdras",
                "Ne": "Neemias", "Et": "Ester", "Jó": "Jó", "Sl": "Salmos", "Pv": "Provérbios",
                "Ec": "Eclesiastes", "Ct": "Cânticos", "Is": "Isaías", "Jr": "Jeremias",
                "Lm": "Lamentações", "Ez": "Ezequiel", "Dn": "Daniel", "Os": "Oséias", "Jl": "Joel",
                "Am": "Amós", "Ob": "Obadias", "Jn": "Jonas", "Mq": "Miquéias", "Na": "Naum", "Hc": "Habacuque",
                "Sf": "Sofonias", "Ag": "Ageu", "Zc": "Zacarias", "Ml": "Malaquias",
                "Mt": "Mateus", "Mc": "Marcos", "Lc": "Lucas", "Jo": "João", "At": "Atos", "Rm": "Romanos",
                "1Co": "1 Coríntios", "2Co": "2 Coríntios", "Gl": "Gálatas", "Ef": "Efésios", "Fp": "Filipenses",
                "Cl": "Colossenses", "1Ts": "1 Tessalonicenses", "2Ts": "2 Tessalonicenses", "1Tm": "1 Timóteo",
                "2Tm": "2 Timóteo", "Tt": "Tito", "Fm": "Filemom", "Hb": "Hebreus", "Tg": "Tiago",
                "1Pe": "1 Pedro", "2Pe": "2 Pedro", "1Jo": "1 João", "2Jo": "2 João", "3Jo": "3 João",
                "Jd": "Judas", "Ap": "Apocalipse"
            }
        };
        async function loadBibleData(versionId) {
            if (state.bible.versions[versionId]) {
                return state.bible.versions[versionId];
            }
            const versionInfo = BIBLE_METADATA.versions.find(v => v.id === versionId);
            if (!versionInfo) {
                console.error(`Versão da Bíblia não encontrada: ${versionId}`);
                return null;
            }
            try {
                const response = await fetch(versionInfo.url);
                if (!response.ok) throw new Error(`Falha ao carregar a Bíblia (status: ${response.status})`);
                const data = await response.json();
                state.bible.versions[versionId] = data;
                return data;
            } catch (error) {
                console.error(`Erro ao carregar os dados da Bíblia (${versionId}):`, error);
                bibleVersesContainer.innerHTML =
                    `<p class="text-red-500 p-4">Não foi possível carregar a versão ${versionId}. Verifique sua conexão.</p>`;
                return null;
            }
        }
        async function loadAndDisplayBibleChapter(bookIndex, chapterIndex) {
            state.bible.currentBook = bookIndex;
            state.bible.currentChapter = chapterIndex;
            bibleVersesContainer.innerHTML = '<div class="animate-pulse p-4">Carregando versículos...</div>';
            const bibleData = await loadBibleData(state.settings.bibleVersion);
            if (!bibleData || !bibleData[bookIndex] || !bibleData[bookIndex].chapters[chapterIndex]) {
                bibleVersesContainer.innerHTML = '<p class="text-red-500 p-4">Capítulo não encontrado.</p>';
                return;
            }
            const chapter = bibleData[bookIndex].chapters[chapterIndex];
            bibleVersesContainer.innerHTML = chapter.map((verse, i) =>
                `<div class="verse" data-verse="${i + 1}"><strong class="font-bold mr-1">${i + 1}</strong>${verse}</div>`
            ).join('');
            
            applySettings(); // Aplica fonte e cor
            updateBibleNavButtons();

            // Update selects
            bibleBookSelect.value = bookIndex;
            bibleChapterSelect.innerHTML = bibleData[bookIndex].chapters.map((_, i) =>
                `<option value="${i}">${i + 1}</option>`).join('');
            bibleChapterSelect.value = chapterIndex;
        }

        function parseAndLinkBibleReferences(html) {
            const bookNames = BIBLE_METADATA.books;
            const allAbbrs = { ...BIBLE_METADATA.abbreviations,
                ...bookNames.reduce((acc, name) => {
                    acc[name] = name;
                    return acc;
                }, {})
            };

            // Pre-compute a map of spaceless names to original names for quick lookup
            const spacelessMap = new Map();
            for (const key in allAbbrs) {
                spacelessMap.set(key.replace(/\s/g, '').toLowerCase(), allAbbrs[key]);
            }

            const bookRegex = Object.keys(allAbbrs)
                .sort((a, b) => b.length - a.length)
                .join('|')
                .replace(/ /g, '\\s?'); // Allows matching "1 Corintios" and "1Corintios"

            const regex = new RegExp(
                `(${bookRegex})\\s*(\\d+)[.:,]?\\s*(\\d+(?:\\s*[-–—eE]\\s*\\d+)?(?:,\\s*\\d+)*)`, 'gi');

            return html.replace(regex, (match, book, chapter, verses) => {
                const normalizedBook = book.replace(/\s/g, '').toLowerCase();
                const fullBookName = spacelessMap.get(normalizedBook);
         
                if (fullBookName) {
                    return `<span class="bible-ref-link" data-ref="${fullBookName} ${chapter}:${verses}">${match}</span>`;
                }
                return match;
            });
        }
        async function handleReferenceClick(ref) {
            const [bookAndChapter, versesStr] = ref.split(':');
            const parts = bookAndChapter.split(' ');
            const chapter = parts.pop();
            const bookName = parts.join(' ');
            const bookIndex = BIBLE_METADATA.books.findIndex(b => b.toLowerCase() === bookName.toLowerCase());
            if (bookIndex === -1) {
                console.error("Livro não encontrado:", bookName);
                return;
            }
            toggleBibleSidebar(true);
            await loadAndDisplayBibleChapter(bookIndex, parseInt(chapter) - 1);
            
            setTimeout(() => {
                bibleVersesContainer.querySelectorAll('.verse.highlighted').forEach(v => v.classList.remove(
                    'highlighted'));
                const verseNumbers = [];
                if (versesStr) {
                    versesStr.split(',').forEach(part => {
                        if (part.includes('-') || part.includes('–') || part.includes('—') || part
                            .includes('e')) {
                            const [start, end] = part.split(/[-–—eE]/).map(Number);
                            for (let i = start; i <= end; i++) {
                                verseNumbers.push(i);
                            }
                        } else {
                            verseNumbers.push(Number(part));
                        }
                    });
                }
                if (verseNumbers.length > 0) {
                    const firstVerse = bibleVersesContainer.querySelector(
                        `[data-verse="${verseNumbers[0]}"]`);
                    if (firstVerse) {
                        firstVerse.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                    verseNumbers.forEach(vNum => {
                        const verseEl = bibleVersesContainer.querySelector(
                            `[data-verse="${vNum}"]`);
                        if (verseEl) verseEl.classList.add('highlighted');
                    });
                }
            }, 200);
        }
        const initBible = () => {
            const versionOptions = BIBLE_METADATA.versions.map(v => `<option value="${v.id}">${v.name}</option>`)
                .join('');
            bibleVersionSelect.innerHTML = versionOptions;
            defaultBibleVersionSelect.innerHTML = versionOptions;
            bibleVersionSelect.value = state.settings.bibleVersion;
            defaultBibleVersionSelect.value = state.settings.bibleVersion;
            const bookOptions = BIBLE_METADATA.books.map((name, index) =>
                `<option value="${index}">${name}</option>`).join('');
            bibleBookSelect.innerHTML = bookOptions;
            bibleVersionSelect.addEventListener('change', (e) => {
                state.settings.bibleVersion = e.target.value;
                loadAndDisplayBibleChapter(state.bible.currentBook, state.bible.currentChapter);
            });
            bibleBookSelect.addEventListener('change', (e) => {
                const bookIndex = parseInt(e.target.value);
                loadAndDisplayBibleChapter(bookIndex, 0);
            });
            bibleChapterSelect.addEventListener('change', (e) => {
                const chapterIndex = parseInt(e.target.value);
                loadAndDisplayBibleChapter(state.bible.currentBook, chapterIndex);
            });
            loadAndDisplayBibleChapter(0, 0);
        };

        const updateBibleNavButtons = async () => {
            const { currentBook, currentChapter } = state.bible;
             const bibleData = await loadBibleData(state.settings.bibleVersion);

            // Disable prev if it's the very first chapter of the Bible
            biblePrevChapterBtn.disabled = currentBook === 0 && currentChapter === 0;

            if (!bibleData) {
                bibleNextChapterBtn.disabled = true;
                return;
            }
            // Disable next if it's the very last chapter of the Bible
            const lastBookIndex = BIBLE_METADATA.books.length - 1;
            const lastBookData = bibleData[lastBookIndex];
            if (!lastBookData) {
                 bibleNextChapterBtn.disabled = true;
                 return;
            }
            const lastChapterIndex = lastBookData.chapters.length - 1;
            bibleNextChapterBtn.disabled = currentBook === lastBookIndex && currentChapter === lastChapterIndex;
        };

        const goToPrevChapter = async () => {
            let currentBookIndex = state.bible.currentBook;
            let currentChapterIndex = state.bible.currentChapter;
            const bibleData = await loadBibleData(state.settings.bibleVersion);

            if (currentChapterIndex > 0) {
                currentChapterIndex--;
            } else { // At the first chapter of the current book
                if (currentBookIndex > 0) { // Go to the previous book
                    currentBookIndex--;
                    if (bibleData && bibleData[currentBookIndex]) {
                       currentChapterIndex = bibleData[currentBookIndex].chapters.length - 1;
                    }
                }
            }
            loadAndDisplayBibleChapter(currentBookIndex, currentChapterIndex);
        };

        const goToNextChapter = async () => {
            let currentBookIndex = state.bible.currentBook;
            let currentChapterIndex = state.bible.currentChapter;

            const bibleData = await loadBibleData(state.settings.bibleVersion);
            if (!bibleData || !bibleData[currentBookIndex]) return;

            const totalChaptersInBook = bibleData[currentBookIndex].chapters.length;

            if (currentChapterIndex < totalChaptersInBook - 1) {
                currentChapterIndex++;
            } else { // At the last chapter of the current book
                if (currentBookIndex < BIBLE_METADATA.books.length - 1) { // Go to the next book
                    currentBookIndex++;
                    currentChapterIndex = 0;
                }
            }
            loadAndDisplayBibleChapter(currentBookIndex, currentChapterIndex);
        };

        const init = () => {
            const setAppHeight = () => {
                const doc = document.documentElement;
                doc.style.setProperty('--app-height', `${window.innerHeight}px`);
            };
            window.addEventListener('resize', setAppHeight);
            setAppHeight();
            if (timerPlayPauseBtn) timerPlayPauseBtn.innerHTML = ICONS.play;
            if (settingsToggleBtn) settingsToggleBtn.innerHTML = ICONS.settings;
            if (closeSettingsBtn) closeSettingsBtn.innerHTML = ICONS.close;
            if (prevBtn) prevBtn.innerHTML = ICONS.arrowLeft;
            if (nextBtn) nextBtn.innerHTML = ICONS.arrowRight;
            if (historyToggleBtn) historyToggleBtn.innerHTML = ICONS.menu;
            if (closeHistoryBtn) closeHistoryBtn.innerHTML = ICONS.close;
            if (homeBtn) homeBtn.innerHTML = ICONS.home;
            if (autoScrollToggleBtn) autoScrollToggleBtn.innerHTML = ICONS.scrollPlay;
            if (bibleToggleBtn) bibleToggleBtn.innerHTML = ICONS.book;
            if (closeBibleBtn) closeBibleBtn.innerHTML = ICONS.close;
            if (biblePrevChapterBtn) biblePrevChapterBtn.innerHTML = ICONS.arrowLeft;
            if (bibleNextChapterBtn) bibleNextChapterBtn.innerHTML = ICONS.arrowRight;
            document.querySelector('[data-setting="textAlign"][data-value="text-left"]').innerHTML = ICONS
                .alignLeft;
            document.querySelector('[data-setting="textAlign"][data-value="text-center"]').innerHTML = ICONS
                .alignCenter;
            document.querySelector('[data-setting="textAlign"][data-value="text-right"]').innerHTML = ICONS
                .alignRight;
            document.querySelector('[data-setting="textAlign"][data-value="text-justify"]').innerHTML = ICONS
                .alignJustify;
            document.querySelector('[data-setting="contentAlign"][data-value="items-start"]').innerHTML = ICONS
                .alignHorizontalStart;
            document.querySelector('[data-setting="contentAlign"][data-value="items-center"]').innerHTML = ICONS
                .alignHorizontalCenter;
            document.querySelector('[data-setting="contentAlign"][data-value="items-end"]').innerHTML = ICONS
                .alignHorizontalEnd;
            const savedSettings = JSON.parse(localStorage.getItem('notionViewerSettings'));
            if (savedSettings) {
                state.settings = { ...state.settings,
                    ...savedSettings
                };
                const validWidths = ['max-w-[33vw]', 'max-w-[66vw]', 'max-w-full'];
                if (!validWidths.includes(state.settings.textWidth)) {
                    state.settings.textWidth =
                        'max-w-[66vw]';
                }
            }
            applyTheme();
            initBible();
            generateBtn.addEventListener('click', () => fetchNotionContent(false));
            previewBtn.addEventListener('click', () => fetchNotionContent(true));
            settingsToggleBtn.addEventListener('click', () => toggleSettingsPanel(!settingsPanel.classList
                .contains('open')));
            closeSettingsBtn.addEventListener('click', () => toggleSettingsPanel(false));
            historyToggleBtn.addEventListener('click', () => toggleHistorySidebar(!historySidebar.classList
                .contains('open')));
            closeHistoryBtn.addEventListener('click', () => toggleHistorySidebar(false));
            bibleToggleBtn.addEventListener('click', () => toggleBibleSidebar(!bibleSidebar.classList.contains(
                'open')));
            closeBibleBtn.addEventListener('click', () => toggleBibleSidebar(false));
            homeBtn.addEventListener('click', () => showView('setup'));
            autoScrollToggleBtn.addEventListener('click', toggleAutoScroll);
            biblePrevChapterBtn.addEventListener('click', goToPrevChapter);
            bibleNextChapterBtn.addEventListener('click', goToNextChapter);
            document.addEventListener('click', e => {
                const isSidebarOpen = document.body.classList.contains('history-open') || document.body
                    .classList.contains('bible-open') || document.body.classList.contains('settings-open');
                if (!isSidebarOpen) return;
                const target = e.target;
                const isClickInsideSidebar = target.closest('#history-sidebar') || target.closest(
                    '#bible-sidebar') || target.closest('#settings-panel');
                const isClickOnToggleButton = target.closest('#history-toggle-btn') || target.closest(
                    '#bible-toggle-btn-footer') || target.closest('#settings-toggle-btn') || target.closest('.bible-ref-link');
                if (!isClickInsideSidebar && !isClickOnToggleButton) {
                    closeAllSidebars();
                }
            });
            slidesContainer.addEventListener('scroll', updateFooterInfo);
            slidesContainer.addEventListener('touchstart', handleTouchStart, {
                passive: true
            });
            slidesContainer.addEventListener('touchmove', handleTouchMove, {
                passive: true
            });
            slidesContainer.addEventListener('touchend', handleTouchEnd, {
                passive: true
            });
            document.querySelector('.settings-panel-content').addEventListener('click', handleSettingChange);
            document.querySelector('.settings-panel-content').addEventListener('change', handleSettingChange);
            timerPlayPauseBtn.addEventListener('click', toggleTimer);
            nextBtn.addEventListener('click', goToNextSlide);
            prevBtn.addEventListener('click', goToPrevSlide);
            historyList.addEventListener('click', e => {
                const button = e.target.closest('.history-item');
                if (button && button.dataset.index) {
                    goToSlide(parseInt(button.dataset.index));
                }
            });
            slidesContainer.addEventListener('click', e => {
                const refLink = e.target.closest('.bible-ref-link');
                if (refLink) {
                    const ref = refLink.dataset.ref;
                    handleReferenceClick(ref);
                }
            });
            wpmIncreaseBtn.addEventListener('click', () => {
                state.settings.wpm = Math.min(state.settings.wpm + 10, 500);
                applySettings();
            });
            wpmDecreaseBtn.addEventListener('click', () => {
                state.settings.wpm = Math.max(state.settings.wpm - 10, 20);
                applySettings();
            });
            document.addEventListener('keydown', e => {
                if (presentationView.classList.contains('hidden')) return;
                if (e.key === 'Escape') {
                    closeAllSidebars();
                }
                if (settingsPanel.classList.contains('open') || historySidebar.classList.contains('open') ||
                    bibleSidebar.classList.contains('open')) return;
                if (state.settings.displayMode === 'slides') {
                    if (e.key === 'ArrowRight' || e.key === ' ') goToNextSlide();
                    if (e.key === 'ArrowLeft') goToPrevSlide();
                }
            });
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('pageId')) {
                pageIdInput.value = urlParams.get('pageId');
                generateBtn.click();
            } else {
                renderRecentHistory();
            }
            applySettings();
        };
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>