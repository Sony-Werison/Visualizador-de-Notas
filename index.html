<!DOCTYPE html>
<html lang="pt-BR" class="dark"> <!-- Inicia em modo escuro por padrão -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Notas do Notion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        // Mantém a preferência do usuário, mas o padrão agora é escuro
        if (localStorage.getItem('notionViewerDarkMode') === 'false') {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-serif: 'Lora', serif;
            --font-mono: 'Roboto Mono', monospace;
        }
        body { 
            font-family: var(--font-sans); 
            touch-action: pan-y; 
            background-color: #111827; /* bg-gray-900 */
        }
        .font-sans { font-family: var(--font-sans); }
        .font-serif { font-family: var(--font-serif); }
        .font-mono { font-family: var(--font-mono); }

        .slide-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Estilo do teleprompter com a linha lateral */
        .teleprompter-body {
            border-left: 3px solid #34d399; /* emerald-400 */
            padding-left: 2rem;
        }
        .settings-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .settings-panel.open {
            transform: translateX(0);
        }
        /* Estilizando a barra de rolagem */
        #slides-container::-webkit-scrollbar { width: 8px; }
        #slides-container::-webkit-scrollbar-track { background: transparent; }
        #slides-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        
        .control-btn-group button.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center min-h-screen transition-colors duration-300">

    <div id="app" class="w-full h-screen flex flex-col">
        <!-- Tela de Configuração Inicial -->
        <div id="setup-view" class="w-full max-w-xl mx-auto my-auto bg-gray-800 p-8 rounded-xl shadow-lg space-y-6">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white">Visualizador de Notas do Notion</h1>
                <p class="text-gray-400 mt-2">Insira a URL da sua página do Notion para transformá-la em uma apresentação.</p>
            </div>
            
            <div>
                <label for="pageId" class="block text-sm font-medium text-gray-300 mb-1">URL ou ID da Página do Notion</label>
                <input type="text" id="pageId" placeholder="Cole a URL ou o ID da sua página aqui" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition text-white">
            </div>

            <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
                Visualizar
            </button>

            <div id="error-message" class="text-red-500 text-center font-medium hidden mt-4"></div>
        </div>

        <!-- Tela de Apresentação -->
        <div id="presentation-view" class="hidden w-full h-full flex flex-col relative overflow-hidden">
            <!-- Barra Superior -->
            <header class="w-full p-4 flex justify-between items-center absolute top-0 left-0 z-20 bg-gradient-to-b from-black/50 to-transparent">
                <button id="home-btn" title="Voltar ao Início" class="px-3 py-1 bg-gray-700/50 text-gray-200 font-semibold rounded-lg hover:bg-gray-600/50 transition text-sm">Início</button>
                <div class="text-center">
                    <h2 id="presentation-title" class="text-sm text-white">Modo de Apresentação</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="overall-timer" class="text-sm text-gray-300 font-mono" title="Tempo total da sessão">0:00</div>
                    <button id="settings-toggle-btn" title="Ajustes" class="p-2 rounded-lg hover:bg-gray-700/50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>
            </header>

            <!-- Conteúdo Principal -->
            <main id="slides-container" class="w-full h-full flex-1 flex flex-col items-center justify-center overflow-y-auto px-8 py-24 transition-all duration-300">
                <!-- Conteúdo renderizado aqui -->
            </main>

            <!-- Barra Inferior -->
            <footer id="navigation-controls" class="w-full p-4 flex justify-between items-center absolute bottom-0 left-0 z-20 bg-gradient-to-t from-black/50 to-transparent">
                 <button id="prev-btn" title="Anterior" class="p-3 rounded-full hover:bg-gray-700/50 disabled:opacity-20 disabled:cursor-not-allowed transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                 </button>
                 <div id="slide-counter" class="text-sm font-medium"></div>
                 <button id="next-btn" title="Próximo" class="p-3 rounded-full hover:bg-gray-700/50 disabled:opacity-20 disabled:cursor-not-allowed transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                 </button>
            </footer>
            
            <footer id="teleprompter-footer" class="hidden w-full p-4 text-center absolute bottom-0 left-0 z-20">
                <span id="estimated-time" class="text-sm font-mono"></span>
            </footer>

            <!-- Painel de Ajustes -->
            <aside id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-80 bg-gray-800/95 backdrop-blur-sm shadow-2xl p-6 z-30 space-y-6 text-sm overflow-y-auto">
                <h3 class="font-bold text-lg">Ajustes de Visualização</h3>

                <!-- Coluna de Texto -->
                <div>
                    <h4 class="font-semibold mb-2">Coluna de Texto</h4>
                    <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                        <button data-setting="displayMode" data-value="slides" class="flex-1 px-2 py-1 rounded transition">Páginas</button>
                        <button data-setting="displayMode" data-value="scroll" class="flex-1 px-2 py-1 rounded transition active">Rolagem</button>
                    </div>
                </div>

                <!-- Fonte -->
                <div>
                    <h4 class="font-semibold mb-2">Fonte</h4>
                    <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                        <button data-setting="fontFamily" data-value="font-sans" class="flex-1 px-2 py-1 rounded transition active">Sans</button>
                        <button data-setting="fontFamily" data-value="font-serif" class="flex-1 px-2 py-1 rounded transition">Serif</button>
                        <button data-setting="fontFamily" data-value="font-mono" class="flex-1 px-2 py-1 rounded transition">Mono</button>
                    </div>
                </div>

                <!-- Tamanho da Fonte -->
                <div>
                    <h4 class="font-semibold mb-2">Tamanho da Fonte</h4>
                    <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                         <button data-setting="fontSize" data-value="-2" class="flex-1 px-2 py-1 rounded transition">P</button>
                         <button data-setting="fontSize" data-value="-1" class="flex-1 px-2 py-1 rounded transition">M</button>
                         <button data-setting="fontSize" data-value="0" class="flex-1 px-2 py-1 rounded transition active">G</button>
                         <button data-setting="fontSize" data-value="1" class="flex-1 px-2 py-1 rounded transition">XG</button>
                         <button data-setting="fontSize" data-value="2" class="flex-1 px-2 py-1 rounded transition">2XG</button>
                    </div>
                </div>
                
                <!-- Espaçamento -->
                <div>
                    <h4 class="font-semibold mb-2">Espaçamento entre Linhas</h4>
                    <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                        <button data-setting="lineHeight" data-value="leading-normal" class="flex-1 px-2 py-1 rounded transition">Simples</button>
                        <button data-setting="lineHeight" data-value="leading-relaxed" class="flex-1 px-2 py-1 rounded transition active">1.5</button>
                        <button data-setting="lineHeight" data-value="leading-loose" class="flex-1 px-2 py-1 rounded transition">Duplo</button>
                    </div>
                </div>

                <!-- Margens -->
                <div>
                    <h4 class="font-semibold mb-2">Margens</h4>
                    <div class="control-btn-group flex rounded-md bg-gray-700 p-1">
                        <button data-setting="textWidth" data-value="max-w-xl" class="flex-1 px-2 py-1 rounded transition">Estreito</button>
                        <button data-setting="textWidth" data-value="max-w-3xl" class="flex-1 px-2 py-1 rounded transition active">Normal</button>
                        <button data-setting="textWidth" data-value="max-w-5xl" class="flex-1 px-2 py-1 rounded transition">Solto</button>
                    </div>
                </div>

                <!-- Teleprompter -->
                <div id="teleprompter-controls" class="pt-4 border-t border-gray-700">
                    <h4 class="font-semibold mb-2">Teleprompter</h4>
                    <div class="flex items-center justify-between">
                         <button id="wpm-decrease" class="px-3 py-1 bg-gray-700 rounded transition">-</button>
                         <span id="wpm-display" class="font-mono text-center">180 PPM</span>
                         <button id="wpm-increase" class="px-3 py-1 bg-gray-700 rounded transition">+</button>
                    </div>
                     <button id="teleprompter-play-pause" class="w-full mt-2 px-2 py-1.5 bg-gray-700 rounded transition">Iniciar Rolagem</button>
                </div>

            </aside>
        </div>
        
        <div id="loading-view" class="hidden text-center p-8 my-auto">
             <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mx-auto"></div>
             <p class="mt-4 text-gray-400">Carregando conteúdo do Notion...</p>
        </div>
    </div>

    <script>
        // --- Seletores ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const setupView = $('#setup-view');
        const presentationView = $('#presentation-view');
        const loadingView = $('#loading-view');
        const pageIdInput = $('#pageId');
        const generateBtn = $('#generate-btn');
        const errorMessage = $('#error-message');
        const slidesContainer = $('#slides-container');
        const prevBtn = $('#prev-btn');
        const nextBtn = $('#next-btn');
        const slideCounter = $('#slide-counter');
        const homeBtn = $('#home-btn');
        const overallTimerEl = $('#overall-timer');
        const navigationControls = $('#navigation-controls');
        const teleprompterFooter = $('#teleprompter-footer');
        const estimatedTimeEl = $('#estimated-time');
        const presentationTitle = $('#presentation-title');
        
        // --- Painel de Ajustes ---
        const settingsPanel = $('#settings-panel');
        const settingsToggleBtn = $('#settings-toggle-btn');
        const teleprompterControls = $('#teleprompter-controls');
        const teleprompterPlayPauseBtn = $('#teleprompter-play-pause');
        const wpmDecreaseBtn = $('#wpm-decrease');
        const wpmIncreaseBtn = $('#wpm-increase');
        const wpmDisplay = $('#wpm-display');
        
        // --- Estado da Aplicação ---
        let state = {
            slides: [], rawBlocks: [], currentSlide: 0, pageId: '',
            overallTimerInterval: null, overallSeconds: 0,
            isSettingsOpen: false,
            // Teleprompter
            isTeleprompterPlaying: false,
            animationFrameId: null, lastFrameTime: null,
            totalWords: 0, totalReadingSeconds: 0,
            // Configurações de Visualização
            settings: {
                displayMode: 'scroll', // 'slides' or 'scroll'
                fontFamily: 'font-sans', // 'font-sans', 'font-serif', 'font-mono'
                fontSize: 0, // range -2 to 2
                lineHeight: 'leading-relaxed', // 'leading-normal', 'leading-relaxed', 'leading-loose'
                textWidth: 'max-w-3xl', // 'max-w-xl', 'max-w-3xl', 'max-w-5xl'
                wpm: 180,
            }
        };

        // --- LÓGICA DE CONFIGURAÇÕES ---
        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('notionViewerSettings'));
            if (savedSettings) {
                state.settings = { ...state.settings, ...savedSettings };
            }
        }

        function saveSettings() {
            localStorage.setItem('notionViewerSettings', JSON.stringify(state.settings));
        }

        function applySettings() {
            // Aplica todas as configurações de uma vez
            const contentWrapper = $('.slide-content');
            if (!contentWrapper) return;

            // Remove classes antigas
            contentWrapper.classList.remove('font-sans', 'font-serif', 'font-mono', 'leading-normal', 'leading-relaxed', 'leading-loose', 'max-w-xl', 'max-w-3xl', 'max-w-5xl');
            
            // Adiciona novas classes
            contentWrapper.classList.add(state.settings.fontFamily, state.settings.lineHeight, state.settings.textWidth);

            // Aplica tamanho da fonte
            const baseFontSize = 1.125; // rem (corresponde a text-lg)
            const scaleFactor = 0.125;
            contentWrapper.style.fontSize = `${baseFontSize + (state.settings.fontSize * scaleFactor)}rem`;
            
            updateWPMDisplay();
            updateSettingsUI();
        }
        
        function updateSettingsUI() {
            // Atualiza os botões no painel para refletir o estado atual
            for (const key in state.settings) {
                const buttons = $$(`[data-setting="${key}"]`);
                buttons.forEach(btn => {
                    if (btn.dataset.value == state.settings[key]) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        }
        
        function handleSettingChange(e) {
            const button = e.target.closest('button[data-setting]');
            if (!button) return;
            
            const { setting, value } = button.dataset;
            if (setting && value) {
                state.settings[setting] = isNaN(value) ? value : parseInt(value);
                saveSettings();
                
                // Ações imediatas
                if (setting === 'displayMode') {
                    rebuildSlidesAndRender();
                } else {
                    applySettings();
                }
            }
        }

        // --- LÓGICA PRINCIPAL (API, RENDERIZAÇÃO) ---
        function extractPageId(input) {
            if (!input) return '';
            try {
                if (input.startsWith('http')) {
                    const url = new URL(input);
                    const pathParts = url.pathname.split('/');
                    const lastPart = pathParts[pathParts.length - 1];
                    const idFromEnd = lastPart.split('-').pop();
                    if (idFromEnd && idFromEnd.length === 32) return idFromEnd;
                }
                return input.split('-').pop().replace(/[^0-9a-fA-F]/g, '');
            } catch (e) { return input.split('-').pop().replace(/[^0-9a-fA-F]/g, ''); }
        }

        async function fetchNotionContent() {
            state.pageId = extractPageId(pageIdInput.value.trim());
            if (!state.pageId) {
                showError("Por favor, insira a URL ou ID da Página.");
                return;
            }
            showView('loading');
            const API_URL = `/.netlify/functions/notion-proxy?pageId=${state.pageId}`;
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `Erro ${response.status}`);
                state.rawBlocks = data.results;
                rebuildSlidesAndRender();
                showView('presentation');
                startOverallTimer();
            } catch (error) {
                showError(`Erro: ${error.message}. Verifique o ID e as permissões.`);
                showView('setup');
            }
        }

        function parseBlocksIntoSlides(blocks) {
            if (!blocks || blocks.length === 0) return [];
            if (state.settings.displayMode === 'scroll') return [blocks];
            
            const slides = [];
            let currentSlideContent = [];
            blocks.forEach(block => {
                const isHeading = block.type === 'heading_1' || block.type === 'heading_2';
                if (isHeading && currentSlideContent.length > 0) {
                    slides.push(currentSlideContent);
                    currentSlideContent = [];
                }
                currentSlideContent.push(block);
            });
            if (currentSlideContent.length > 0) slides.push(currentSlideContent);
            return slides;
        }

        function rebuildSlidesAndRender() {
            state.slides = parseBlocksIntoSlides(state.rawBlocks);
            state.currentSlide = 0;
            renderCurrentSlide();
        }

        function renderCurrentSlide() {
            if (state.slides.length === 0) {
                slidesContainer.innerHTML = '<p>Nenhum conteúdo encontrado.</p>';
                return;
            }
            const slideData = state.slides[state.currentSlide];
            const slideWrapper = document.createElement('div');
            slideWrapper.className = 'slide-content w-full h-full teleprompter-body space-y-4 text-left';
            
            slideData.forEach(block => {
                const element = createHtmlFromBlock(block);
                if (element) slideWrapper.appendChild(element);
            });
            
            slidesContainer.innerHTML = '';
            slidesContainer.appendChild(slideWrapper);
            
            applySettings();
            updateControls();
            
            if (state.settings.displayMode === 'scroll') {
                calculateAndUpdateReadingTime();
            }
        }

        function createHtmlFromBlock(block) {
            const type = block.type;
            const content = block[type];
            if (!content || (type !== 'divider' && type !== 'image' && !content.rich_text)) return null;
            
            const processRichText = (richTextArray) => richTextArray.map(item => item.plain_text).join('');

            let element;
            switch(type) {
                case 'heading_1': element = document.createElement('h1'); element.className = 'text-4xl font-bold text-white'; element.textContent = processRichText(content.rich_text); break;
                case 'heading_2': element = document.createElement('h2'); element.className = 'text-3xl font-semibold text-gray-100 mt-8'; element.textContent = processRichText(content.rich_text); break;
                case 'heading_3': element = document.createElement('h3'); element.className = 'text-2xl font-medium text-gray-200 mt-6'; element.textContent = processRichText(content.rich_text); break;
                case 'paragraph': element = document.createElement('p'); element.innerHTML = processRichText(content.rich_text) || '&nbsp;'; break;
                case 'bulleted_list_item':
                case 'numbered_list_item': element = document.createElement('li'); element.className = 'ml-6'; element.textContent = `• ${processRichText(content.rich_text)}`; break;
                case 'image': element = document.createElement('img'); const url = content.type === 'external' ? content.external.url : content.file.url; element.src = url; element.className = 'max-w-full h-auto rounded-lg shadow-lg my-6'; break;
                case 'divider': element = document.createElement('hr'); element.className = 'my-8 border-gray-700'; break;
                case 'quote': element = document.createElement('blockquote'); element.className = 'pl-4 italic text-gray-400'; element.textContent = processRichText(content.rich_text); break;
                default: return null;
            }
            return element;
        }

        // --- CONTROLES E UI GERAL ---
        function updateControls() {
            const isScrollMode = state.settings.displayMode === 'scroll';
            presentationTitle.textContent = isScrollMode ? 'Modo de Leitura' : 'Modo de Apresentação';
            navigationControls.style.display = isScrollMode ? 'none' : 'flex';
            teleprompterFooter.style.display = isScrollMode ? 'block' : 'none';
            teleprompterControls.style.display = isScrollMode ? 'block' : 'none';

            if (!isScrollMode) {
                slideCounter.textContent = `Página ${state.currentSlide + 1} de ${state.slides.length}`;
                prevBtn.disabled = state.currentSlide === 0;
                nextBtn.disabled = state.currentSlide >= state.slides.length - 1;
            }
        }

        function showView(viewName) {
            [setupView, presentationView, loadingView].forEach(v => v.classList.add('hidden'));
            if (viewName === 'setup') { setupView.classList.remove('hidden'); stopTimers(); }
            else if (viewName === 'presentation') presentationView.classList.remove('hidden');
            else if (viewName === 'loading') loadingView.classList.remove('hidden');
        }

        function showError(message) { errorMessage.textContent = message; errorMessage.classList.remove('hidden'); }
        function goToNextSlide() { if (state.currentSlide < state.slides.length - 1) { state.currentSlide++; renderCurrentSlide(); } }
        function goToPrevSlide() { if (state.currentSlide > 0) { state.currentSlide--; renderCurrentSlide(); } }

        // --- TIMERS E TELEPROMPTER ---
        function formatTime(totalSeconds) {
            const mins = Math.floor(totalSeconds / 60);
            const secs = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
        function startOverallTimer() {
            if (state.overallTimerInterval) clearInterval(state.overallTimerInterval);
            state.overallSeconds = 0;
            state.overallTimerInterval = setInterval(() => { state.overallSeconds++; overallTimerEl.textContent = formatTime(state.overallSeconds); }, 1000);
        }
        function stopTimers() { clearInterval(state.overallTimerInterval); stopTeleprompter(); }

        function countWords(container) {
            return (container.innerText || '').trim().split(/\s+/).filter(Boolean).length;
        }
        function updateWPMDisplay() {
            wpmDisplay.textContent = `${state.settings.wpm} PPM`;
        }
        function calculateAndUpdateReadingTime() {
            state.totalWords = countWords(slidesContainer);
            state.totalReadingSeconds = (state.totalWords / state.settings.wpm) * 60;
            estimatedTimeEl.textContent = `Tempo de Leitura: ${formatTime(state.totalReadingSeconds)}`;
        }

        function startTeleprompter() {
            if (state.isTeleprompterPlaying) return;
            state.isTeleprompterPlaying = true;
            teleprompterPlayPauseBtn.textContent = 'Pausar Rolagem';
            state.lastFrameTime = null;
            state.animationFrameId = requestAnimationFrame(teleprompterLoop);
        }

        function stopTeleprompter() {
            if (!state.isTeleprompterPlaying) return;
            state.isTeleprompterPlaying = false;
            teleprompterPlayPauseBtn.textContent = 'Iniciar Rolagem';
            if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
        }

        function teleprompterLoop(timestamp) {
            if (!state.isTeleprompterPlaying) return;
            if (!state.lastFrameTime) state.lastFrameTime = timestamp;
            const deltaTime = (timestamp - state.lastFrameTime) / 1000;
            state.lastFrameTime = timestamp;
            const scrollableHeight = slidesContainer.scrollHeight - slidesContainer.clientHeight;
            if (scrollableHeight <= 0 || state.totalReadingSeconds <= 0) { stopTeleprompter(); return; }
            
            const scrollPerSecond = scrollableHeight / state.totalReadingSeconds;
            slidesContainer.scrollTop += scrollPerSecond * deltaTime;

            if (slidesContainer.scrollTop >= scrollableHeight) {
                slidesContainer.scrollTop = scrollableHeight;
                stopTeleprompter();
            } else {
                state.animationFrameId = requestAnimationFrame(teleprompterLoop);
            }
        }
        
        // --- EVENT LISTENERS ---
        generateBtn.addEventListener('click', fetchNotionContent);
        nextBtn.addEventListener('click', goToNextSlide);
        prevBtn.addEventListener('click', goToPrevSlide);
        homeBtn.addEventListener('click', () => showView('setup'));
        settingsToggleBtn.addEventListener('click', () => {
            state.isSettingsOpen = !state.isSettingsOpen;
            settingsPanel.classList.toggle('open');
        });
        settingsPanel.addEventListener('click', handleSettingChange);

        teleprompterPlayPauseBtn.addEventListener('click', () => state.isTeleprompterPlaying ? stopTeleprompter() : startTeleprompter());
        wpmIncreaseBtn.addEventListener('click', () => { state.settings.wpm += 10; saveSettings(); calculateAndUpdateReadingTime(); updateWPMDisplay(); });
        wpmDecreaseBtn.addEventListener('click', () => { if(state.settings.wpm > 20) { state.settings.wpm -= 10; saveSettings(); calculateAndUpdateReadingTime(); updateWPMDisplay(); }});
        
        document.addEventListener('keydown', e => {
            if (presentationView.classList.contains('hidden')) return;
            if (e.key === 'ArrowRight') goToNextSlide();
            if (e.key === 'ArrowLeft') goToPrevSlide();
            if (e.key === 'Escape') settingsPanel.classList.remove('open');
            if (e.key === ' ' && state.settings.displayMode === 'scroll') {
                e.preventDefault();
                teleprompterPlayPauseBtn.click();
            }
        });
        
        // --- INICIALIZAÇÃO ---
        function init() {
            loadSettings();
            updateSettingsUI();
            const urlParams = new URLSearchParams(window.location.search);
            const pageIdFromUrl = urlParams.get('pageId');
            if (pageIdFromUrl) { pageIdInput.value = pageIdFromUrl; generateBtn.click(); }
        }
        
        init();
    </script>
</body>
</html>